



<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Team Hub</title>
    <style>


:root {
  /* choose one primary font family */
  --font-main: 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;

  /* color & text smoothing (optional) */
  --text-color: #e6edf3;
}

/* global baseline */
body, button, input, select, textarea {
  font-family: var(--font-main);
  color: var(--text-color);
  font-size: 14px;
  letter-spacing: 0.2px;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* unify tab text */
.tab {
  font-family: var(--font-main);
  font-size: 14px;
  font-weight: 500;
  letter-spacing: 0.3px;
  text-transform: none;
  color: var(--text-color);
}

/* unify filter dropdowns and buttons */
.notes-filters select,
.notes-filters input,
button.apply,
button.clear {
  font-family: var(--font-main);
  font-size: 13px;
  color: var(--text-color);
}

















      :root {
        --bg:#0b0d10; --panel:#14181f; --muted:#79839a; --text:#e9edf6; --accent:#4aa8ff;
        --card:#1b2130; --chip:#232b3d; --border:#2a3448; --ok:#2ecc71; --warn:#ffb020; --bad:#ff5a5f;
        --chart-card-max:360px;
      }
html,body { margin:0; padding:0; background:var(--bg); color:var(--text); font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
.wrap { max-width:1200px; margin:0 auto; padding:24px; }
.wrap-narrow {
  display:none;
  width:100%;
  padding:16px;
  gap:16px;
  box-sizing:border-box;
}

.mobile-tabbar {
  display:none;
  position:sticky;
  bottom:0;
  left:0;
  right:0;
  grid-auto-flow:column;
  grid-auto-columns:1fr;
  gap:6px;
  padding:8px 12px;
  background:rgba(10,13,18,0.92);
  border-top:1px solid rgba(70,100,140,0.35);
  backdrop-filter:blur(12px);
  z-index:900;
}
.mobile-tabbar button {
  border:0;
  background:rgba(26,32,44,0.9);
  color:#cbd8f8;
  border-radius:12px;
  padding:8px 6px;
  font-size:12px;
  letter-spacing:0.3px;
  font-weight:600;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:2px;
}
.mobile-tabbar button span {
  font-size:11px;
  letter-spacing:0.2px;
}
.mobile-tabbar button.active {
  background:linear-gradient(135deg, rgba(74,168,255,0.9), rgba(134,77,255,0.9));
  color:#06142b;
  box-shadow:0 6px 16px rgba(74,168,255,0.35);
}

.panel-mobile-card {
  border:1px solid rgba(70,100,140,0.35);
  border-radius:16px;
  background:rgba(15,19,28,0.92);
  padding:16px;
  box-shadow:0 18px 40px rgba(0,0,0,0.45);
  display:flex;
  flex-direction:column;
  gap:12px;
}
.home-panel {
  display:flex;
  flex-direction:column;
  gap:18px;
}
.home-top {
  display:grid;
  gap:18px;
  grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));
  align-items:stretch;
}
.home-panel .card { margin:0; }
.home-chart-card #teamLine {
  width:100%;
  min-height:260px;
}
.home-flags-card .ratingsWrap {
  max-height:360px;
}
.stats-opp-card {
  display:flex;
  flex-direction:column;
  gap:12px;
}
.stats-opp-card select {
  width:100%;
}
.league-scatter-wrap {
  position:relative;
  height:230px;
}
.league-scatter-wrap canvas {
  position:absolute;
  inset:0;
  width:100% !important;
  height:100% !important;
}
.opp-chart-row {
  display:flex;
  flex-wrap:wrap;
  gap:16px;
  justify-content:center;
  align-items:stretch;
}
.opp-chart-row > * {
  flex:1 1 300px;
  max-width:420px;
}
.opp-chart-wrap,
.shot-chart-wrap,
.four-chart-wrap {
  margin:6px 0;
  width:100%;
  min-width:260px;
  max-width:420px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  position:relative;
  overflow:hidden;
}
.opp-chart-wrap canvas,
.shot-chart-wrap canvas,
.four-chart-wrap canvas {
  width:min(100%, 360px) !important;
  height:auto !important;
  max-height:340px;
  margin:0 auto;
}
.profile-tag-row {
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin:8px 0 12px;
}
.profile-tag {
  display:inline-flex;
  align-items:center;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.18);
  font-size:11px;
  letter-spacing:0.2px;
  background:rgba(74,168,255,0.14);
  color:#d5e5ff;
}
.profile-tag.featured {
  background:rgba(255,176,32,0.22);
  border-color:rgba(255,176,32,0.35);
  color:#ffe5b5;
}
.opp-insights-grid {
  display:grid;
  gap:12px;
  grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
}
.opp-insight {
  background:rgba(255,255,255,0.02);
  border:1px solid var(--border);
  border-radius:10px;
  padding:10px;
  font-size:13px;
}
.opp-insight ul {
  margin:4px 0 0;
  padding-left:18px;
}
.opp-insight li {
  margin-bottom:6px;
}
.opp-insight li:last-child {
  margin-bottom:0;
}
.opp-profile-table {
  width:100%;
  border-collapse:collapse;
  font-size:12.5px;
}
.opp-profile-table th,
.opp-profile-table td {
  padding:4px 6px;
  border-bottom:1px solid rgba(255,255,255,0.07);
  text-align:right;
}
.opp-profile-table th:first-child,
.opp-profile-table td:first-child {
  text-align:left;
}
.opp-profile-table tr:last-child td {
  border-bottom:none;
}
.diff-chip {
  display:inline-block;
  margin-left:6px;
  padding:2px 6px;
  border-radius:999px;
  font-size:10.5px;
  font-weight:600;
  letter-spacing:0.1px;
}
.diff-chip.pos {
  background:rgba(46,204,113,0.18);
  color:#45d17b;
}
.diff-chip.neg {
  background:rgba(255,90,95,0.20);
  color:#ff6f76;
}
.diff-chip.neutral {
  background:rgba(255,255,255,0.08);
  color:#cbd6ee;
}
  font-size:13px;
}
.opp-profile-table th,
.opp-profile-table td {
  padding:6px 4px;
  border-bottom:1px solid var(--border);
  text-align:right;
}
.opp-profile-table th:first-child,
.opp-profile-table td:first-child {
  text-align:left;
}
.diff-chip {
  display:inline-block;
  margin-left:6px;
  padding:2px 6px;
  border-radius:999px;
  font-size:11px;
  font-weight:600;
  letter-spacing:0.1px;
}
.diff-chip.pos {
  background:rgba(46,204,113,0.18);
  color:#45d17b;
}
.diff-chip.neg {
  background:rgba(255,90,95,0.18);
  color:#ff6f76;
}
.diff-chip.neutral {
  background:rgba(255,255,255,0.08);
  color:#cbd6ee;
}
.summary-card-header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.summary-card-header h2 {
  margin:0;
  font-size:16px;
  letter-spacing:0.3px;
}
.home-session-summary {
  display:flex;
  flex-direction:column;
  gap:16px;
}
.home-session-meta {
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  justify-content:space-between;
  align-items:flex-start;
}
.home-session-title {
  font-size:18px;
  font-weight:600;
  letter-spacing:0.3px;
  color:var(--text,#e6edf3);
}
.home-session-sub {
  font-size:13px;
  color:var(--muted,#8a96b3);
}
.home-session-stats {
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));
  gap:12px;
}
.home-session-stat {
  padding:12px 14px;
  border-radius:14px;
  background:var(--chip,#232b3d);
  border:1px solid rgba(255,255,255,0.07);
  display:flex;
  flex-direction:column;
  gap:6px;
}
.home-session-stat .label {
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:0.5px;
  color:var(--muted,#8a96b3);
}
.home-session-stat .value {
  font-size:20px;
  font-weight:600;
  color:var(--text,#e6edf3);
}
.home-session-stat .delta {
  font-size:12px;
}
.home-session-coach-table {
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.07);
  background:rgba(15,20,30,0.65);
  padding:12px 14px;
  overflow:auto;
}
.home-session-coach-table table {
  width:100%;
  border-collapse:collapse;
}
.home-session-coach-table th,
.home-session-coach-table td {
  text-align:left;
  padding:8px 10px;
  border-bottom:1px solid rgba(255,255,255,0.06);
  font-size:13px;
  color:var(--text,#e6edf3);
}
.home-session-coach-table th {
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:0.4px;
  color:var(--muted,#8a96b3);
}
.home-session-coach-table tr:last-child td { border-bottom:none; }
.home-session-notes {
  border-radius:14px;
  border:1px solid rgba(74,168,255,0.25);
  background:rgba(74,168,255,0.05);
  padding:12px 14px;
}
.home-session-notes h3 {
  margin:0 0 8px;
  font-size:14px;
  letter-spacing:0.4px;
}
.home-session-notes-list {
  list-style:none;
  padding:0;
  margin:0;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.home-session-notes-list li {
  border-radius:10px;
  border:1px solid rgba(74,168,255,0.4);
  background:rgba(15,25,36,0.75);
  padding:10px 12px;
}
.home-session-notes-list strong {
  display:block;
  font-size:13px;
  color:var(--text,#e6edf3);
}
.home-session-notes-list .note-meta {
  font-size:11px;
  color:var(--muted,#8a96b3);
  margin-top:4px;
}
.home-session-player-list {
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.07);
  background:rgba(13,18,28,0.7);
  padding:12px 14px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.home-session-player-list h3 {
  margin:0;
  font-size:14px;
  letter-spacing:0.3px;
}
.home-session-player-list ul {
  list-style:none;
  margin:8px 0 0;
  padding:0;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.home-session-player-list li {
  border:1px solid rgba(74,168,255,0.25);
  border-radius:12px;
  background:rgba(15,24,36,0.75);
  padding:10px 12px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.home-session-player-list .top-row {
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:8px;
}
.home-session-player-list .player-name {
  font-size:14px;
  font-weight:600;
  color:var(--text,#e6edf3);
}
.home-session-player-list .player-avg {
  font-size:18px;
  font-weight:600;
  color:var(--text,#e6edf3);
}
.home-session-player-list .player-coaches {
  font-size:11px;
  color:var(--muted,#8a96b3);
  text-transform:uppercase;
  letter-spacing:0.4px;
}
.home-session-player-list .player-note {
  font-size:12px;
  color:var(--text,#e6edf3);
  line-height:1.4;
}
.home-session-player-list .player-note .note-meta {
  font-size:11px;
  color:var(--muted,#8a96b3);
  margin-top:2px;
}
.home-session-player-list .player-note .note-text {
  margin-top:4px;
}
.home-session-empty {
  font-size:13px;
  color:var(--muted,#8a96b3);
}
.gamestats-controls {
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  align-items:center;
  margin-bottom:16px;
}
.gamestats-controls select,
.gamestats-controls button {
  min-height:32px;
  border-radius:8px;
  border:1px solid rgba(86,105,132,0.6);
  background:rgba(17,23,33,0.9);
  color:var(--text,#e6edf3);
  padding:6px 10px;
  font-size:13px;
}
.gamestats-controls button {
  background:var(--accent,#4aa8ff);
  border:none;
  color:#06142b;
  font-weight:600;
  cursor:pointer;
  transition:opacity 0.2s ease;
}
.gamestats-controls button:disabled {
  opacity:0.6;
  cursor:default;
}
.gamestats-summary {
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
  gap:16px;
  margin-bottom:18px;
}
.gs-card {
  border:1px solid rgba(70,100,140,0.35);
  border-radius:14px;
  background:rgba(15,19,28,0.92);
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.gs-meta {
  font-size:13px;
  color:var(--muted,#79839a);
  display:flex;
  flex-direction:column;
  gap:4px;
}
.gs-meta strong {
  color:var(--text,#e6edf3);
  font-size:15px;
}
.gs-metric-list {
  list-style:none;
  padding:0;
  margin:0;
  display:flex;
  flex-direction:column;
  gap:6px;
  font-size:13px;
  color:var(--text,#e6edf3);
}
.gs-metric-list li {
  display:flex;
  justify-content:space-between;
  gap:8px;
}
.gs-metric-list li span {
  color:var(--muted,#79839a);
}
.table-wrap {
  overflow:auto;
  border:1px solid rgba(70,100,140,0.25);
  border-radius:12px;
  background:rgba(12,18,28,0.85);
}
.table-wrap table {
  width:100%;
  border-collapse:collapse;
  min-width:680px;
}
.table-wrap thead {
  background:rgba(26,32,44,0.8);
}
.table-wrap th,
.table-wrap td {
  padding:10px 12px;
  font-size:13px;
  text-align:left;
  border-bottom:1px solid rgba(70,100,140,0.25);
}
.table-wrap tbody tr:last-child td {
  border-bottom:none;
}
.table-wrap tbody tr:nth-child(even) {
  background:rgba(28,36,48,0.4);
}
.gamestats-charts {
  display:flex;
  flex-direction:column;
  gap:16px;
  width:100%;
}
.gamestats-section {
  width:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
  gap:10px;
  padding:16px;
  border-radius:12px;
  background:rgba(20,24,31,0.92);
  border:1px solid rgba(70,100,140,0.35);
  position:relative;
  overflow:hidden;
}
.gamestats-section.chart-span {
  justify-content:center;
}
.gamestats-section canvas {
  display:block;
  margin:0 auto;
}
.gamestats-section.chart-duo canvas {
  width:min(100%, 340px) !important;
  max-width:340px;
}
.gamestats-canvas-wrap {
  position:relative;
  width:100%;
  height:230px;
  overflow:hidden;
}
.gamestats-canvas-wrap canvas {
  position:absolute;
  inset:0;
  width:100% !important;
  height:100% !important;
}
.gs-chart-square {
  max-width:var(--chart-card-max);
  aspect-ratio:1 / 1;
  width:100%;
}

@media (min-width: 640px) {
  .gamestats-charts {
    display:grid;
    grid-template-columns:repeat(2, minmax(0, 1fr));
    gap:24px;
  }
  .gamestats-section.chart-span {
    grid-column:1 / -1;
    align-items:stretch;
  }
  .gamestats-canvas-wrap {
    height:230px;
  }
  .gamestats-section.chart-span .gs-chart-square {
    max-width:100%;
  }
  .gamestats-section.chart-duo canvas {
    width:min(100%, 420px) !important;
    max-width:420px;
  }
  .gamestats-section.chart-duo .gs-chart-square {
    max-width:420px;
  }
}
.home-session-list {
  list-style:none;
  padding:0;
  margin:8px 0 0;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.home-session-list li {
  border-bottom:1px solid rgba(255,255,255,0.06);
  padding-bottom:6px;
}
.home-session-list li:last-child { border-bottom:none; }
.upcoming-list {
  display:flex;
  flex-direction:column;
  gap:10px;
}
.upcoming-item {
  border:1px solid rgba(74,168,255,0.35);
  background:rgba(74,168,255,0.1);
  border-radius:12px;
  padding:10px;
}

#mobileNavOverlay {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.45);
  z-index:90;
}
body.mobile-nav-open #mobileNavOverlay { display:block; }
@media (min-width: 961px){
  #mobileNavOverlay { display:none !important; }
}

@media (max-width: 960px) {
  body { padding-bottom:72px; }
  #sideNav {
    width:240px;
    transform:translateX(-110%);
    pointer-events:none;
    box-shadow:0 18px 40px rgba(0,0,0,0.45);
    transition:transform .25s ease;
    opacity:0;
  }
  body.mobile-nav-open #sideNav {
    transform:translateX(0);
    pointer-events:auto;
    opacity:1;
  }
  body.mobile-nav-open { overflow:hidden; }
  body.sidebar-enabled .panel,
  body.sidebar-enabled .tabs {
    margin-left:0 !important;
  }
  .panel {
    border-radius:18px;
    padding:16px;
    margin:16px 12px;
    box-shadow:0 16px 32px rgba(0,0,0,0.35);
  }
  .panel:first-of-type { margin-top:18px; }
  .card {
    border-radius:16px;
    padding:14px;
  }
  .ratingsWrap,
  .table-wrap,
  #clipModalFooter {
    overflow:auto;
    -webkit-overflow-scrolling:touch;
  }
  table { min-width:600px; }
  #rtTable { min-width:100%; }
  #teamBox {
    grid-template-columns:1fr !important;
  }
  .grid.g2,
  .grid.g3 {
    grid-template-columns:1fr !important;
  }
  .mobile-tabbar {
    display:grid;
  }
}

@media (max-width: 640px) {
  .panel {
    padding:14px;
    margin:14px 10px;
  }
  .card { padding:12px; }
  h1 { font-size:20px; }
  h2 { font-size:16px; }
  .grid { gap:12px; }
  .chat-thread { height:46vh; }
}

@media (max-width: 500px) {
  .mobile-tabbar button { padding:10px 6px; font-size:16px; }
  .mobile-tabbar button span { display:none; }
}
.wrap-fluid { width:100%; }

/* Tabs */
.tabs { display:flex; gap:8px; margin-bottom:16px; border-bottom:1px solid var(--border); }
.tab { padding:10px 14px; cursor:pointer; border:1px solid var(--border); border-bottom:none; background:var(--panel); color:var(--muted); border-top-left-radius:10px; border-top-right-radius:10px; transition:background .2s ease; }
.tab.active { background:var(--card); color:var(--text); font-weight:600; }
.panel { display:none; background:var(--card); border:1px solid var(--border); border-radius:12px; padding:18px; }
.panel.active { display:block; }

      /* Layout */
      .grid { display:grid; gap:16px; }
      .g2 { grid-template-columns: minmax(0, 320px) minmax(0, 1fr); }
      .grid > * { min-width: 0; }
      .card { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:14px; }

      h1 { font-size:20px; margin:0 0 6px; }
      h2 { font-size:16px; margin:16px 0 8px; }
      .muted { color:var(--muted); }
      .tag { display:inline-block; padding:4px 8px; background:var(--chip); border:1px solid var(--border); border-radius:999px; margin:2px 4px 2px 0; font-size:12px; color:#cbd6ee; }
      .sectionTitle { font-weight:700; margin:16px 0 6px; }

      /* Player sidebar */
      .avatar { width:160px; height:160px; border-radius:12px; object-fit:cover; display:none; box-shadow:0 2px 10px rgba(0,0,0,.35); border:1px solid var(--border); }
      .select { width:100%; padding:10px; border-radius:10px; background:#0f131a; color:var(--text); border:1px solid var(--border); }
      .kv { display:grid; grid-template-columns: 120px 1fr; gap:8px 12px; margin-top:10px; }
      .kv div:nth-child(odd){ color:#b8c4dd; }
      ul { margin:6px 0 0 18px; padding:0; }
      li { margin:4px 0; }

      #flagsTable td.num { font-size: 15px; }
      .card { max-width: 100%; overflow: hidden; }
      #panel-players .card, #panel-players ul, #panel-players li { word-break: break-word; overflow-wrap: anywhere; }

      .embedWrap{
        position:relative;
        width:100%;
        aspect-ratio:16/9;
        background:#0f131a;
        border:1px solid var(--border);
        border-radius:10px;
        overflow:hidden;
      }
      .embedWrap iframe{
        position:absolute;
        inset:0;
        width:100%;
        height:100%;
        border:0;
      }

      #flagsTable th { text-align: center; }

      /* Clip list */
      .clip { border-bottom:1px dashed var(--border); padding:8px 0; }
      .clip:last-child { border-bottom:none; }
      .clip a { color:var(--accent); text-decoration:none; }
      .clip a:hover { text-decoration:underline; }
      .clipLine { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

      /* Filters row */
      .filters { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:12px; }
      .filters select, .filters input { padding:8px 10px; border-radius:10px; background:#0f131a; color:var(--text); border:1px solid var(--border); }
      .btn { padding:9px 12px; border-radius:10px; background:var(--accent); color:#051423; border:0; cursor:pointer; font-weight:700; }
      .btn:disabled { opacity:.5; cursor:not-allowed; }

      /* Small progress bars (monospace) */
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

      /* Empty states */
      .empty { color:#9aa6bf; background:#10141c; border:1px dashed var(--border); border-radius:10px; padding:16px; }

      /* Ratings table */
      table { width:100%; border-collapse: collapse; }
      th, td { padding:8px; border-bottom:1px solid var(--border); text-align:left; }
      th { position:sticky; top:0; background:var(--panel); z-index:1; }
      .num { text-align:center; font-variant-numeric: tabular-nums; }
      .stickyLeft { position:sticky; left:0; background:var(--panel); z-index:2; }
      .ratingsWrap {
  max-height: 70vh;            /* add this for vertical freeze */
  overflow: auto;
  border: 1px solid var(--border);
  border-radius: 12px;
}

      .hero { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height: 50vh; gap: 16px; }
      .hero-logo { width: 160px; height:160px; object-fit:cover; border-radius:16px; border:1px solid var(--border); box-shadow:0 4px 20px rgba(0,0,0,.35); }
      .hero-title { margin:0; font-size:28px; letter-spacing:.5px; }

      .btn-danger {
        padding: 9px 12px;
        border-radius: 10px;
        background: #ff5a5f;
        color: white;
        border: 0;
        cursor: pointer;
        font-weight: 700;
      }
      .btn-danger:disabled { opacity: .5; cursor: not-allowed; }

      #createSummaryModal .grid label { display: flex; flex-direction: column; gap: 6px; width: 100%; }
      #createSummaryModal .grid input, #createSummaryModal .grid select, #createSummaryModal .grid textarea {
        max-width: 100%; box-sizing: border-box;
      }
      #createSummaryModal select { height: 38px; line-height: 1.3; font-size: 14px; }
      #createSummaryModal #sumDescription { grid-column: 1 / span 2; }



  .stat-bullet { display:flex; align-items:center; gap:10px; margin:6px 0; }
  .stat-label  { width:90px; color:var(--muted,#9aa4ad); }
  .stat-track  { position:relative; height:10px; width:260px; border-radius:999px; overflow:hidden; }
  .stat-dot    { position:absolute; top:50%; width:12px; height:12px; border-radius:50%;
                 transform:translate(-50%,-50%); border:1px solid rgba(0,0,0,.25); background:#fff; }
  .stat-tick   { position:absolute; top:50%; width:2px; height:14px; transform:translate(-50%,-50%);
                 background:rgba(255,255,255,.85); border-radius:2px; }
  .stat-meta   { display:flex; gap:10px; margin-left:auto; min-width:160px; justify-content:flex-end; }
  .chip        { padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border,#283241); }


/* Colored result text */
.result-win  { color: var(--ok, #2ecc71); font-weight: 600; }
.result-loss { color: var(--bad, #ff5a5f); font-weight: 600; }
.result-upcoming { color: var(--muted, #79839a); font-style: italic; }

/* Schedule pills */
.sched-pill{
  display:inline-block;
  vertical-align:top;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:10px;
  padding:8px 10px;
  margin-right:8px;
  min-width: 210px;
  max-width: 260px;
  white-space:normal;
  cursor:pointer;
  transition:transform .08s ease, box-shadow .12s ease;
}
.sched-pill:hover{ transform:translateY(-1px); box-shadow:0 2px 10px rgba(0,0,0,.25); }
.sched-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; font-size:12px; color:var(--muted); }
.sched-title{ font-weight:700; margin-top:4px; }
.sched-venue{ font-size:11px; color:var(--muted); }
.sched-badges{ display:flex; gap:6px; margin-top:6px; align-items:center; }
.sched-chip{ font-size:11px; padding:2px 6px; border:1px solid var(--border); border-radius:999px; }
.sched-pppbar{ position:relative; height:4px; border-radius:999px; background:#0f131a; margin-top:8px; overflow:hidden; }
.sched-pppbar > div{ position:absolute; top:0; bottom:0; }
.sched-pill.win { border-color: rgba(46,204,113,.45); }
.sched-pill.loss{ border-color: rgba(255,90,95,.45); }
.sched-pill.next{ outline:2px solid rgba(74,168,255,.45); }

.sched-chip.home { border-color:rgba(74,168,255,.4); }
.sched-chip.away { border-color:rgba(255,176,32,.4); }
.sched-chip.heba { border-color:#4aa8ff44; }
.sched-chip.fiba { border-color:#10b98155; }

/* Detail drawer */
#schedDetail .grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
@media (max-width:640px){ #schedDetail .grid{ grid-template-columns:1fr; } }








/* Presence floating widget */
.presence-widget {
  position: fixed;
  top: 16px;
  right: 16px;
  z-index: 10050;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,.35);
  overflow: hidden;
  min-width: 220px;
  max-width: 260px;
  font-size: 13px;
}
.presence-widget header{
  display:flex; align-items:center; justify-content:space-between;
  padding:8px 10px;
  border-bottom:1px solid var(--border);
}
.presence-badge{
  display:inline-block; padding:3px 8px;
  border-radius:999px; font-weight:600;
  background:#ff5a5f; color:white; margin:2px 4px 2px 0;
}
.presence-list{ padding:8px 10px; max-height: 200px; overflow:auto; }
.presence-empty{ color:#9aa6bf; }
.presence-btn{
  background:transparent; border:0; color:var(--muted); cursor:pointer; font-weight:700;
}


/* Coach notification toast – bottom-right, compact */
#coachNotify {
  position: fixed;
  bottom: 16px;
  right: 16px;

  /* IMPORTANT: prevent stretching */
  top: auto !important;
  left: auto !important;
  width: auto !important;
  max-width: 360px;

  z-index: 10020;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,.35);
  padding: 10px 12px;
  display: none;           /* set to block when showing */
}


/* Insights container → responsive grid */
.pl-insights {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* 2–4 per row depending on width */
  gap: 8px;
  margin-top: 6px;
  align-items: stretch;
}

/* Insight cards */
.insight {
  background: #fff;
  border: 1px solid #e5e7eb;
  border-left: 4px solid #60a5fa; /* default = info */
  border-radius: 10px;
  padding: 8px 10px;
  box-shadow: 0 1px 2px rgba(0,0,0,.05);
  box-sizing: border-box;
}

.insight-title {
  font-weight: 600;
  margin-bottom: 4px;
  color: #111827;
  font-size: 13px;
}

.insight-body {
  font-size: 13px;
  line-height: 1.35;
  color: #374151;
}

/* Kinds (match your JS: success|info|warn|error) */
.insight.success { border-left-color: #10b981; } /* green */
.insight.info    { border-left-color: #3b82f6; } /* blue */
.insight.warn    { border-left-color: #f59e0b; } /* amber */
.insight.error   { border-left-color: #ef4444; } /* red */

/* Optional: compact on very small screens */
@media (max-width: 420px) {
  .pl-insights { grid-template-columns: 1fr; }
}


/* ===== Mobile tweaks ===== */
@media (max-width: 820px) {
  .wrap { padding: 16px; }

  /* Tabs: make them scrollable chips across the top */
  .tabs {
    gap: 6px;
    overflow-x: auto;
    white-space: nowrap;
    padding: 0 8px 8px;
    scrollbar-width: none;
  }
  .tabs::-webkit-scrollbar { display: none; }
  .tab {
    padding: 8px 12px;
    font-size: 13px;
    border-radius: 999px;
  }

  /* Panels and cards tighter on mobile */
  .panel { padding: 12px; }
  .card  { padding: 12px; }

  /* Two-column → one column */
  .g2 { grid-template-columns: 1fr; }

  /* Player photo smaller */
  .avatar { width: 120px; height: 120px; }

  /* Ratings tables: allow horizontal scroll */
  .ratingsWrap { overflow: auto; }
  table { min-width: 680px; } /* keep columns usable; scroll on small */

  /* Filters: stack vertically */
  .filters {
    gap: 6px;
    flex-direction: column;
    align-items: stretch;
  }
  .filters select, .filters input, .filters .btn, .filters .btn-danger {
    width: 100%;
  }

  /* Embed/video: full width & sane height */
  .embedWrap { aspect-ratio: 16/9; }

  /* Presence widget: collapse on small screens */
  .presence-widget { right: 8px; top: 8px; max-width: 220px; }
  @media (max-width: 480px) {
    .presence-widget { display: none; } /* hide if it crowds UI */
  }

  /* Coach notify toast: fit width, respect safe areas */
  #coachNotify {
    right: max(12px, env(safe-area-inset-right));
    left: max(12px, env(safe-area-inset-left));
    bottom: max(12px, env(safe-area-inset-bottom));
    max-width: none;
    width: auto;
  }

  /* Login overlay box: fill nicely on phones */
  #loginOverlay > div { max-width: 360px; width: 92%; }
}

/* Bigger tap targets (nice on touch) */
button, .btn, .btn-danger, .presence-btn {
  min-height: 38px;
}

/* Prevent accidental zoom on iOS when tapping inputs */
input, select, textarea { font-size: 16px; }



body.player-only .tabs { display: none; }
body.player-only #panel-opponents { display: block; }
body.player-only #presenceWidget,
body.player-only #coachNotify { display: none !important; }


/* Player mode: make Opponents layout tight and centered */
body.player-only .tabs { display: none; }
body.player-only #panel-opponents { display: block; }
body.player-only .wrap { max-width: 900px; }


/* Freeze header row */
#ratingsTable thead th {
  position: sticky;
  top: 0;
  background: var(--panel);
  z-index: 5;          /* above body cells */
}

/* Freeze first column (you already add .stickyLeft in JS) */
#ratingsTable td.stickyLeft {
  position: sticky;
  left: 0;
  background: var(--panel);
  z-index: 4;          /* below header-left cell, above normal cells */
}

/* Top-left corner cell (header + first column) */
#ratingsTable th.stickyLeft {
  left: 0;
  z-index: 6;          /* highest so it sits on top */
}



/* --- Stats table visual cleanup --- */
#statsPlayersTable {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed; /* key for equal cell width */
  font-size: 13px;
}

#statsPlayersTable th,
#statsPlayersTable td {
  padding: 6px 4px;
  text-align: center; /* center all text */
  border-bottom: 1px solid var(--border, #ddd);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Left-align the player name only */
#statsPlayersTable th:first-child,
#statsPlayersTable td:first-child {
  text-align: left;
}

/* Slight background banding */
#statsPlayersTable tr:nth-child(even) {
  background: rgba(0, 0, 0, 0.02);
}

/* Smooth hover highlight */
#statsPlayersTable tr:hover {
  background: rgba(0, 128, 255, 0.08);
  transition: background 0.15s ease;
}

/* Make numeric columns all equal width */
#statsPlayersTable th:not(:first-child),
#statsPlayersTable td:not(:first-child) {
  width: 5.3%; /* tweak this to balance columns on your layout */
}






#alignTable {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}

#alignTable th, #alignTable td {
  padding: 8px 10px;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
  vertical-align: middle;
}

#alignTable th {
  color: var(--text-muted);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

#alignTable th.left,
#alignTable td.trait {
  text-align: left;
  font-weight: 500;
  color: var(--text);
}

#alignTable th.right,
#alignTable td.num {
  text-align: right;
  font-variant-numeric: tabular-nums;
  color: var(--text);
}

#alignTable td.diff {
  font-weight: 600;
}

#alignTable tr:last-child td {
  border-bottom: none;
}


/* Tiny button style (home header) */
.btn.btn-small { height:28px; padding:0 10px; font-size:12px; border-radius:8px; }

/* Modal shell */
.modal {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.55);
  display: none; align-items: center; justify-content: center;
  z-index: 1000;
}
.modal-card {
  width: min(1000px, 96vw);
  max-height: 88vh;
  overflow: hidden;
  background: var(--bg, #14181f);
  border: 1px solid var(--border, #2a3441);
  border-radius: 14px;
  box-shadow: 0 20px 60px rgba(0,0,0,.6);
  display: flex; flex-direction: column;
}
.modal-card > header {
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 12px; border-bottom:1px solid var(--border);
  font-weight:600;
}
.modal-card > header .icon {
  background: transparent; border: 1px solid var(--border);
  color: var(--text,#e6e6e6); border-radius:10px; padding:4px 8px; cursor:pointer;
}
.modal-body { padding:10px; overflow:auto; }

/* Form strip */
.rate-form {
  display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap: wrap;
}
.rate-form label { display:flex; flex-direction:column; gap:6px; min-width:180px; }
.rate-form label > span { font-size:12px; color: var(--muted,#9aa7b4); }
.rate-form select, .rate-form input[type="date"] {
  height:34px; border-radius:10px; border:1px solid var(--border);
  background: var(--bg2,#161b22); color: var(--text,#e6e6e6); padding:0 10px; font-size:13px;
}
.rate-form .apply { margin-left:auto; }
.rate-form .grow { flex:1 1 auto; }

/* Quick fill */
.rate-quickfill { display:flex; gap:8px; align-items:center; margin:6px 0 10px; }
.rate-quickfill select, .rate-quickfill .btn {
  height:32px; border-radius:10px; border:1px solid var(--border);
  background: var(--bg2,#161b22); color: var(--text,#e6e6e6); padding:0 10px; font-size:13px;
}

/* Ratings table */
.rate-table {
  border:1px solid var(--border);
  border-radius:14px;
  background:linear-gradient(145deg, rgba(27,33,44,.96), rgba(17,21,28,.94));
  box-shadow:0 12px 40px rgba(0,0,0,.45);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
.rate-table-scroll {
  max-height:55vh;
  overflow:auto;
  position:relative;
}
.rate-table-scroll::-webkit-scrollbar { width:11px; }
.rate-table-scroll::-webkit-scrollbar-track { background:rgba(12,16,22,.6); }
.rate-table-scroll::-webkit-scrollbar-thumb {
  background:rgba(70,104,160,.55);
  border-radius:999px;
}
.rate-table-scroll::-webkit-scrollbar-thumb:hover { background:rgba(90,130,190,.65); }
.rate-table-hint {
  padding:10px 14px;
  border-bottom:1px solid rgba(255,255,255,0.07);
  font-size:12px;
  color:var(--muted,#97a4c0);
  display:flex;
  gap:10px;
  align-items:center;
}
.rate-table-hint svg {
  width:16px; height:16px; flex-shrink:0; fill:var(--muted,#97a4c0);
}
#rtTable {
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  table-layout:fixed;
}
#rtTable thead th,
#rtTable tbody td,
#rtTable tbody th {
  padding:12px 14px;
  border-bottom:1px solid rgba(255,255,255,0.06);
  vertical-align:top;
}
#rtTable thead th {
  position:sticky;
  top:0;
  background:rgba(20,25,34,.97);
  backdrop-filter:blur(6px);
  z-index:4;
  text-transform:uppercase;
  letter-spacing:0.4px;
  font-size:12px;
  font-weight:600;
  color:#cdd8f8;
}
#rtTable thead th[data-tip] {
  cursor:help;
}
#rtTable thead th::after {
  content:'';
  position:absolute;
  left:0;
  right:0;
  bottom:0;
  height:1px;
  background:rgba(0,0,0,0.35);
}
#rtTable thead th.player-col {
  left:0;
  z-index:6;
  min-width:200px;
  box-shadow:inset -1px 0 0 rgba(255,255,255,0.06);
}
#rtTable tbody th.rt-player {
  position:sticky;
  left:0;
  z-index:5;
  background:rgba(20,25,34,.95);
  font-weight:600;
  color:var(--text);
  text-align:left;
  min-width:190px;
  box-shadow:inset -1px 0 0 rgba(255,255,255,0.04);
  font-size:13px;
}
#rtTable tbody tr:nth-child(even) { background:rgba(255,255,255,0.025); }
#rtTable tbody tr:hover { background:rgba(74,168,255,0.08); }
#rtTable tbody tr:last-child td,
#rtTable tbody tr:last-child th { border-bottom:none; }
#rtTable tbody tr.rt-empty td {
  padding:32px 0;
  text-align:center;
  font-size:13px;
  color:var(--muted,#97a4c0);
}
.rt-player-name {
  display:flex;
  align-items:center;
  gap:6px;
  line-height:1.4;
}
.rt-score {
  text-align:center;
  width:82px;
}
.rt-note-cell {
  min-width:360px;
  width:100%;
}
#rtTable select {
  height:34px;
  min-width:60px;
  border-radius:8px;
  border:1px solid rgba(86,105,132,.6);
  background:rgba(17,23,33,.9);
  color:var(--text,#e6e6e6);
  padding:0 10px;
  font-size:13px;
  appearance:none;
  transition:border-color .2s ease, box-shadow .2s ease;
  background-image: linear-gradient(45deg, transparent 50%, #4aa8ff 50%), linear-gradient(135deg, #4aa8ff 50%, transparent 50%);
  background-position: calc(100% - 16px) calc(50% - 4px), calc(100% - 10px) calc(50% - 4px);
  background-size:6px 6px, 6px 6px;
  background-repeat:no-repeat;
}
#rtTable select:focus {
  outline:none;
  border-color:var(--accent,#4aa8ff);
  box-shadow:0 0 0 2px rgba(74,168,255,0.25);
  background-color:rgba(19,26,36,.95);
}
#rtTable textarea {
  width:100%;
  min-height:72px;
  resize:vertical;
  border-radius:10px;
  border:1px solid rgba(86,105,132,.55);
  background:rgba(18,24,33,.92);
  color:var(--text,#e6e6e6);
  padding:8px 10px;
  font-size:13px;
  transition:border-color .2s ease, box-shadow .2s ease;
}
#rtTable textarea::placeholder {
  color:rgba(197,210,234,0.55);
}
#rtTable textarea:focus {
  outline:none;
  border-color:var(--accent,#4aa8ff);
  box-shadow:0 0 0 2px rgba(74,168,255,0.22);
  background:rgba(20,27,38,.96);
}
.trait-tooltip {
  position:fixed;
  max-width:260px;
  background:rgba(23,32,48,0.95);
  color:#eef3ff;
  padding:10px 12px;
  border-radius:10px;
  font-size:12px;
  line-height:1.5;
  box-shadow:0 14px 36px rgba(0,0,0,0.5);
  pointer-events:none;
  opacity:0;
  transform:translate(-50%, -4px) scale(0.96);
  transition:opacity 120ms ease, transform 120ms ease;
  z-index:9999;
}
.trait-tooltip.is-visible {
  opacity:1;
  transform:translate(-50%, -12px) scale(1);
}
.rate-message {
  margin-top:10px;
  font-size:13px;
  min-height:18px;
}

@media (max-width: 720px) {
  .rate-table-scroll { max-height:60vh; }
  #rtTable thead th,
  #rtTable tbody td,
  #rtTable tbody th { padding:10px 12px; }
  #rtTable select { min-width:52px; font-size:12px; }
  #rtTable textarea { font-size:12px; }
}

/* Coach chat */
.chat-shell {
  max-width: 860px;
  margin: 0 auto;
  background: linear-gradient(140deg, rgba(20,24,32,0.92), rgba(12,16,24,0.92));
  border-radius: 18px;
  border: 1px solid rgba(78,106,150,0.35);
  box-shadow: 0 18px 45px rgba(0,0,0,0.55);
  padding: 18px 20px 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}
.chat-header {
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:14px;
}
.chat-header h2 {
  margin:0;
  font-size:20px;
  letter-spacing:0.6px;
}
.chat-header p {
  margin:4px 0 0;
  color:var(--muted,#99a7c7);
  font-size:13px;
}
.chat-refresh {
  border:1px solid rgba(74,168,255,0.5);
  background:rgba(74,168,255,0.12);
  color:#a7cfff;
  border-radius:10px;
  padding:6px 12px;
  font-weight:600;
  cursor:pointer;
  transition:background .2s ease, transform .1s ease;
}
.chat-refresh:hover {
  background:rgba(74,168,255,0.2);
  transform:translateY(-1px);
}
.chat-controls {
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  align-items:center;
}
.chat-control-group {
  display:flex;
  flex-direction:column;
  gap:4px;
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:0.4px;
  color:var(--muted,#97a4c0);
}
.chat-label {
  font-size:11px;
  letter-spacing:0.4px;
}
.chat-target-select {
  min-width:220px;
  height:38px;
  border-radius:10px;
  border:1px solid rgba(86,105,132,0.6);
  background:rgba(15,19,28,0.95);
  color:var(--text,#e6e6e6);
  padding:0 12px;
  font-size:13px;
  appearance:auto;
  -webkit-appearance:menulist;
  transition:border-color .2s ease, box-shadow .2s ease;
  cursor:pointer;
}
.chat-target-select:focus {
  outline:none;
  border-color:var(--accent,#4aa8ff);
  box-shadow:0 0 0 2px rgba(74,168,255,0.25);
  background:rgba(19,24,34,0.98);
}
.chat-thread {
  height:48vh;
  overflow:auto;
  border-radius:14px;
  padding:18px 18px 14px;
  background:rgba(9,12,20,0.78);
  border:1px solid rgba(60,84,120,0.35);
  display:flex;
  flex-direction:column;
  gap:14px;
  scroll-behavior:smooth;
}
.chat-thread::-webkit-scrollbar { width:12px; }
.chat-thread::-webkit-scrollbar-track { background:rgba(8,11,18,0.85); }
.chat-thread::-webkit-scrollbar-thumb {
  background:rgba(94,128,190,0.55);
  border-radius:999px;
}
.chat-thread::-webkit-scrollbar-thumb:hover {
  background:rgba(118,152,212,0.65);
}
.chat-empty {
  text-align:center;
  color:var(--muted,#96a3c8);
  font-size:13px;
  padding:40px 0;
}
.chat-divider {
  text-align:center;
  font-size:11px;
  color:rgba(177,193,223,0.6);
  letter-spacing:0.4px;
  text-transform:uppercase;
  display:flex;
  align-items:center;
  gap:10px;
}
.chat-divider::before,
.chat-divider::after {
  content:'';
  flex:1;
  height:1px;
  background:rgba(120,140,176,0.25);
}
.chat-row {
  display:flex;
  flex-direction:column;
  gap:6px;
  align-items:flex-start;
}
.chat-row.mine {
  align-items:flex-end;
}
.chat-meta {
  font-size:11px;
  color:rgba(166,183,217,0.7);
}
.chat-bubble {
  max-width:80%;
  padding:12px 14px;
  border-radius:12px;
  background:rgba(24,31,45,0.95);
  border:1px solid rgba(78,106,150,0.35);
  line-height:1.45;
  font-size:13px;
  box-shadow:0 10px 26px rgba(0,0,0,0.35);
  word-break:break-word;
}
.chat-row.mine .chat-bubble {
  background:linear-gradient(135deg, rgba(70,132,255,0.9), rgba(90,170,255,0.9));
  border-color:rgba(120,180,255,0.6);
  color:#06122a;
  box-shadow:0 12px 32px rgba(20,60,120,0.35);
}
.chat-message {
  white-space:pre-wrap;
}
.chat-attachments {
  margin-top:8px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.chat-attach-card {
  border:1px solid rgba(80,110,150,0.35);
  border-radius:12px;
  overflow:hidden;
  background:rgba(12,16,24,0.85);
}
.chat-attach-links {
  font-size:12px;
  color:var(--muted,#97a4c0);
  line-height:1.45;
}
.chat-attach-links a {
  color:#9fc5ff;
  text-decoration:none;
}
.chat-attach-links a:hover { text-decoration:underline; }
.chat-input {
  display:flex;
  gap:10px;
  align-items:flex-end;
  background:rgba(10,14,22,0.9);
  border:1px solid rgba(70,96,140,0.4);
  border-radius:14px;
  padding:12px;
}
.chat-textarea {
  flex:1;
  min-height:80px;
  resize:vertical;
  border-radius:12px;
  border:1px solid rgba(86,105,132,0.6);
  background:rgba(18,24,33,0.95);
  color:var(--text,#e6e6e6);
  padding:10px 12px;
  font-size:13px;
  line-height:1.45;
  transition:border-color .2s ease, box-shadow .2s ease;
}
.chat-textarea:focus {
  outline:none;
  border-color:var(--accent,#4aa8ff);
  box-shadow:0 0 0 2px rgba(74,168,255,0.23);
  background:rgba(21,28,40,0.97);
}
.chat-send {
  border:none;
  background:linear-gradient(135deg, rgba(74,168,255,0.9), rgba(134,77,255,0.9));
  color:white;
  border-radius:12px;
  padding:12px 20px;
  font-weight:700;
  cursor:pointer;
  transition:transform .1s ease, box-shadow .2s ease;
}
.chat-send:hover {
  transform:translateY(-1px);
  box-shadow:0 12px 24px rgba(74,168,255,0.35);
}
.chat-status {
  min-height:18px;
  font-size:12px;
}

@media (max-width: 720px) {
  .chat-shell { padding:16px; }
  .chat-controls { flex-direction:column; align-items:stretch; }
  .chat-target-select { width:100%; min-width:0; }
  .chat-thread { height:44vh; }
  .chat-bubble { max-width:100%; }
  .chat-input { flex-direction:column; }
  .chat-textarea { width:100%; }
  .chat-send { width:100%; }
}

/* Buttons */
.btn.apply {
  background: var(--accent,#4aa8ff); color:#0d1117; font-weight:600; border:1px solid transparent;
}
.btn.apply:hover { background:#3697f7; }
.btn { cursor:pointer; }
.muted { color: var(--muted,#9aa7b4); }




/* Floating toast over the video */
/* Floating toast over the video — centered & larger */
#ytToast{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%, -50%);
  z-index: 9999;

  background: rgba(255, 176, 32, 0.95); /* warm amber */
  color:#051423;
  font-weight:800;
  border:1px solid #c98910;
  border-radius:14px;

  padding:14px 18px;
  font-size:18px;
  line-height:1.2;
  text-align:center;

  box-shadow:0 14px 36px rgba(0,0,0,.45);
  backdrop-filter: blur(4px);

  display:none;
  pointer-events:none;           /* don’t block clicks */
}


/* Team snapshot layout: bullets + compact alignment card side-by-side */
#statsTeamBox .team-snap {
  display: grid;
  grid-template-columns: 1fr minmax(260px, 360px);
  gap: 12px;
  align-items: start;
}

#statsTeamBox .team-bullets .stat-bullet { margin: 4px 0; }
#statsTeamBox .team-bullets .stat-track { width: 220px; height: 8px; }

#statsTeamBox .align-mini {
  padding: 8px 10px;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: var(--panel);
  font-size: 12.5px;
}

#statsTeamBox .align-mini table { width:100%; border-collapse: collapse; }
#statsTeamBox .align-mini th,
#statsTeamBox .align-mini td {
  padding: 6px 6px;
  border-bottom: 1px solid var(--border);
}
#statsTeamBox .align-mini th { text-align: right; }
#statsTeamBox .align-mini th:first-child,
#statsTeamBox .align-mini td:first-child { text-align: left; }
#statsTeamBox .align-mini tr:last-child td { border-bottom: none; }

/* Mobile: stack vertically */
@media (max-width: 820px){
  #statsTeamBox .team-snap {
    grid-template-columns: 1fr;
  }
}



/* INSIGHTS: two+ columns, wrap nicely, responsive */
.pl-insights{
  display: grid !important;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 12px;
  align-items: stretch;
}

/* Make sure individual cards don’t expand to full width */
.pl-insights .insight{
  width: auto !important;
  box-sizing: border-box;
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  padding: 10px;
  background: #fff;
  box-shadow: 0 1px 2px rgba(0,0,0,.05);
}

/* Titles & body */
.pl-insights .insight-title{
  font-weight: 600;
  margin-bottom: 6px;
}

.pl-insights .insight-body{
  color: #374151;
  line-height: 1.35;
}

/* Optional color accents by kind */
.pl-insights .insight.info{ border-left: 4px solid #3b82f6; }
.pl-insights .insight.success{ border-left: 4px solid #10b981; }
.pl-insights .insight.warn{ border-left: 4px solid #f59e0b; }
.pl-insights .insight.error{ border-left: 4px solid #ef4444; }







  /* Notes header bar */
  #notesHeader {
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    padding:10px; border:1px solid var(--border); border-radius:12px;
    background:rgba(255,255,255,0.03);
    margin-bottom:10px;
  }
  #notesHeader .title {
    font-weight:600; margin-right:auto;
  }
  #notesHeader .select, #notesHeader input[type="date"], #notesHeader input[type="text"] {
    min-width:160px; height:34px;
  }
  #notesHeader .btn {
    height:34px; padding:0 12px; border-radius:10px;
  }

  /* Result cards */
  .note-row {
    padding:10px 0; border-bottom:1px dashed var(--border);
    display:grid; grid-template-columns: 160px 1fr; gap:12px;
  }
  .note-meta { font-size:12px; color:var(--muted); }
  .note-text { white-space:pre-wrap; }
  .clips-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px,1fr)); gap:12px; }
  .clip-card {
    border:1px solid var(--border); border-radius:12px; padding:8px;
    background:rgba(255,255,255,0.02);
  }
  .clip-card .embedWrap { aspect-ratio:16/9; border-radius:8px; overflow:hidden; }
  .filters-line { display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }



/* --- Notes Filters (dark theme) --- */
.notes-filters {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
  margin-bottom: 10px;
}

/* Inputs & selects */
.notes-filters select,
.notes-filters input[type="text"] {
  appearance: none;
  background: var(--bg2, #161b22);
  border: 1px solid var(--border, #2a3441);
  color: var(--text, #e6e6e6);
  border-radius: 10px;
  padding: 6px 34px 6px 10px; /* room for custom caret */
  font-size: 13px;
  height: 32px;
  min-width: 140px;
  line-height: 20px;
  transition: border-color 0.2s ease, background-color 0.2s ease;
}

/* Subtle hover/focus */
.notes-filters select:hover,
.notes-filters input[type="text"]:hover {
  border-color: var(--border-strong, #3a4759);
}
.notes-filters select:focus,
.notes-filters input[type="text"]:focus {
  outline: none;
  border-color: var(--accent, #4aa8ff);
  background: var(--bg, #14181f);
}

/* Dark placeholder */
.notes-filters input[type="text"]::placeholder {
  color: #9aa7b4;
}

/* Custom dropdown caret (light chevron) */
.notes-filters select {
  background-image:
    url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3e%3cpath fill='%23c9d1d9' d='M1.06.94a.75.75 0 0 1 1.06 0L5 3.81 7.88.94a.75.75 0 1 1 1.06 1.06L5.53 5.41a.75.75 0 0 1-1.06 0L1.06 2a.75.75 0 0 1 0-1.06z'/%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 10px 6px;
}

/* Hide IE arrow (legacy) */
.notes-filters select::-ms-expand { display: none; }

/* Buttons */
.notes-filters button {
  height: 32px;
  border: 1px solid transparent;
  border-radius: 10px;
  padding: 6px 14px;
  font-size: 13px;
  cursor: pointer;
  transition: background 0.15s ease, border-color 0.15s ease, opacity 0.15s ease;
}

/* Primary (Apply) */
.notes-filters button.apply {
  background: var(--accent, #4aa8ff);
  color: #0d1117;
  font-weight: 600;
}
.notes-filters button.apply:hover {
  background: #3697f7;
}

/* Ghost (Clear) */
.notes-filters button.clear {
  background: var(--bg2, #161b22);
  color: var(--text, #e6e6e6);
  border: 1px solid var(--border, #2a3441);
}
.notes-filters button.clear:hover {
  border-color: var(--border-strong, #3a4759);
}

/* Keep the pills looking consistent */
.tag {
  background: rgba(74, 168, 255, 0.15);
  border: 1px solid rgba(74, 168, 255, 0.35);
  color: #cfe8ff;
  border-radius: 999px;
  padding: 2px 8px;
  font-size: 12px;
  text-decoration: none;
}




/* Make inputs/selects reliably dark everywhere (even outside .notes-filters) */
select,
input[type="text"] {
  background: var(--bg2, #161b22);
  color: var(--text, #e6e6e6);
  border: 1px solid var(--border, #2a3441);
}

/* Global primary action button (Apply, Load more, etc.) */
button.apply,
#nMsg button.apply {
  background: var(--accent, #4aa8ff);
  color: #0d1117 !important;
  border: 1px solid #3a7fd6;
  border-radius: 10px;
  padding: 6px 14px;
  font-size: 13px;
  font-weight: 600;
  height: 32px;
  cursor: pointer;
  transition: background .15s ease, border-color .15s ease;
}
button.apply:hover,
#nMsg button.apply:hover {
  background: #3697f7;
  border-color: #2e6ec0;
}

/* Global secondary button (Clear, etc.) */
button.clear,
#nMsg button.clear {
  background: var(--bg2, #161b22);
  color: var(--text, #e6e6e6) !important;
  border: 1px solid var(--border, #2a3441);
  border-radius: 10px;
  padding: 6px 14px;
  font-size: 13px;
  height: 32px;
  cursor: pointer;
  transition: border-color .15s ease, background .15s ease;
}
button.clear:hover,
#nMsg button.clear:hover {
  border-color: var(--border-strong, #3a4759);
}

/* Ensure the footer button sits nicely next to the count */
#nMsg button.apply,
#nMsg button.clear {
  margin-left: 8px;
}



#teamAlignBox { display: none !important; }




/* --- Daily Ratings header layout --- */
.ratings-header {
  display: flex;
  align-items: center;
  gap: 10px; /* small space between title and button */
  margin-bottom: 8px;
}

.ratings-header h1 {
  margin: 0;
  font-size: 20px;
  font-weight: 600;
  line-height: 1.2;
}

#openRatingsBtn.btn.btn-small {
  height: 28px;
  padding: 0 10px;
  font-size: 13px;
  border-radius: 8px;
}



/* === Sidebar (single source of truth) === */
:root{
  --sidebar-w: 220px;          /* expanded width */
  --sidebar-w-collapsed: 60px; /* collapsed rail width */
  --sidebar-gap: 8px;          /* space between sidebar and content */
}

/* Sidebar */
#sideNav{
  position: fixed; top:0; left:0; bottom:0;
  width: var(--sidebar-w);
  background: #14181f;
  border-right: 1px solid #2a3441;
  display:flex; flex-direction:column;
  z-index:100;
  transition: width .25s ease;
}
#sideNav .sideHeader{
  position: sticky; top:0;
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 10px;
  border-bottom:1px solid #2a3441;
  background: inherit;
  z-index: 2;
}
#sideNav .sideLogo{ width:30px; height:30px; border-radius:6px; object-fit:contain; }
#sideNav .sideTitle{ color:#e6e6e6; font-weight:600; font-size:14px; }
#sideNav .collapseBtn{ border:0; background:none; color:#4aa8ff; font-size:16px; cursor:pointer; padding:0 4px; }

#sideNav .sideList{ flex:1; overflow-y:auto; padding:10px 0; }
#sideNav .sideItem{
  padding:8px 14px; margin:2px 6px; border-radius:8px;
  color:#e6e6e6; cursor:pointer; transition:background .2s ease;
  white-space:nowrap; font-size:13px;
}
#sideNav .sideItem:hover{ background:rgba(255,255,255,.08); }
#sideNav .sideItem.active{ background:rgba(74,168,255,.18); color:#cfe8ff; font-weight:600; }

/* Only shift PANELS (and top tabs if present) — no extra margins anywhere else */
body.sidebar-enabled .panel,
body.sidebar-enabled .tabs{
  margin-left: calc(var(--sidebar-w) + var(--sidebar-gap));
  transition: margin-left .25s ease;
}

/* Collapsed mode: shrink bar, hide list (keep logo + arrow) */
#sideNav.collapsed{ width: var(--sidebar-w-collapsed); }
#sideNav.collapsed .sideTitle{ display:none; }
#sideNav.collapsed .sideList{ display:none; }

/* Content shift when collapsed */
body.sidebar-enabled.sidebar-collapsed .panel,
body.sidebar-enabled.sidebar-collapsed .tabs{
  margin-left: calc(var(--sidebar-w-collapsed) + var(--sidebar-gap));
}

/* Mobile: minimal shift */
@media (max-width: 900px){
  body.sidebar-enabled .panel,
  body.sidebar-enabled .tabs{
    margin-left: calc(var(--sidebar-w-collapsed) + 8px);
  }
}





    </style>
  </head>

  <body class="sidebar-enabled desktop">
    <!-- Clip Modal -->
    <div id="clipModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:30000; align-items:center; justify-content:center;">
      <div id="clipModalCard" style="position:relative; width:90%; max-width:980px; background:#14181f; border:1px solid #2a3448; border-radius:12px; overflow:hidden;">






        <!-- Close -->
        <button onclick="closeClipModal()" style="position:absolute; top:10px; right:10px; z-index:3; background:#ff5a5f; border:0; color:white; font-weight:700; padding:6px 10px; border-radius:8px; cursor:pointer;">Close</button>

        <!-- Prev / Next -->
        <button onclick="prevClip()" class="btn" style="position:absolute; left:10px; top:50%; transform:translateY(-50%); z-index:2;">⏮ Prev</button>
        <button onclick="nextClip()" class="btn" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); z-index:2;">Next ⏭</button>

        <!-- Video -->
        <iframe id="clipFrame" src="" style="width:100%; height:560px; border:0;"
                allow="autoplay; encrypted-media" allowfullscreen
                referrerpolicy="no-referrer-when-downgrade"></iframe>


<div id="ytToast" role="status" aria-live="polite"></div>


        <!-- Footer: select toggle + notes input + Save + hint -->
        <div id="clipModalFooter" style="padding:10px; border-top:1px solid var(--border); background:#0f131a; display:flex; gap:8px; align-items:center;">
          <button id="clipSelectBtn" class="btn" onclick="toggleSelectCurrentClip()">Select clip</button>
          <span id="clipSelectedBadge" class="tag" style="display:none;">Selected</span>

          <input id="clipNoteInput" type="text" placeholder="Add a note (optional)"
                 class="select" style="flex:1; min-height:38px;" oninput="onClipNoteInput(event)">

         <button id="clipNoteSaveBtn" class="btn" type="button" onclick="saveClipNoteFromFooter()">Save note</button>
         <button class="btn" type="button" onclick="discussClip(encodeURIComponent(getCurrentClipUrl()))">Discuss in Chat</button>
<span id="clipNoteMsg" class="muted" style="min-width:110px; text-align:right;"></span>

          <span id="clipSelHint" class="muted" style="min-width:110px; text-align:right;"></span>
        </div>
      </div>
    </div>




<!-- Report Viewer Modal -->
<div id="reportModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.8); z-index:30010; align-items:center; justify-content:center;">
  <div style="position:relative; width:92%; max-width:1000px; background:#14181f; border:1px solid #2a3448; border-radius:12px; overflow:hidden;">
    <button onclick="closeReportModal()" style="position:absolute; top:10px; right:10px; z-index:3; background:#ff5a5f; border:0; color:white; font-weight:700; padding:6px 10px; border-radius:8px; cursor:pointer;">Close</button>
    <iframe id="reportFrame" src="" style="width:100%; height:78vh; border:0;" allow="autoplay; encrypted-media" referrerpolicy="no-referrer-when-downgrade"></iframe>
  </div>
</div>







<!-- Login overlay (unchanged wrapper) -->
<div id="loginOverlay" style="position:fixed;inset:0; background:#0b0d10; display:flex;align-items:center;justify-content:center; z-index:9999; overflow:hidden;">
  <img src="https://www.peristeribc.gr/wp-content/uploads/2025/07/Peristeri-Logo-plain-1.png"
       style="position:absolute;inset:0;margin:auto;opacity:0.08;width:90%;height:90%;object-fit:contain;pointer-events:none;" />
  <div style="background:rgba(20,24,31,0.95);padding:28px;border-radius:16px;text-align:center;z-index:1;max-width:320px; width:90%;">
    <h2 style="margin-bottom:16px;">Enter Password</h2>
    <input id="pwInput" type="password"
           style="padding:10px;width:100%;border-radius:8px;border:1px solid #2a3448;background:#0f131a;color:#e9edf6;" />
    <div style="height:12px;"></div>
    <button onclick="unlockAndStart()" style="padding:10px 14px;width:100%;border-radius:8px;border:0;background:#4aa8ff;color:#051423;font-weight:700;">
      Unlock
    </button>
    <div id="pwMsg" style="margin-top:10px;color:#ff5a5f;"></div>
  </div>
</div>

<!-- Hide the old top tab bar (kept for compatibility/rollback) -->
<style>.tabs { display:none !important; }</style>

<!-- SIDEBAR NAVIGATION -->
<nav id="sideNav">
  <div class="sideHeader">
    <img src="https://www.peristeribc.gr/wp-content/uploads/2025/07/Peristeri-Logo-plain-1.png" class="sideLogo">
    <span class="sideTitle">Peristeri BC</span>
    <button id="collapseNav" class="collapseBtn">⟨</button>
  </div>
  <div class="sideList">
    <div class="sideItem active" data-tab="home">🏠 Home</div>
    <div class="sideItem" data-tab="dailyratings">📊 Daily Ratings</div>
    <div class="sideItem" data-tab="traitratings">🎯 Trait Ratings</div>
    <div class="sideItem" data-tab="notes">📝 Notes</div>
    <div class="sideItem" data-tab="opponents">📅 Schedule</div>
    <div class="sideItem" data-tab="team">👥 Team</div>
    <div class="sideItem" data-tab="players">🏀 Players</div>
    <div class="sideItem" data-tab="stats">📈 Stats</div>
    <div class="sideItem" data-tab="clips">🎬 Clips</div>
    <div class="sideItem" data-tab="summaries">📹 Video Summaries</div>
    <div class="sideItem" data-tab="strength">💪 Practice Load</div>
    <div class="sideItem" data-tab="chat">💬 Chat</div>
    <div class="sideItem" data-tab="gamestats">📊 Game Stats</div>
  </div>
</nav>

<div id="mobileNavOverlay"></div>

<!-- Mobile tab bar -->
<div class="mobile-tabbar" id="mobileTabbar">
  <button type="button" data-mobile-nav="toggle" aria-label="Menu">☰<span>Menu</span></button>
  <button type="button" data-tab="home" class="active" aria-label="Home">🏠<span>Home</span></button>
  <button type="button" data-tab="players" aria-label="Players">🏀<span>Players</span></button>
  <button type="button" data-tab="clips" aria-label="Clips">🎬<span>Clips</span></button>
  <button type="button" data-tab="notes" aria-label="Notes">📝<span>Notes</span></button>
  <button type="button" data-tab="chat" aria-label="Chat">💬<span>Chat</span></button>
  <button type="button" data-tab="gamestats" aria-label="Game Stats">📊<span>Game Stats</span></button>
</div>

<!-- HOME -->
<div id="panel-home" class="panel active home-panel">
  <div class="home-top">
    <div class="card" id="homeSessionCard">
      <div class="summary-card-header">
        <h2>Latest Session</h2>
        <button class="btn btn-small" type="button" onclick="loadHomeSummary(true)">Refresh</button>
      </div>
      <div id="homeSummaryTimestamp" class="muted" style="font-size:12px;"></div>
      <div id="homeSessionBody" class="muted">Loading…</div>
    </div>

    <div class="card" id="homeUpcomingCard">
      <div class="summary-card-header"><h2>Upcoming Games</h2></div>
      <div id="homeUpcomingList" class="upcoming-list">Loading…</div>
    </div>
  </div>

  <div class="card home-chart-card">
    <div class="sectionTitle" style="margin-bottom:6px; text-align:center;">Team Rating (avg of all players)</div>
    <div id="teamLineWrap" style="overflow:auto;">
      <svg id="teamLine"></svg>
    </div>
    <div id="teamLineNote" class="muted" style="margin-top:6px; text-align:center;"></div>
  </div>

  <div class="card home-flags-card">
    <div class="sectionTitle">Team — 3-Day Flags</div>
    <div class="ratingsWrap">
      <table id="flagsTable"><thead></thead><tbody></tbody></table>
    </div>
    <div id="flagsMsg" class="muted" style="margin-top:8px;"></div>
  </div>
</div>

<div id="panel-team" class="panel">
  <h1>Team — Last 7 Days</h1>

  <div id="teamBox" class="grid" style="grid-template-columns:1fr 1fr; gap:18px;"></div>


  <!-- Theme Frequency card (STAYS inside panel-team) -->
  <div id="teamClipThemes" class="card" style="margin-top:16px;">
    <div class="sectionTitle">Theme Frequency (last 7 days)</div>
    <div id="themeChips"></div>
  </div>
</div> <!-- close panel-team once -->

<!-- DAILY RATINGS -->
<div id="panel-dailyratings" class="panel">
  <div class="ratings-header">
    <h1>Daily Ratings — Heat Map</h1>
    <button id="openRatingsBtn" class="btn btn-small">Rate session</button>
  </div>

  <div class="ratingsWrap">
    <table id="ratingsTable"><thead></thead><tbody></tbody></table>
  </div>

  <div id="ratingsLegend" class="muted" style="margin-top:8px;"></div>
</div>

    <!-- TRAIT RATINGS -->
    <div id="panel-traitratings" class="panel">
      <h1>Trait Ratings — Heat Map</h1>
      <div class="ratingsWrap">
        <table id="traitTable"><thead></thead><tbody></tbody></table>
      </div>
      <div id="traitLegend" class="muted" style="margin-top:8px;"></div>
    </div>

    <div id="panel-gamestats" class="panel">
      <h1>Game Stats</h1>
      <div class="gamestats-controls">
        <select id="gsGame">
          <option value="">Select game</option>
        </select>
        <select id="gsTeam">
          <option value="">All teams</option>
        </select>
        <select id="gsPlayer">
          <option value="">All players</option>
        </select>
        <select id="gsPeriod">
          <option value="">All periods</option>
        </select>
        <button id="gsLoadBtn" type="button">Load</button>
      </div>
      <div class="gamestats-summary">
        <div class="gs-card">
          <div class="gs-meta" id="gsGameMeta">
            <strong>No game loaded</strong>
            <span>Select a game to view details.</span>
          </div>
        </div>
        <div class="gs-card">
          <h3 style="margin:0;">Advanced Snapshot</h3>
          <ul id="gsAdvancedMetrics" class="gs-metric-list"></ul>
        </div>
        <div class="gs-card">
          <h3 style="margin:0;">Key Notes</h3>
          <ul id="gsInsights" class="gs-metric-list"></ul>
        </div>
      </div>
      <div class="gamestats-charts">
        <div class="gamestats-section chart-duo">
          <h2>Four Factors</h2>
          <canvas id="gsFourChart" class="gs-chart-square"></canvas>
        </div>
        <div class="gamestats-section chart-duo">
          <h2>Shot Profile</h2>
          <canvas id="gsShotChart" class="gs-chart-square"></canvas>
        </div>
        <div class="gamestats-section chart-span">
          <h2>Game Flow</h2>
          <div class="gamestats-canvas-wrap">
            <canvas id="gsFlowChart"></canvas>
          </div>
        </div>
        <div class="gamestats-section chart-span">
          <h2>Usage vs Efficiency</h2>
          <div class="gamestats-canvas-wrap">
            <canvas id="gsUsageChart"></canvas>
          </div>
        </div>
      </div>
      <div id="gsMessage" class="muted" style="margin-top:8px;"></div>
    </div>

    <!-- PLAYERS -->
    <div id="panel-players" class="panel">
      <div class="grid g2">
        <div class="card">
          <label class="muted">Player</label>
          <select id="playerSelect" class="select" onchange="onPlayerChange(this.value)"></select>
          <div id="playerPhotoWrap" style="margin-top:10px;">
            <img id="playerPhoto" class="avatar" alt="Player photo" />
          </div>
          <div class="kv">
            <div>Overall delta</div><div id="pOverall" class="mono">—</div>
          </div>
          <div class="sectionTitle">3-Day Flags</div>
          <div id="pFlags" class="mono muted">—</div>
          <div class="sectionTitle">Ratings by Coach</div>
          <div id="pCoachRatings" class="mono muted">—</div>
        </div>

        <div class="card">
          <h2>Strengths</h2>
          <ul id="pStrengths"></ul>
          <h2>Areas to Improve</h2>
          <ul id="pWeaknesses"></ul>
          <h2>Suggested Focus</h2>
          <ul id="pFocus"></ul>

          <div class="sectionTitle">Clips (newest)</div>
          <div id="pClips"></div>
        </div>
      </div>
    </div>



 <!-- stats -->
<section id="panel-stats" class="panel">
  <div class="sectionTitle" style="margin-top:0;">Stats</div>

  <div id="statsMsg" class="muted" style="margin-bottom:8px;">Loading…</div>

  <!-- League scatter -->
  <div id="statsTeamBox" class="card" style="padding:10px;margin-bottom:12px; border:1px solid var(--border); border-radius:12px;">
    <div style="font-weight:600; margin-bottom:6px;">League ORtg vs DRtg</div>
    <div class="muted" data-role="league-note" style="font-size:12px; margin-bottom:6px;">Bubble size reflects net rating (eDiff). Look for top-right bubbles (high ORtg, low DRtg) to spot elite teams.</div>
    <div class="league-scatter-wrap"><canvas id="statsLeagueChart"></canvas></div>
  </div>

  <!-- Opponent profiler -->
  <div class="card stats-opp-card" style="margin-bottom:12px; border:1px solid var(--border); border-radius:12px;">
    <div style="font-weight:600; display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
      <span>Opponent profile vs league & Peristeri</span>
      <div style="display:flex; align-items:center; gap:6px;">
        <label for="statsOpponentSelect" class="muted" style="font-size:12px;">Opponent</label>
        <select id="statsOpponentSelect" class="select" style="width:200px;"></select>
      </div>
    </div>
    <div id="statsOpponentProfile" class="muted" style="font-size:13px;">
      Pick a team to compare key metrics against league averages and Peristeri BC.
    </div>
  </div>

  <!-- Players table -->
  <div class="sectionTitle">Player insights</div>
  <div class="muted" style="margin-bottom:6px;">Derived per-40, shot profile, advanced join + flags</div>
  <div style="overflow:auto;">
    <table id="statsPlayersTable" class="table">
      <thead>
        <tr>
          <th>Player</th><th>MPG</th><th>PPG</th><th>FGA</th><th>3PM</th><th>3PA</th><th>3PAr</th><th>FTr</th>
          <th>PPS</th><th>TS%</th><th>USG%</th><th>TOV%</th><th>ORtg</th><th>eDiff</th><th>PER</th>
          <th>Per40 PTS</th>
<th>Per40 REB</th>
<th>Per40 AST</th>
<th>Per40 Stocks</th>
          
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Leaderboards -->
  <div class="sectionTitle">Leaderboards</div>
  <div id="statsLeaders" class="grid" style="display:grid; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); gap:10px;"></div>
</section>








    <!-- CLIPS -->
    <div id="panel-clips" class="panel">
      <div class="filters">
        <select id="fPlayer"></select>
        <select id="fTheme"></select>
        <select id="fSub"></select>
        <input id="fSearch" type="text" placeholder="Search text…" />
        <button class="btn" onclick="loadClips()">Search</button>
        <button class="btn-danger" onclick="openFeedbackModal()">Email Feedback</button>
        <button class="btn" onclick="openCreateSummaryModal()">Create indiv. Summary</button>
        <button class="btn" onclick="discussSelectedClips()">Discuss Selected</button>
        <button class="btn" onclick="deselectAllClips()">Deselect All</button>
      </div>
      <div id="clipsList"></div>
    </div>

    <!-- Feedback Compose Modal -->
<div id="feedbackModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.75); z-index:10001; align-items:center; justify-content:center;">
  <div style="background:#14181f; border:1px solid #2a3448; border-radius:12px; width:90%; max-width:680px; padding:16px; position:relative;">
    <button onclick="closeFeedbackModal()" style="position:absolute; right:12px; top:12px; border:0; background:#ff5a5f; color:white; font-weight:700; padding:6px 10px; border-radius:8px; cursor:pointer;">Close</button>

    <h2 style="margin-top:0;">Email feedback</h2>

        <div style="display:grid; gap:10px;">
          <label>Player
            <select id="fbPlayer" class="select"></select>
          </label>

          <label>Message to player
            <textarea id="fbText" rows="6" style="width:100%; padding:10px; border-radius:10px; background:#0f131a; color:var(--text); border:1px solid var(--border);"></textarea>
          </label>

          <div class="muted" id="fbSelectedCount">No clips selected.</div>

          <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
            <button class="btn" onclick="sendFeedback()" id="fbSendBtn">Send</button>
          </div>

          <div id="fbMsg" class="muted"></div>
        </div>
      </div>
    </div>

    <!-- Create Summary Modal -->
    <div id="createSummaryModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.75); z-index:10003; align-items:center; justify-content:center;">
      <div style="background:#14181f; border:1px solid #2a3448; border-radius:12px; width:92%; max-width:820px; padding:16px; position:relative; max-height:92vh; overflow:auto;">
        <button onclick="closeCreateSummaryModal()" style="position:absolute; right:12px; top:12px; border:0; background:#ff5a5f; color:white; font-weight:700; padding:6px 10px; border-radius:8px; cursor:pointer;">Close</button>

        <h2 style="margin-top:0;">Create Summary</h2>

        <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px;">
          <label>Title
            <input id="sumTitle" type="text" class="select" placeholder="e.g., 12 Feb — Transition Defense" />
          </label>
          <label>Audience type
            <select id="sumAudienceType" class="select" onchange="onSumAudienceTypeChange()">
              <option value="player">Player</option>
              <option value="team">Team</option>
              <option value="group">Group</option>
            </select>
          </label>
          <label id="sumAudienceNameWrap">Audience name
            <select id="sumAudienceName" class="select"></select>
          </label>
          <label>Description
            <textarea id="sumDescription" rows="3" style="width:100%; padding:10px; border-radius:10px; background:#0f131a; color:var(--text); border:1px solid var(--border);" placeholder="Optional context for the reel"></textarea>
          </label>
        </div>

        <div class="sectionTitle" style="margin-top:12px;">Selected Clips & Captions</div>
        <div class="ratingsWrap">
          <table id="sumClipsTable">
            <thead><tr><th style="text-align:center;">#</th><th>Clip</th><th>Caption (optional)</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="sumMsg" class="muted" style="margin-top:8px;"></div>

        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
          <button class="btn" id="sumSaveBtn" onclick="saveSummary()">Save Summary</button>
        </div>
      </div>
    </div>

    <!-- Summary View Modal -->
    <div id="summaryViewModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.75); z-index:10002; align-items:center; justify-content:center;">
      <div style="background:#14181f; border:1px solid #2a3448; border-radius:12px; width:92%; max-width:820px; padding:16px; position:relative; max-height:92vh; overflow:auto;">
        <button onclick="closeSummaryModal()" style="position:absolute; right:12px; top:12px; border:0; background:#ff5a5f; color:white; font-weight:700; padding:6px 10px; border-radius:8px; cursor:pointer;">Close</button>
        <h2 id="svTitle" style="margin-top:0;">Summary</h2>
        <div class="muted" id="svMeta"></div>
        <p id="svDesc" style="white-space:pre-wrap;"></p>

        <div class="ratingsWrap">
          <table id="svClipsTable">
            <thead>
              <tr><th style="text-align:center;">#</th><th>Clip</th><th>Caption</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="svMsg" class="muted" style="margin-top:8px;"></div>
      </div>
    </div>

    <!-- SUMMARIES -->
    <div id="panel-summaries" class="panel">
      <h1>Summaries</h1>
      <div class="ratingsWrap">
        <table id="sumListTable">
          <thead>
            <tr>
              <th style="text-align:center;">Date</th>
              <th>Title</th>
              <th>Audience</th>
              <th style="text-align:center;">Open</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="sumListMsg" class="muted" style="margin-top:8px;"></div>
    </div>

 






<div id="panel-chat" class="panel">
  <div class="chat-shell">
    <div class="chat-header">
      <div>
        <h2>Coach Chat</h2>
        <p>Share quick updates, reminders, and links with the staff.</p>
      </div>
      <button class="chat-refresh" type="button" onclick="refreshChat()">↻ Refresh</button>
    </div>

    <div class="chat-controls">
      <div class="chat-control-group">
        <span class="chat-label">Send to</span>
        <select id="chatTo" class="chat-target-select">
          <option value="All">All coaches</option>
        </select>
      </div>
    </div>

    <div id="chatList" class="chat-thread">
      <div class="chat-empty">No messages yet.</div>
    </div>

    <div class="chat-input">
      <textarea id="chatText" rows="3" class="chat-textarea" placeholder="Write a note to this coach (or All coaches)…"></textarea>
      <button class="chat-send" type="button" onclick="sendChat()">Send</button>
    </div>

    <div class="chat-status muted" id="chatMsg"></div>
  </div>
</div>


<div id="opponentReportModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.75); z-index:10050; align-items:center; justify-content:center;">
  <div style="background:#14181f; border:1px solid #2a3448; border-radius:12px; width:90%; max-width:640px; padding:16px; position:relative; display:flex; flex-direction:column; gap:12px;">
    <button onclick="closeOpponentReport()" style="position:absolute; right:12px; top:12px; border:0; background:#ff5a5f; color:white; font-weight:700; padding:6px 12px; border-radius:8px; cursor:pointer;">Close</button>
    <h2 style="margin:0;">Opponent Statistical Report</h2>
    <div class="muted" style="font-size:12px;">Copy and share the generated report with staff.</div>
    <textarea id="opponentReportText" style="width:100%; min-height:260px; background:#0b0d10; color:#dce5ff; border:1px solid #2a3448; border-radius:8px; padding:10px; font-size:13px; line-height:1.5; white-space:pre-wrap;"></textarea>
    <div style="display:flex; gap:8px; justify-content:flex-end;">
      <button class="btn" type="button" onclick="copyOpponentReport(this)">Copy to clipboard</button>
    </div>
  </div>
</div>








<div id="notesTooltip" style="
  position: fixed;
  z-index: 100000;
  display: none;
  max-width: 360px;
  background: rgba(20,24,31,0.98);
  color: #e9edf6;
  border: 1px solid #2a3448;
  border-radius: 10px;
  padding: 10px;
  box-shadow: 0 8px 24px rgba(0,0,0,.4);
  pointer-events: none;
  font-size: 13px;
  line-height: 1.35;
"></div>




<div id="panel-opponents" class="panel">
  <h1>Shedule</h1>
  <div class="card" id="oppScheduleCard">
    <div class="sectionTitle">Upcoming & Past Games</div>
    <div id="oppScheduleList">Loading…</div>
  </div>
</div>



<!-- STRENGTH / PRACTICE LOAD -->
<div id="panel-strength" class="panel">
  <h1>Practice Load</h1>

  <div class="ratingsWrap">
    <table id="plListTable">
      <thead>
        <tr>
          <th style="text-align:center;">Date</th>
          <th>Title</th>
          <th>Audience</th>
          <th style="text-align:center;">Open</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="plListMsg" class="muted" style="margin-top:8px;"></div>
</div>
<!-- Practice Load View Modal -->
<div id="plViewModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.75); z-index:10005; align-items:center; justify-content:center;">
  <div style="background:#14181f; border:1px solid #2a3448; border-radius:12px; width:92%; max-width:860px; padding:16px; position:relative; max-height:92vh; overflow:auto;">
    <button onclick="closePLModal()" style="position:absolute; right:12px; top:12px; border:0; background:#ff5a5f; color:white; font-weight:700; padding:6px 10px; border-radius:8px; cursor:pointer;">Close</button>

    <h2 id="plTitle" style="margin-top:0;">Practice Load</h2>
    <div id="plMeta" class="muted" style="margin-bottom:8px;"></div>
    <p id="plDesc" style="white-space:pre-wrap;"></p>
    <div id="plFacts" class="pl-facts"></div>

    <!-- 4 metrics only inside this grid -->
    <div class="grid" style="grid-template-columns: repeat(4, minmax(0, 1fr)); gap:12px; margin:12px 0;">
      <div class="card"><div class="muted">Session Load</div><div id="plM_load" class="mono" style="font-size:18px;">—</div></div>
      <div class="card"><div class="muted">ACWR</div><div id="plM_acwr" class="mono" style="font-size:18px;">—</div></div>
      <div class="card"><div class="muted">Monotony</div><div id="plM_mono" class="mono" style="font-size:18px;">—</div></div>
      <div class="card"><div class="muted">Strain</div><div id="plM_strain" class="mono" style="font-size:18px;">—</div></div>
    </div>

    <!-- Insights OUTSIDE the metrics grid -->
    <h4 class="mt-8">Insights</h4>
    <div id="plInsights" class="pl-insights"></div>

    <div class="card" style="margin-top:12px;">
      <div class="sectionTitle">14-Day Trend</div>
      <canvas id="plChart" height="160"></canvas>
      <div id="plChartNote" class="muted" style="margin-top:6px;"></div>
    </div>

    <div class="grid g2" style="margin-top:12px;">
      <div class="card">
        <div class="sectionTitle">Positives</div>
        <ul id="plPos"><li class="muted">—</li></ul>
      </div>
      <div class="card">
        <div class="sectionTitle">Suggestions</div>
        <ul id="plSug"><li class="muted">—</li></ul>
      </div>
    </div>
  </div>
</div>










<!-- note library -->
<div id="panel-notes" class="panel">
  <h1>Notes Library</h1>

<div class="notes-filters">
  <div class="filter-block">
    <label for="nPlayer">Player</label>
    <select id="nPlayer"></select>
  </div>

  <div class="filter-block">
    <label for="nCoach">Coach</label>
    <select id="nCoach"></select>
  </div>

  <div class="filter-block">
    <label for="nSession">Session</label>
    <select id="nSession"></select>
  </div>

  <div class="filter-block">
    <label for="nScore">Score</label>
    <select id="nScore">
      <option value="">All</option>
      <option value="bad">Bad (&lt;3.0)</option>
      <option value="ok">OK (3.0–3.99)</option>
      <option value="good">Good (≥4.0)</option>
    </select>
  </div>

  <div class="filter-block">
    <label for="nQ">Search</label>
    <input type="text" id="nQ" placeholder="Search notes…">
  </div>

  <div class="filter-buttons">
    <button id="nApply" class="apply">Apply</button>
    <button id="nClear" class="clear">Clear</button>
  </div>
</div>

  <!-- Message area -->
  <div id="nMsg" class="muted" style="margin:6px 0;"></div>

  <!-- Notes list -->
  <div class="card" style="padding:10px; border:1px solid var(--border); border-radius:12px;">
    <div class="sectionTitle" style="margin-top:0;">Notes</div>
    <div id="notesList"></div>
  </div>
</div>








<!-- Floating presence widget -->
<div class="presence-widget" id="presenceWidget">
  <header>
    <div class="muted">Online now</div>
    <div>
      <button class="presence-btn" title="Refresh" onclick="refreshPresenceWidget()">↻</button>
      <button class="presence-btn" title="Collapse/Expand" onclick="togglePresenceWidget()">▾</button>
    </div>
  </header>
  <div class="presence-list" id="presenceWidgetList">
    <div class="presence-empty">Loading…</div>
  </div>
</div>











<!-- Coach Notifications Popup -->
<div id="coachNotify"
     style="position:fixed; bottom:20px; right:20px; z-index:20010; display:none;
            background:#1e2530; color:#e9edf6; border:1px solid #2a3448; border-left:4px solid #4aa8ff;
            padding:10px 12px; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.35); max-width:320px;">
  <div id="coachNotifyTitle" style="font-weight:700; margin-bottom:2px; font-size:13px;"></div>
  <div id="coachNotifyText" style="font-size:13px; line-height:1.35;"></div>

  <div id="coachNotifyActions" style="display:flex; gap:6px; flex-wrap:wrap; margin-top:8px;"></div>

  <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
    <button id="coachNotifyPrev" class="presence-btn" style="padding:4px 8px;">◂</button>
    <button id="coachNotifyNext" class="presence-btn" style="padding:4px 8px;">▸</button>
    <button id="coachNotifyClose" class="presence-btn" style="padding:4px 8px;">✕</button>
  </div>
</div>


<!-- Ratings Modal -->
<div id="ratingsModal" class="modal" style="display:none;">
  <div class="modal-card">
    <header>
      <div>Coach Ratings</div>
      <button class="icon" onclick="closeRatingsModal()" title="Close">✕</button>
    </header>

    <div class="modal-body">
      <!-- Form line -->
      <div class="rate-form">
        <label>
          <span>Coach</span>
          <select id="rtCoach"></select>
        </label>
        <label>
          <span>Session</span>
          <select id="rtSession"></select>
        </label>
        <label>
          <span>Date</span>
          <input type="date" id="rtDate">
        </label>
        <div class="grow"></div>
        <button class="btn apply" id="rtSaveBtn" onclick="saveRatings()">Save</button>
      </div>

      <!-- Quick fill row -->
      <div class="rate-quickfill">
        <span>Set all to:</span>
        <select id="rtAllVal">
          <option value="">—</option>
          <option>5</option><option>4</option><option>3</option><option>2</option><option>1</option>
        </select>
        <button class="btn" onclick="applyAll()">Apply to all traits</button>
      </div>

      <!-- Players table -->
      <div class="rate-table">
        <div class="rate-table-hint">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm.75 15h-1.5v-6h1.5v6zm0-7.8h-1.5V7h1.5v2.2z"/>
          </svg>
          <span>Scroll to review each player. Headers and names stay pinned so you always know what you are editing.</span>
        </div>
        <div class="rate-table-scroll">
          <table id="rtTable">
            <thead>
              <tr>
                <th class="player-col">Player</th>
                <th data-trait="exec">Exec</th>
                <th data-trait="energy">Energy</th>
                <th data-trait="comm">Comm</th>
                <th data-trait="adapt">Adapt</th>
                <th data-trait="resilience">Resilience</th>
                <th data-trait="impact">Impact</th>
                <th style="min-width:300px;">Notes</th>
              </tr>
            </thead>
            <tbody><!-- rows injected --></tbody>
          </table>
        </div>
      </div>

      <div id="rtMsg" class="muted rate-message"></div>
    </div>
  </div>
</div>




    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
const HAS_APPS_SCRIPT_RUNTIME =
  (typeof google !== 'undefined') && !!(google && google.script && google.script.run);
const IS_LOCAL_PREVIEW = !HAS_APPS_SCRIPT_RUNTIME;

if (!HAS_APPS_SCRIPT_RUNTIME) {
  const createRunStub = () => {
    let successHandler = null;
    let failureHandler = null;

    const stub = new Proxy({}, {
      get(_target, prop) {
        if (prop === 'withSuccessHandler') {
          return (fn) => {
            successHandler = (typeof fn === 'function') ? fn : null;
            return stub;
          };
        }
        if (prop === 'withFailureHandler') {
          return (fn) => {
            failureHandler = (typeof fn === 'function') ? fn : null;
            return stub;
          };
        }
        if (prop === 'then' || prop === 'catch' || prop === 'finally') {
          return undefined;
        }
        return (...args) => {
          console.warn(`[Local preview] google.script.run.${String(prop)} skipped.`, args);
          if (successHandler) {
            try { successHandler(null); } catch (err) { console.error(err); }
          } else if (failureHandler) {
            try { failureHandler(new Error('Apps Script backend not available in local preview.')); } catch (err) { console.error(err); }
          }
          successHandler = null;
          failureHandler = null;
          return stub;
        };
      },
    });

    return stub;
  };

  if (!window.google) window.google = {};
  if (!window.google.script) window.google.script = {};
  window.google.script.run = createRunStub();
}

/* -------------------- Lightweight caches -------------------- */
const dataCache = {
  playersList: null,
  clipFilters: null,
  teamTrend: null,
  themeCounts: null,
};
const playerDataCache = {
  detail: new Map(),
  photo: new Map(),
  coachRatings: new Map(),
  clips: new Map(),
  bundle: new Map(),
};
window._currentOpponentReport = null;
window._currentOpponentReportText = null;

/* -------------------- Auth overlay -------------------- */



function parseTimesWindowSeconds_(s){
  if (!s) return null;
  const m = String(s).match(/@?\s*(\d{1,2}:\d{2}(?::\d{2})?)\s*[-–]\s*(\d{1,2}:\d{2}(?::\d{2})?)/);
  if (!m) return null;
  const toSec = t => {
    const p = t.split(':').map(Number);
    return p.length === 2 ? p[0]*60 + p[1] : p[0]*3600 + p[1]*60 + p[2];
  };
  const start = toSec(m[1]);
  const end   = toSec(m[2]);
  if (!isFinite(start) || !isFinite(end) || end <= start) return null;
  return { start, end };
}


let _ytEndTimeout = null;


function showYtToast_(msg){
  const card = document.getElementById('clipModalCard');
  if (!card) return;
  let el = document.getElementById('ytToast');
  if (!el) {
    el = document.createElement('div');
    el.id = 'ytToast';
    card.appendChild(el);
  }
  el.textContent = msg || 'End of tagged clip';
  el.style.display = 'block';
  // auto-hide after 2 seconds
  setTimeout(() => { if (el) el.style.display = 'none'; }, 6000);
}
function clearYtToast_(){
  const el = document.getElementById('ytToast');
  if (el) el.style.display = 'none';
}









// --- Auth + presence (single source of truth) ---
const MY_PASSWORD = "peristeri";
window.CURRENT_USER_NAME = "";
window._presencePingTimer = null;

// expose globally for the Unlock button

  // single source of truth
  window.CURRENT_USER_NAME = "";
  window._presencePingTimer = null;



window.unlockAndStart = function unlockAndStart() {
  const pw  = document.getElementById('pwInput')?.value.trim();
  const msg = document.getElementById('pwMsg');
  msg.textContent = '';

  if (!pw) { msg.textContent = 'Enter password.'; return; }

  google.script.run
    .withSuccessHandler(res => {
      if (!res || !res.ok) { msg.textContent = (res && res.error) || 'Wrong password.'; return; }

      window.CURRENT_USER_NAME = res.name;

      google.script.run
        .withSuccessHandler(() => {
          startPresencePings();
          document.getElementById("loginOverlay").style.display = "none";

          // ✅ Fetch dynamic coach notifications from server
          google.script.run
            .withSuccessHandler(n => {
              const msgs = (n && n.ok && Array.isArray(n.messages)) ? n.messages : [];
              initCoachNotify(msgs);
            })
            .withFailureHandler(() => initCoachNotify([]))
            .getCoachNotifications(window.CURRENT_USER_NAME);

          // keep the rest of your init calls
          if (typeof refreshPresenceWidget === 'function') refreshPresenceWidget();
         
        })
        .withFailureHandler(() => {
          startPresencePings();
          document.getElementById("loginOverlay").style.display = "none";
          initCoachNotify([]); // still show the Visitor fallback if needed
        })
        .recordPresence(window.CURRENT_USER_NAME);
    })
    .withFailureHandler(() => { msg.textContent = 'Auth failed. Try again.'; })
    .validatePassword(pw);
};


function startPresencePings() {
  stopPresencePings();
  window._presencePingTimer = setInterval(() => {
    if (!window.CURRENT_USER_NAME) return;
    google.script.run.pingPresence(window.CURRENT_USER_NAME);
  }, 30000);
}
function stopPresencePings() {
  if (window._presencePingTimer) clearInterval(window._presencePingTimer);
  window._presencePingTimer = null;
}




// --- Player link flags ---
const QP = new URLSearchParams(location.search);
const IS_PLAYER = QP.get('mode') === 'player';          // /exec?mode=player
const PLAYER_KEY = 'PERISTERI2025';                     // optional secret
const KEY_OK = !QP.has('k') || QP.get('k') === PLAYER_KEY;


var _coachGeneral = []; // server + chat live here
function coachNotifyRebuild(resetIndex = true) {
  const general = (_coachGeneral || []).filter(Boolean);

  // Build: general → clip suggestions
  const combined = [...general, ...(_clipSuggestions || [])];

  // Deduplicate by origin+title+body
  const seen = new Set();
  _coachMsgs = combined.filter(m => {
    const key = `${m._origin}|${m.title}|${m.body}`;
    if (seen.has(key)) return false;
    seen.add(key);
    return true;
  });

  if (resetIndex) _coachIdx = 0;
  coachNotifyStartRotation();
}










// --- Coach Notify: early bootstrap (put this near the top of your <script>) ---
var _coachMsgs    = window._coachMsgs    || [];
var _coachIdx     = window._coachIdx     || 0;
var _coachInterval= window._coachInterval|| null;
var _coachBound   = window._coachBound   || false;

















/* -------------------- Clip state -------------------- */
let currentClipList = [];      // ordered list of clip URLs in current view
let currentClipIndex = -1;     // index into currentClipList of the open modal
let lastClipsData = [];        // cache rows for re-render
const selectedClipUrls = new Set();
let playerEmailMap = null;     // name -> email

const clipMetaByUrl = new Map();   // url -> { notes, player, theme, subTag, type, dateStr }
const clipNotesByUrl = new Map();  // url -> note string (local drafts)
const clipNoteDrafts = new Map();  // url -> note string (live typing)
let _homeSummaryLoaded = false;

let currentClipUrl = '';       // actively opened clip URL in modal

/* -------------------- Helpers for current clip -------------------- */
function getCurrentClipUrl() {
  if (Array.isArray(currentClipList) && currentClipIndex >= 0) {
    return currentClipList[currentClipIndex] || '';
  }
  return currentClipUrl || '';
}



function openReportLink(a) {
  const url = a && a.getAttribute('data-url');
  if (!url) return false;
  openReportModal(url);            // or: window.open(url, '_blank')
  return false;
}




// ---- RENDER ONE COACH NOTIFY CARD (missing piece) ----
function coachNotifyRenderOnce() {
  const box   = document.getElementById('coachNotify');
  const tEl   = document.getElementById('coachNotifyTitle');
  const bEl   = document.getElementById('coachNotifyText');
  const acts  = document.getElementById('coachNotifyActions');
  const prev  = document.getElementById('coachNotifyPrev');
  const next  = document.getElementById('coachNotifyNext');
  const close = document.getElementById('coachNotifyClose');

  if (!box || !_coachMsgs || !_coachMsgs.length || coachNotifyMuted()) {
    if (box) box.style.display = 'none';
    return;
  }

  // current message
  const m = _coachMsgs[_coachIdx] || { title:'', body:'', kind:'info', actions:[] };

  // fill content
  tEl.textContent = m.title || 'Notification';
  bEl.textContent = m.body  || '';

  // kind -> left border color
  applyKindBorder(m.kind);

  // actions
  acts.innerHTML = '';
  if (Array.isArray(m.actions) && m.actions.length) {
    m.actions.forEach(a => {
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.type = 'button';
      btn.textContent = a.label || 'Open';
      btn.onclick = () => _runAction(a);
      acts.appendChild(btn);
    });
  }

  // show
  box.style.display = 'block';

  // wire buttons once
  if (!_coachBound) {
    if (prev)  prev.onclick  = () => { _coachIdx = (_coachIdx - 1 + _coachMsgs.length) % _coachMsgs.length; coachNotifyRenderOnce(); };
    if (next)  next.onclick  = () => { _coachIdx = (_coachIdx + 1) % _coachMsgs.length; coachNotifyRenderOnce(); };
    if (close) close.onclick = () => coachNotifyHide();
    _coachBound = true;
  }
}







function maybeAddChatNotification(rows){
  try {
    const me = window.CURRENT_USER_NAME || '';
    const lastSeen = Number(localStorage.getItem('chatSeen:'+me) || 0);

    const unseen = (rows || []).filter(r =>
      Number(r.ts||0) > lastSeen &&
      String(r.from||'').toLowerCase() !== me.toLowerCase()
    );
    if (!unseen.length) return;

    const uniqSenders = Array.from(new Set(unseen.map(r => r.from)));
    const line = uniqSenders.length === 1
      ? `New chat message from ${uniqSenders[0]}`
      : `New chat messages from ${uniqSenders[0]} (+${uniqSenders.length - 1} others)`;

    // Normalize as a general/server card with an action to open Chat
    const msg = _normalizeMsg({
      title: 'Chat',
      body: line,
      kind: 'info',
      actions: [{ type:'gotoTab', label:'Open Chat', args:{ tab:'chat' } }]
    }, 'server');

    // Put at the front of the general bucket and rebuild feed
    _coachGeneral.unshift(msg);
    coachNotifyRebuild(false); // preserve current card index while rotating

  } catch(e) {
    console.warn('maybeAddChatNotification error', e);
  }
}


function maybePushClipSuggestions(rows){
  try {
    if (!Array.isArray(rows) || !rows.length) return;

    const newCards = [];

    // 1) Newest clip
    const newest = rows[0];
    const url = (newest.link || newest.url || '').trim();
    if (url) {
      const line = [newest.player, newest.theme, newest.subTag, newest.type].filter(Boolean).join(' — ');
      const body = (newest.notes || line || 'New clip').toString();
      newCards.push(_normalizeMsg({
        title: 'New clip added',
        body,
        kind: 'info',
        actions: [
          { type: 'openClip', label: 'Open clip', args: { url } },
          { type: 'gotoClipsFilter', label: 'Filter player+theme', args: { player: newest.player || '', theme: newest.theme || '' } }
        ]
      }, 'clip'));
    }

    // 2) Trending theme
    const themeCount = {};
    rows.forEach(r => {
      const t = (r.theme || '').trim();
      if (t) themeCount[t] = (themeCount[t] || 0) + 1;
    });
    const topTheme = Object.keys(themeCount).sort((a,b)=>themeCount[b]-themeCount[a])[0];
    if (topTheme) {
      newCards.push(_normalizeMsg({
        title: 'Trending theme',
        body: `${topTheme} appears ${themeCount[topTheme]} time(s) in your current clips.`,
        kind: 'success',
        actions: [{ type: 'gotoClipsFilter', label: `See ${topTheme}`, args: { theme: topTheme } }]
      }, 'clip'));
    }

    // 3) Quick view
    newCards.push(_normalizeMsg({
      title: 'Quick view',
      body: 'Jump to the newest clips with your current filters.',
      kind: 'info',
      actions: [{ type: 'gotoTab', label: 'Open Clips', args: { tab: 'clips' } }]
    }, 'clip'));

    // Append suggestions and rebuild greeting → general → clips
    _clipSuggestions.push(...newCards);
    coachNotifyRebuild(false);

  } catch (e) {
    console.warn('maybePushClipSuggestions error', e);
  }
}
















/* -------------------- Modal controls + notes -------------------- */
function setClipControlsFor(url) {
  const btn   = document.getElementById('clipSelectBtn');
  const badge = document.getElementById('clipSelectedBadge');
  const note  = document.getElementById('clipNoteInput');
  const hint  = document.getElementById('clipSelHint');

  if (!btn || !badge || !note) return;

  const isSelected = selectedClipUrls.has(url);
  btn.textContent = isSelected ? 'Deselect clip' : 'Select clip';
  badge.style.display = isSelected ? 'inline-block' : 'none';

  // Populate note input (draft > meta.notes > local draft map > empty)
  const draft = clipNoteDrafts.get(url);
  const meta  = clipMetaByUrl.get(url) || {};
  note.value  = (draft != null) ? draft
               : (meta.notes || clipNotesByUrl.get(url) || '');

  // Progress hint
  if (hint) {
    const total = currentClipList.length;
    const idx   = Math.max(0, currentClipIndex) + 1;
    hint.textContent = total ? `${idx}/${total} • Sel: ${selectedClipUrls.size}` : '';
  }
}

function toggleSelectCurrentClip() {
  const url = getCurrentClipUrl();
  if (!url) return;
  if (selectedClipUrls.has(url)) selectedClipUrls.delete(url);
  else                           selectedClipUrls.add(url);
  setClipControlsFor(url);
}

function onClipNoteInput(e) {
  const url = getCurrentClipUrl();
  if (!url) return;
  const v = e.target.value || '';
  clipNoteDrafts.set(url, v);

  // Mirror into meta so Create Summary sees latest notes immediately
  const meta = clipMetaByUrl.get(url) || {};
  meta.notes = v;
  clipMetaByUrl.set(url, meta);
}

function saveClipNoteFromFooter() {
  const url   = getCurrentClipUrl() || currentClipUrl || '';
  const noteEl = document.getElementById('clipNoteInput');
  const msgEl  = document.getElementById('clipNoteMsg');
  const btn    = document.getElementById('clipNoteSaveBtn');

  if (!url) { if (msgEl) msgEl.textContent = 'No clip URL.'; return; }

  const text = (noteEl?.value || '').trim();
  if (!text) { if (msgEl) msgEl.textContent = 'Type a note first.'; return; }

  // Keep local caches in sync so Create Summary immediately sees the note
  clipNoteDrafts.set(url, text);
  clipNotesByUrl.set(url, text);
  const meta = clipMetaByUrl.get(url) || {};
  meta.notes = text;
  clipMetaByUrl.set(url, meta);

  if (msgEl) msgEl.textContent = 'Saving…';
  if (btn) btn.disabled = true;

  google.script.run
    .withSuccessHandler(res => {
      if (btn) btn.disabled = false;
      if (res && res.ok) {
        if (msgEl) msgEl.textContent = 'Saved ✅';
      } else {
        const err = (res && (res.error || res.message)) || 'Save failed.';
        if (msgEl) msgEl.textContent = err;
        console.error('saveClipNote → server error:', res);
      }
    })
    .withFailureHandler(err => {
      if (btn) btn.disabled = false;
      if (msgEl) msgEl.textContent = 'Save failed.';
      console.error('saveClipNote → transport error:', err);
    })
    // If your Apps Script expects a different shape, adjust keys here:
    .saveClipNote({ url, note: text, coach: '' });
}

function loadClipNotes(url) {
  if (!url) {
    const host = document.getElementById('clipNotesList');
    if (host) host.textContent = 'No clip URL.';
    return;
  }
  google.script.run
    .withSuccessHandler(res => {
      const host = document.getElementById('clipNotesList');
      if (!host) return;
      host.innerHTML = '';
      if (!res || !res.ok || !Array.isArray(res.rows) || !res.rows.length) {
        host.textContent = 'No notes yet.';
        host.classList.add('muted');
        return;
      }
      const frag = document.createDocumentFragment();
      res.rows.forEach(r => {
        const div = document.createElement('div');
        div.style.borderBottom = '1px dashed #2a3448';
        div.style.padding = '6px 0';
        const head = document.createElement('div');
        head.className = 'muted';
        head.textContent = `${r.date || ''}${r.coach ? ' — ' + r.coach : ''}`;
        const body = document.createElement('div');
        body.textContent = r.note || '';
        div.appendChild(head);
        div.appendChild(body);
        frag.appendChild(div);
      });
      host.classList.remove('muted');
      host.appendChild(frag);
    })
    .withFailureHandler(err => {
      console.error('getClipNotes failed', err);
      const host = document.getElementById('clipNotesList');
      if (host) {
        host.textContent = 'Failed to load notes.';
        host.classList.add('muted');
      }
    })
    .getClipNotes(url);
}



// Parse a window from notes text, e.g. "s=90 e=118", "start 1:30 end 1:58", "1:30–1:58"
function parseNotesWindowSeconds_(txt){
  const s = String(txt || '').toLowerCase();

  // s=90 e=118  OR  start=90 end=118
  let m = s.match(/(?:\bs(?:tart)?\s*[:=]\s*)(\d+)\D+(?:\be(?:nd)?\s*[:=]\s*)(\d+)/);
  if (m) return { start: Number(m[1]), end: Number(m[2]) };

  // start 1:30 end 1:58  (mm:ss or h:mm:ss)
  m = s.match(/start\s+(\d{1,2}:\d{2}(?::\d{2})?)\D+end\s+(\d{1,2}:\d{2}(?::\d{2})?)/);
  if (m) return { start: hmsToSec_(m[1]), end: hmsToSec_(m[2]) };

  // 1:30–1:58  or  1:30-1:58
  m = s.match(/(\d{1,2}:\d{2}(?::\d{2})?)\s*[–-]\s*(\d{1,2}:\d{2}(?::\d{2})?)/);
  if (m) return { start: hmsToSec_(m[1]), end: hmsToSec_(m[2]) };

  // 90-118s
  m = s.match(/\b(\d+)\s*[-–]\s*(\d+)\s*s\b/);
  if (m) return { start: Number(m[1]), end: Number(m[2]) };

  // just "e=118" (end only)
  m = s.match(/\be(?:nd)?\s*[:=]\s*(\d+)\b/);
  if (m) return { start: null, end: Number(m[1]) };

  return null;
}
function hmsToSec_(str){
  const p = str.split(':').map(Number);
  if (p.length === 3) return p[0]*3600 + p[1]*60 + p[2];
  if (p.length === 2) return p[0]*60 + p[1];
  return Number(str)||0;
}



/* -------------------- Video modal nav -------------------- */
function openClipModal(url, index=undefined) {
  const modal  = document.getElementById('clipModal');
  const frame  = document.getElementById('clipFrame');

  if (typeof index === 'number') currentClipIndex = index;
  else currentClipIndex = currentClipList.indexOf(url);

  currentClipUrl = url;

  // Clean previous timers/toasts
  if (_ytEndTimeout) { clearTimeout(_ytEndTimeout); _ytEndTimeout = null; }
  clearYtToast_();

  const srcType = detectSource_(url);
 const meta = clipMetaByUrl.get(url) || {};

// Prefer column I “times”; fallback to parsing notes
const winFromTimes = parseTimesWindowSeconds_(meta.times || '');
const winFromNotes = parseNotesWindowSeconds_(meta.notes || '');
const win = winFromTimes || winFromNotes;

// Start/end seconds
const startSecFromUrl = getYouTubeStartSeconds_(url) || 0;
const startSec = (win && win.start != null) ? Math.max(startSecFromUrl, win.start) : startSecFromUrl;
const endSec   = (win && win.end   != null) ? win.end : null;

  // Build embed (no end param; we just show a toast)
  const embed = normalizeEmbedUrl(url, /*autoplay*/ srcType === 'youtube');
  frame.src = embed;
  modal.style.display = 'flex';

  // Schedule toast at end (YouTube only, and only if we know end > start)
  if (srcType === 'youtube' && endSec != null && endSec > startSec) {
    const ms = Math.max(200, Math.round((endSec - startSec) * 1000));
    _ytEndTimeout = setTimeout(() => {
      showYtToast_('End of tagged clip');
      // Optional: auto-advance after the toast
      // setTimeout(() => nextClip(), 800);
    }, ms);
  }

  setClipControlsFor(url);
}

function closeClipModal() {
  const modal = document.getElementById('clipModal');
  const frame = document.getElementById('clipFrame');
  frame.src = '';
  modal.style.display = 'none';

  if (_ytEndTimeout) { clearTimeout(_ytEndTimeout); _ytEndTimeout = null; }
  clearYtToast_();
}

function nextClip() {
  if (currentClipList.length < 2) return;
  currentClipIndex = (currentClipIndex + 1) % currentClipList.length;
  const url = currentClipList[currentClipIndex];
  openClipModal(url, currentClipIndex);
}

function prevClip() {
  if (currentClipList.length < 2) return;
  currentClipIndex = (currentClipIndex - 1 + currentClipList.length) % currentClipList.length;
  const url = currentClipList[currentClipIndex];
  openClipModal(url, currentClipIndex);
}









function detectSource_(url){
  const u = String(url||'');
  if (/youtu\.be|youtube\.com/i.test(u)) return 'youtube';
  if (/vimeo\.com/i.test(u))            return 'vimeo';
  if (/drive\.google\.com|docs\.google\.com/i.test(u)) return 'drive';
  return 'other';
}






// Parse start seconds from YouTube URLs: ?t=90, ?start=90, or #t=1m30s
function getYouTubeStartSeconds_(u) {
  try {
    const s = String(u || '');

    // query params
    const q = s.includes('?') ? s.split('?')[1].split('#')[0] : '';
    const params = new URLSearchParams(q);
    let t = params.get('t') || params.get('start') || '';

    // fragment
    if (!t && s.includes('#')) {
      const frag = s.split('#')[1] || '';
      const fparams = new URLSearchParams(frag.replace(/&/g,'&'));
      t = fparams.get('t') || fparams.get('start') || '';
    }
    if (!t) return 0;

    // plain seconds?
    const num = parseInt(t, 10);
    if (!isNaN(num)) return Math.max(0, num);

    // 1h2m3s style
    const m = /(?:(\d+)h)?(?:(\d+)m)?(?:(\d+)s)?/i.exec(t) || [];
    const h = parseInt(m[1] || '0', 10) || 0;
    const mn= parseInt(m[2] || '0', 10) || 0;
    const sc= parseInt(m[3] || '0', 10) || 0;
    const total = h*3600 + mn*60 + sc;
    return Math.max(0, total);
  } catch (_) {
    return 0;
  }
}













/* -------------------- URL normalizer -------------------- */
function normalizeEmbedUrl(url, autoplay) {
  var u = String(url || '').trim();
  var m;

  function addParams(base, params) {
    var hasQ = base.indexOf('?') !== -1;
    var qs = [];
    for (var k in params) if (Object.prototype.hasOwnProperty.call(params, k)) {
      qs.push(encodeURIComponent(k) + '=' + encodeURIComponent(params[k]));
    }
    return qs.length ? base + (hasQ ? '&' : '?') + qs.join('&') : base;
  }

  // Google Drive
  m = u.match(/drive\.google\.com\/file\/d\/([^/]+)/i);
  if (m) return 'https://drive.google.com/file/d/' + m[1] + '/preview';
  m = u.match(/[?&]id=([-\w]{20,})/i);
  if (m && /(drive|docs)\.google\.com/i.test(u)) return 'https://drive.google.com/file/d/' + m[1] + '/preview';
  if (/drive\.google\.com/i.test(u) && u.indexOf('/view') !== -1) return u.replace('/view', '/preview');

  // YouTube (force inline, no cookie domain)
// YouTube (force inline, no cookie domain)
m = u.match(/(?:youtu\.be\/|v=|embed\/)([A-Za-z0-9_-]{6,})/i);
if (m) {
  var base = 'https://www.youtube-nocookie.com/embed/' + m[1];
  var params = {
    autoplay: autoplay ? 1 : 0,
    mute: autoplay ? 1 : 0,
    playsinline: 1,
    rel: 0,
    modestbranding: 1
  };
  // carry over ?t= / ?start= / #t=...
  var startFromUrl = getYouTubeStartSeconds_(u);
  if (startFromUrl > 0) params.start = startFromUrl;

  try { params.origin = location.origin; } catch(e) {}
  return addParams(base, params);
}

  // Vimeo
  m = u.match(/vimeo\.com\/(?:video\/)?(\d+)/i);
  if (m) {
    var vbase = 'https://player.vimeo.com/video/' + m[1];
    return addParams(vbase, { autoplay: autoplay ? 1 : 0, muted: autoplay ? 1 : 0 });
  }

  return u;
}

/* -------------------- Keyboard shortcuts in modal -------------------- */
document.addEventListener('keydown', (e) => {
  const modal = document.getElementById('clipModal');
  if (!modal || modal.style.display === 'none') return;

  if (e.key === 'ArrowRight') { e.preventDefault(); nextClip(); }
  if (e.key === 'ArrowLeft')  { e.preventDefault(); prevClip(); }
  if (e.key === 'Escape')     { e.preventDefault(); closeClipModal(); }
});

/* -------------------- Tabs -------------------- */
document.querySelectorAll('.tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    document.getElementById('panel-' + t.dataset.tab).classList.add('active');

    if (t.dataset.tab === 'dailyratings') ensureNotesIndex(() => loadRatings(true));
    if (t.dataset.tab === 'traitratings') loadTraitRatings();
    if (t.dataset.tab === 'home')         loadTeamRatings();
   
    if (t.dataset.tab === 'summaries')    loadSummaries();
    if (t.dataset.tab === 'chat')         { initChatUI(); refreshChat(); }
    if (t.dataset.tab === 'opponents')    loadOpponents();
    if (t.dataset.tab === 'strength')   loadPracticeLoad();
  });
});

/* -------------------- Init -------------------- 
window.addEventListener('load', () => {
  ensureNotesIndex(ok => console.log('notes index loaded at boot?', ok));
  loadFlags();
  loadTeamRatings();
  loadTeam();
  loadPlayers();
  loadClipFilters();
});*/


window.addEventListener('load', () => {
  if (IS_LOCAL_PREVIEW) {
    const preview = document.createElement('div');
    preview.className = 'hero';
    preview.innerHTML = `
      <h2 class="hero-title">Live preview unavailable</h2>
      <div class="muted" style="max-width:480px; text-align:center;">
        This dashboard needs its Google Apps Script backend. Deploy and open the web app, or provide mock data before using a local server.
      </div>`;
    document.body.innerHTML = '';
    document.body.appendChild(preview);
    return;
  }

  if (IS_PLAYER && KEY_OK) {
    enablePlayerMode();
  } else if (IS_PLAYER && !KEY_OK) {
    // Wrong/missing key → simple message; nothing else loads
    document.body.innerHTML = `
      <div class="hero"><h2 class="hero-title">Access denied</h2>
      <div class="muted">Invalid link key.</div></div>`;
  } else {
    // Normal coach flow
    document.getElementById("loginOverlay").style.display = "flex";
    ensureNotesIndex(() => {});
    loadHomeSummary();
    loadPlayers();
    loadClipFilters();
    loadPracticeLoad();
  }
});

function enablePlayerMode() {
  document.body.classList.add('player-only');

  // Hide the login overlay if found
  const overlay = document.getElementById("loginOverlay");
  if (overlay) overlay.style.display = "none";

  // Hide all tabs + panels
  document.querySelectorAll('.tab').forEach(tab => tab.style.display = 'none');
  document.querySelectorAll('.panel').forEach(panel => {
    panel.style.display = 'none';
    panel.classList.remove('active');
  });

  // Show only the Opponents panel
  const oppTab = document.querySelector('.tab[data-tab="opponents"]');
  const oppPanel = document.getElementById('panel-opponents');
  if (oppTab) oppTab.classList.add('active');           // cosmetic only (tabs are hidden by CSS)
  if (oppPanel) { oppPanel.style.display = 'block'; oppPanel.classList.add('active'); }

  // Hide coach-only floating UI (just in case)
  document.getElementById('presenceWidget')?.style?.setProperty('display','none');
  document.getElementById('coachNotify')?.style?.setProperty('display','none');

  // 🔑 actually fetch the data for the player!
  loadOpponents();

  // If anything else needs the role:
  window.CURRENT_USER_ROLE = "player";
}




/* -------------------- TEAM -------------------- */
function loadTeam(force = false) {
  if (!force && dataCache.teamTrend) renderTeam(dataCache.teamTrend);
  if (!force && dataCache.themeCounts) renderThemeChips(dataCache.themeCounts);
  if (!force && dataCache.teamTrend && dataCache.themeCounts) return;

  google.script.run
    .withSuccessHandler(team => {
      dataCache.teamTrend = team;
      renderTeam(team);
    })
    .withFailureHandler(err => {
      console.error('Team trend error:', err);
      renderTeam(null);
    })
    .getTeamTrend();

  google.script.run
    .withSuccessHandler(map => {
      const counts = map || {};
      dataCache.themeCounts = counts;
      renderThemeChips(counts);
    })
    .withFailureHandler(err => {
      console.error('Theme chips error:', err);
      renderThemeChips({});
    })
    .getThemeCountsLast7d();
}
function renderTeam(team) {
  const box = document.getElementById('teamBox');
  box.innerHTML = '';
  const mk = (title, body) => {
    const d = document.createElement('div');
    d.className = 'card';
    d.innerHTML = `<div class="sectionTitle">${title}</div>${body ? `<div>${body.replace(/\n/g,'<br>')}</div>` : '<div class="muted">—</div>'}`;
    return d;
  };
  if (!team) {
    box.innerHTML = `<div class="empty">No reliable team trend for the last 7 days.</div>`;
    return;
  }
  box.appendChild(mk('Summary', team.summary || ''));
  box.appendChild(mk('Positives', bullets(team.positives)));
  box.appendChild(mk('Concerns', bullets(team.concerns)));
  box.appendChild(mk('Suggested Focus', bullets(team.focus)));
}
function renderThemeChips(map) {
  const box = document.getElementById('themeChips');
  box.innerHTML = '';
  if (!map || !Object.keys(map).length) {
    box.innerHTML = `<div class="muted">No clip themes in the last 7 days.</div>`;
    return;
  }
  Object.keys(map).sort((a,b)=>map[b]-map[a]).forEach(k => {
    const s = document.createElement('span');
    s.className = 'tag';
    s.textContent = `${k} (${map[k]})`;
    box.appendChild(s);
  });
}

/* -------------------- RATINGS -------------------- */
let ratingsLoadedOnce = false;
let removeRatingsHoverListeners = null;
function loadRatings(force = false) {
  if (ratingsLoadedOnce && !force) return;
  ratingsLoadedOnce = true;
  google.script.run
    .withSuccessHandler(renderRatings)
    .withFailureHandler(err => {
      console.error('Ratings error:', err);
      const host = document.querySelector('#panel-dailyratings');
      if (host) host.insertAdjacentHTML('beforeend', `<div class="empty">Failed to load ratings.</div>`);
    })
    .getRatingsGrid();
}




function renderRatings(data) {
  // Warm the index while we render (no-op if already loaded)
  ensureNotesIndex();

  if (!data || !data.ok) {
    document.querySelector('#panel-dailyratings')?.insertAdjacentHTML('beforeend',
      `<div class="empty">No ratings grid available.</div>`);
    return;
  }

  const thead = document.querySelector('#ratingsTable thead');
  const tbody = document.querySelector('#ratingsTable tbody');
  thead.innerHTML = '';
  tbody.innerHTML = '';

  const headers = data.headers || [];
  const rows = data.rows || [];

  // If your sheet has two leading "Date" columns, keep both as labels.
  const labelCols = (headers.length >= 2 && String(headers[1]).trim().toLowerCase() === 'date') ? 2 : 1;

  // if there are 2 label columns, the second one (index 1) is the Date
  const dateColIndex = (labelCols === 2 ? 1 : 0);

  // Build header
  const trh = document.createElement('tr');
  headers.forEach((h, i) => {
    const th = document.createElement('th');
    th.textContent = h || (i < labelCols ? 'Label' : `Col ${i+1}`);
    if (i < labelCols) th.classList.add('stickyLeft');
    trh.appendChild(th);
  });
  thead.appendChild(trh);

  // Pre-extract the player names from headers (for i >= labelCols)
  const playersByCol = headers.map((h, i) => i >= labelCols ? String(h || '').trim() : '');

  // Compute min/max across numeric cells (exclude label columns)
  let min = Infinity, max = -Infinity;
  rows.forEach(r => {
    for (let i = labelCols; i < r.length; i++) {
      const val = parseFloat(String(r[i]).replace(',', '.'));
      if (!isNaN(val)) {
        if (val < min) min = val;
        if (val > max) max = val;
      }
    }
  });
  if (!isFinite(min) || !isFinite(max)) { min = 0; max = 5; }

  // tooltip helpers
  const tip = document.getElementById('notesTooltip');
  function hideTip() { if (tip) tip.style.display = 'none'; }
  function showTip(html, x, y) {
    if (!tip) return;
    tip.innerHTML = html;
    tip.style.display = 'block';
    const pad = 12;
    const vw = window.innerWidth, vh = window.innerHeight;
    const rect = tip.getBoundingClientRect();
    let left = x + pad, top = y + pad;
    if (left + rect.width > vw - 8) left = x - rect.width - pad;
    if (top + rect.height > vh - 8) top = y - rect.height - pad;
    tip.style.left = Math.max(8, left) + 'px';
    tip.style.top  = Math.max(8, top)  + 'px';
  }

  // --- replace your makeNotesHtml with this ---
  function makeNotesHtml(dateStr, playerName) {
    if (!dateStr || !playerName) return '<div class="muted">No notes</div>';
    if (!_notesIndex) return '<div class="muted">Loading…</div>';

    const pkey = String(playerName).trim().toLowerCase();

    // Build possible date strings from the label like "20-Aug ( Team Practice )"
    const dateCandidates = buildDateCandidates(dateStr);

    // Try each candidate to find a match in the index
    let found = null;
    for (const ds of dateCandidates) {
      const key = `${ds}|${pkey}`;
      if (_notesIndex[key] && _notesIndex[key].length) {
        found = _notesIndex[key];
        break;
      }
    }

    if (found) {
      return found.map(n => {
        const head = [n.coach, n.session].filter(Boolean).join(' — ');
        return `
          <div style="border-bottom:1px dashed #2a3448; padding:6px 0;">
            <div class="muted" style="margin-bottom:4px;">${escapeHtml(head)}</div>
            <div>${escapeHtml(n.note)}</div>
          </div>`;
      }).join('');
    }

    // If nothing found
    return '<div class="muted">No notes</div>';
  }

  // --- helpers for date normalization ---
  const __MONTHS = { jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12 };
  function pad2(n){ n = Number(n); return (n<10 ? '0'+n : ''+n); }

  // Extract all years we’ve seen in _notesIndex (so we can try them)
  function getYearsFromIndex(){
    if (!_notesIndex) return [];
    const years = new Set();
    Object.keys(_notesIndex).forEach(k => {
      // k is like "dd/MM/yyyy|player" or "d MMM yyyy|player" or "d/M/yy|player"
      const datePart = k.split('|')[0] || '';
      // try dd/MM/yyyy
      const m1 = datePart.match(/^\d{1,2}\/\d{1,2}\/(\d{2,4})$/);
      if (m1) { years.add(m1[1].length === 2 ? ('20'+m1[1]) : m1[1]); return; }
      // try d MMM yyyy
      const m2 = datePart.match(/^\d{1,2}\s+[A-Za-z]{3}\s+(\d{4})$/);
      if (m2) { years.add(m2[1]); return; }
    });
    // return newest-first so we try the most recent season first
    return Array.from(years).map(Number).sort((a,b)=>b-a).map(String);
  }

  // Turn "20-Aug ( Team Practice )" into various date strings that match the index keys
  function buildDateCandidates(raw){
    if (!raw) return [];
    // strip parenthetical "( ... )"
    let s = String(raw).replace(/\(.*?\)/g, '').trim(); // "20-Aug"
    // also strip trailing/leading extra spaces
    s = s.replace(/\s+/g, ' ').trim();

    const candidates = new Set();
    const years = getYearsFromIndex();  // e.g., ["2025","2024"]

    // If the rating table sometimes already shows a full date, keep that as first try
    candidates.add(s);

    // Pattern: 20-Aug or 9-Sep
    let m = s.match(/^(\d{1,2})[-\s]([A-Za-z]{3})$/);
    if (m) {
      const d = Number(m[1]);
      const mon = (__MONTHS[m[2].toLowerCase()]||0);
      if (mon && d>=1 && d<=31 && years.length) {
        years.forEach(Y => {
          const dd = pad2(d), mm = pad2(mon);
          // Build the 3 formats we inserted in the index on server:
          candidates.add(`${dd}/${mm}/${Y}`);         // dd/MM/yyyy
          candidates.add(`${d}/${mon}/${String(Y).slice(-2)}`); // d/M/yy
          // month name
          const monName = m[2].charAt(0).toUpperCase()+m[2].slice(1,3).toLowerCase();
          candidates.add(`${d} ${monName} ${Y}`);     // d MMM yyyy
        });
      }
    }

    // If the label is already a d MMM form without year, e.g., "20 Aug"
    m = s.match(/^(\d{1,2})\s+([A-Za-z]{3})$/);
    if (m && years.length) {
      const d = Number(m[1]); const monAbbr = m[2];
      const mon = (__MONTHS[monAbbr.toLowerCase()]||0);
      if (mon) {
        years.forEach(Y => {
          const dd = pad2(d), mm = pad2(mon);
          candidates.add(`${dd}/${mm}/${Y}`);
          candidates.add(`${d}/${mon}/${String(Y).slice(-2)}`);
          const monName = monAbbr.charAt(0).toUpperCase()+monAbbr.slice(1,3).toLowerCase();
          candidates.add(`${d} ${monName} ${Y}`);
        });
      }
    }

    return Array.from(candidates);
  }

 






/* -------------------- Schedule (client) -------------------- */

/* make the flag global-safe (won't redeclare if script re-injected) */
window._scheduleLoaded = window._scheduleLoaded || false;

/* EXPOSE globally */
window.loadSchedule = function loadSchedule(force=false){
  if (window._scheduleLoaded && !force) return;
  const box = document.getElementById('scheduleList');
  if (box) box.textContent = 'Loading…';

  google.script.run
    .withSuccessHandler(res => {
      if (!res || !res.ok) {
        if (box) box.textContent = (res && res.error) ? res.error : 'Failed to load schedule.';
        return;
      }
      window.renderSchedule(res.games || []);
      window._scheduleLoaded = true;
    })
    .withFailureHandler(err => {
      if (box) box.textContent = 'Failed to load schedule.';
      console.error('getSchedule error:', err);
    })
    .getSchedule();
};

window.renderSchedule = function renderSchedule(games){
  const list = document.getElementById('scheduleList');
  if (!list) return;

  if (!games.length) {
    list.innerHTML = '<div class="muted">No games found.</div>';
    return;
  }

  const rows = games.map(g => {
    const date = g.dateStr || '';
    const time = g.timeStr ? ` • ${g.timeStr}` : '';
    const ha   = g.homeAway === 'A' ? '@' : 'vs';
    const res  = g.status === 'final' ? (g.result || '') : 'Preview';
    const comp = g.competition ? `<div class="muted" style="font-size:12px;">${g.competition}</div>` : '';
    const arena= g.arena ? `<div class="muted" style="font-size:12px;">${g.arena}</div>` : '';
    const ppp  = (g.pppUs!=null || g.pppThem!=null)
      ? `<span class="tag" title="Points per Possession">${g.pppUs!=null?g.pppUs:'—'} - ${g.pppThem!=null?g.pppThem:'—'}</span>`
      : '';

    return `
      <div style="display:flex; gap:10px; align-items:flex-start; padding:8px 0; border-bottom:1px dashed var(--border);">
        <div style="min-width:180px;">
          <div style="font-weight:600;">${date}${time}</div>
          ${comp}${arena}
        </div>
        <div style="flex:1;">
          <div><b>${ha}</b> ${escapeHtml(g.opponent || '')}</div>
          <div class="muted" style="font-size:12px;">${escapeHtml(g.record || '')}</div>
        </div>
        <div style="min-width:140px; text-align:right;">
          <div>${resHtml}</div>
          <div>${ppp}</div>
        </div>
      </div>
    `;
  }).join('');

  list.innerHTML = rows;
};

/* keep your existing listeners — they’ll now call the global versions */
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.tab[data-tab="team"]');
  if (btn) setTimeout(() => window.loadSchedule(), 0);
});
document.addEventListener('DOMContentLoaded', () => {
  const active = document.querySelector('.tab.active[data-tab="team"]');
  if (active) window.loadSchedule();
});

/* helper */
function escapeHtml(s){
  return String(s||'')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}















  // Build body
  const fragment = document.createDocumentFragment();
  rows.forEach(r => {
    const tr = document.createElement('tr');
    const dateLabel = String(r[dateColIndex] || '').trim();

    r.forEach((cell, i) => {
      const td = document.createElement('td');

      if (i < labelCols) {
        td.textContent = cell || '';
        td.classList.add('stickyLeft');
      } else {
        const val = parseFloat(String(cell).replace(',', '.'));
        if (!isNaN(val)) {
          td.textContent = val.toFixed(2);
          td.classList.add('num');
          td.style.background = colorFor(val, min, max);
        } else {
          td.textContent = '';
        }

        const playerName = playersByCol[i];
        if (playerName) {
          td.dataset.date = dateLabel;
          td.dataset.player = playerName;
        }
      }

      tr.appendChild(td);
    });
    fragment.appendChild(tr);
  });
  tbody.appendChild(fragment);

  installRatingsHover(tbody, makeNotesHtml, showTip, hideTip);

  document.getElementById('ratingsLegend').textContent =
    `Scale based on min=${min.toFixed(2)}, max=${max.toFixed(2)} from visible data.`;
}



function colorFor(v, min, max) {
  if (max <= min) return 'transparent';
  const t = (v - min) / (max - min);
  const hue = 120 * t;
  return `hsl(${hue}, 70%, 30%)`;
}

function installRatingsHover(tbody, makeNotesHtml, showTip, hideTip) {
  if (removeRatingsHoverListeners) {
    removeRatingsHoverListeners();
    removeRatingsHoverListeners = null;
  }
  if (!tbody) return;

  let currentCell = null;
  let hoverToken = 0;
  let lastPointerX = 0;
  let lastPointerY = 0;

  const getCell = (evt) => {
    const cell = evt.target.closest('td[data-player]');
    return cell && tbody.contains(cell) ? cell : null;
  };

  const handleOver = (evt) => {
    const cell = getCell(evt);
    if (!cell || cell === currentCell) return;
    currentCell = cell;
    const token = ++hoverToken;
    lastPointerX = evt.clientX;
    lastPointerY = evt.clientY;

    const renderNotes = () => {
      if (!currentCell || token !== hoverToken) return;
      const html = makeNotesHtml(currentCell.dataset.date, currentCell.dataset.player);
      showTip(html, lastPointerX, lastPointerY);
    };

    if (_notesIndexLoaded) {
      renderNotes();
    } else {
      showTip('<div class="muted">Loading…</div>', lastPointerX, lastPointerY);
      ensureNotesIndex(renderNotes);
    }
  };

  const handleMove = (evt) => {
    lastPointerX = evt.clientX;
    lastPointerY = evt.clientY;
    const cell = getCell(evt);
    if (!cell) {
      handleTableLeave();
      return;
    }
    if (cell !== currentCell) {
      handleOver(evt);
      return;
    }
    const html = _notesIndexLoaded
      ? makeNotesHtml(cell.dataset.date, cell.dataset.player)
      : '<div class="muted">Loading…</div>';
    showTip(html, lastPointerX, lastPointerY);
  };

  const handleOut = (evt) => {
    const cell = evt.target.closest('td[data-player]');
    if (!cell || cell !== currentCell) return;
    const nextCell = evt.relatedTarget ? evt.relatedTarget.closest('td[data-player]') : null;
    if (nextCell === currentCell) return;
    currentCell = null;
    hoverToken++;
    hideTip();
  };

  const handleTableLeave = () => {
    if (!currentCell) return;
    currentCell = null;
    hoverToken++;
    hideTip();
  };

  tbody.addEventListener('mouseover', handleOver);
  tbody.addEventListener('mousemove', handleMove);
  tbody.addEventListener('mouseout', handleOut);
  tbody.addEventListener('mouseleave', handleTableLeave);

  removeRatingsHoverListeners = () => {
    tbody.removeEventListener('mouseover', handleOver);
    tbody.removeEventListener('mousemove', handleMove);
    tbody.removeEventListener('mouseout', handleOut);
    tbody.removeEventListener('mouseleave', handleTableLeave);
  };
}

/* -------------------- PLAYERS -------------------- */
function populatePlayerSelect(sel, list) {
  if (!sel) return;
  if (!Array.isArray(list) || !list.length) {
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = 'No players';
    sel.replaceChildren(opt);
    return;
  }
  const frag = document.createDocumentFragment();
  list.forEach(name => {
    if (!name) return;
    const opt = document.createElement('option');
    opt.value = opt.textContent = name;
    frag.appendChild(opt);
  });
  sel.replaceChildren(frag);
}

function loadPlayers(force = false) {
  const sel = document.getElementById('playerSelect');
  if (!sel) return;

  const cached = Array.isArray(dataCache.playersList) ? dataCache.playersList : null;
  if (!force && cached && cached.length) {
    if (!sel.options.length) populatePlayerSelect(sel, cached);
    if (!sel.value && cached.length) {
      sel.value = cached[0];
      onPlayerChange(sel.value);
    }
    return;
  }

  google.script.run
    .withSuccessHandler(list => {
      const arr = Array.isArray(list) ? list.filter(Boolean) : [];
      dataCache.playersList = arr;
      populatePlayerSelect(sel, arr);
      if (arr.length) {
        if (!sel.value) sel.value = arr[0];
        onPlayerChange(sel.value || arr[0]);
      } else {
        onPlayerChange('');
      }
    })
    .withFailureHandler(err => {
      console.error('getPlayers error:', err);
      populatePlayerSelect(sel, []);
    })
    .getPlayers();
}

function updatePlayerPhoto(url) {
  const img = document.getElementById('playerPhoto');
  if (!img) return;
  if (url) {
    if (img.src !== url) img.src = url;
    img.style.display = 'block';
  } else {
    img.removeAttribute('src');
    img.style.display = 'none';
  }
}

function onPlayerChange(name, opts) {
  const force = opts === true || (opts && typeof opts === 'object' && opts.force);
  if (!name) {
    updatePlayerPhoto('');
    renderPlayer(null);
    renderCoachRatings(null);
    renderPlayerClips([]);
    return;
  }

  if (!force && playerDataCache.bundle.has(name)) {
    applyPlayerBundle(name, playerDataCache.bundle.get(name));
    return;
  }

  google.script.run
    .withSuccessHandler(res => {
      if (!res || !res.ok) {
        console.error('getPlayerBundle error:', res && res.error);
        applyPlayerBundle(name, null);
        return;
      }
      playerDataCache.bundle.set(name, res);
      applyPlayerBundle(name, res);
    })
    .withFailureHandler(err => {
      console.error('getPlayerBundle error:', err);
      applyPlayerBundle(name, null);
    })
    .getPlayerBundle(name, 6);
}

function applyPlayerBundle(name, bundle){
  if (!bundle || !bundle.ok) {
    updatePlayerPhoto('');
    renderPlayer(null);
    renderCoachRatings(null);
    renderPlayerClips([]);
    return;
  }
  const photoUrl = bundle.photoUrl || '';
  updatePlayerPhoto(photoUrl);
  playerDataCache.photo.set(name, photoUrl);

  renderPlayer(bundle.detail || null);
  playerDataCache.detail.set(name, bundle.detail || null);

  renderCoachRatings(bundle.coachRatings || null);
  playerDataCache.coachRatings.set(name, bundle.coachRatings || null);

  const clips = Array.isArray(bundle.clips) ? bundle.clips : [];
  renderPlayerClips(clips);
  playerDataCache.clips.set(name, clips);
}

function renderCoachRatings(data) {
  const box = document.getElementById('pCoachRatings');
  box.classList.remove('muted');
  box.innerHTML = '';

  if (!data || !data.ok || !data.rows || !data.rows.length) {
    box.innerHTML = '<div class="muted">No coach ratings found.</div>';
    return;
  }

  const table = document.createElement('table');
  table.style.width = '100%';
  table.style.fontSize = '13px';
  table.innerHTML = `
    <thead><tr><th>Coach</th><th>Avg Overall</th><th>n</th></tr></thead>
    <tbody></tbody>
  `;
  const tbody = table.querySelector('tbody');

  tbody.innerHTML = data.rows.map(([coach, avg, n]) => `
    <tr>
      <td>${escapeHtml(coach)}</td>
      <td class="num">${Number(avg).toFixed(2)}</td>
      <td class="num">${n}</td>
    </tr>
  `).join('');

  box.appendChild(table);
}

let traitLoadedOnce = false;
function loadTraitRatings() {
  if (traitLoadedOnce) return;
  traitLoadedOnce = true;

  google.script.run
    .withSuccessHandler(renderTraitRatings)
    .withFailureHandler(err => {
      document.querySelector('#panel-traitratings')
        .insertAdjacentHTML('beforeend', `<div class="empty">Failed to load trait ratings.</div>`);
      console.error('Trait ratings error:', err);
    })
    .getTraitRatingsGrid();
}

function renderTraitRatings(data) {
  if (!data || !data.ok) {
    document.querySelector('#panel-traitratings')
      .insertAdjacentHTML('beforeend', `<div class="empty">No trait ratings available.</div>`);
    return;
  }
  const thead = document.querySelector('#traitTable thead');
  const tbody = document.querySelector('#traitTable tbody');
  thead.innerHTML = '';
  tbody.innerHTML = '';

  const headers = data.headers || [];
  const rows = data.rows || [];
  const labelCols = 2;

  const trh = document.createElement('tr');
  headers.forEach((h, i) => {
    const th = document.createElement('th');
    th.textContent = h || (i < labelCols ? 'Label' : `Col ${i+1}`);
    if (i < labelCols) {
      th.classList.add('stickyLeft');
      if (i === 1) th.classList.add('num');
    } else {
      th.classList.add('num');
    }
    trh.appendChild(th);
  });
  thead.appendChild(trh);

  let min = Infinity, max = -Infinity;
  rows.forEach(r => {
    for (let i = labelCols; i < r.length; i++) {
      const val = parseFloat(String(r[i]).replace(',', '.'));
      if (!isNaN(val)) { min = Math.min(min, val); max = Math.max(max, val); }
    }
  });
  if (!isFinite(min) || !isFinite(max)) { min = 0; max = 5; }

  const frag = document.createDocumentFragment();
  rows.forEach(r => {
    const tr = document.createElement('tr');
    r.forEach((cell, i) => {
      const td = document.createElement('td');
      if (i < labelCols) {
        td.textContent = cell || '';
        td.classList.add('stickyLeft');
        if (i === 1) td.classList.add('num');
      } else {
        const val = parseFloat(String(cell).replace(',', '.'));
        if (!isNaN(val)) {
          td.textContent = val.toFixed(2);
          td.classList.add('num');
          td.style.background = colorForTrait(val, min, max);
        } else {
          td.textContent = '';
        }
      }
      tr.appendChild(td);
    });
    frag.appendChild(tr);
  });
  tbody.appendChild(frag);

  document.getElementById('traitLegend').textContent =
    `Scale based on min=${min.toFixed(2)}, max=${max.toFixed(2)} from visible data.`;
}
function colorForTrait(v, min, max) {
  if (max <= min) return 'transparent';
  const t = (v - min) / (max - min);
  const hue = 120 * t;
  return `hsl(${hue}, 70%, 30%)`;
}

function renderPlayer(p) {
  setList('pStrengths', arrayify(p && p.strengths));
  setList('pWeaknesses', arrayify(p && p.weaknesses));
  setList('pFocus', arrayify(p && p.focus));

  const overallEl = document.getElementById('pOverall');
  if (p && p.overall != null && !isNaN(parseFloat(p.overall))) {
    overallEl.textContent = parseFloat(p.overall).toFixed(1);
  } else {
    overallEl.textContent = '—';
  }

  const host = document.getElementById('pFlags');
  host.innerHTML = '';
  host.classList.add('kv');
  host.classList.remove('muted');

  let flagsObj = null;
  if (p && p.flags) {
    if (Array.isArray(p.flags)) {
      const v = p.flags.slice(0, 6);
      flagsObj = { exec:v[0]||'—', energy:v[1]||'—', comm:v[2]||'—', adapt:v[3]||'—', resilience:v[4]||'—', impact:v[5]||'—' };
    } else if (typeof p.flags === 'object') {
      flagsObj = {
        exec: (p.flags.exec ?? '—') || '—',
        energy: (p.flags.energy ?? '—') || '—',
        comm: (p.flags.comm ?? '—') || '—',
        adapt: (p.flags.adapt ?? '—') || '—',
        resilience: (p.flags.resilience ?? '—') || '—',
        impact: (p.flags.impact ?? '—') || '—'
      };
    }
  }

  if (!flagsObj) { host.innerHTML = '<div class="muted">—</div>'; return; }

  const rows = [
    ['Exec', flagsObj.exec],
    ['Energy', flagsObj.energy],
    ['Comm', flagsObj.comm],
    ['Adapt', flagsObj.adapt],
    ['Resilience', flagsObj.resilience],
    ['Impact', flagsObj.impact]
  ];

  rows.forEach(([label, val]) => {
    const lbl = document.createElement('div'); lbl.textContent = label;
    const v = document.createElement('div'); v.textContent = val || '—';
    host.appendChild(lbl); host.appendChild(v);
  });
}

function renderPlayerClips(rows) {
  const box = document.getElementById('pClips');
  if (!box) return;
  if (!Array.isArray(rows) || !rows.length) {
    box.innerHTML = `<div class="muted">No clips found.</div>`;
    return;
  }

  box.classList.remove('muted');

  const frag = document.createDocumentFragment();
  rows.forEach(c => {
    const url = (c.link || c.url || '').trim();
    const enc = encodeURIComponent(url);

    const detailParts = [c.theme, c.subTag, c.type].filter(Boolean);
    let detail = detailParts.join(' — ');
    if (c.notes) {
      let t = String(c.notes).trim().replace(/\s+/g, ' ');
      if (t.length > 120) t = t.slice(0, 117) + '…';
      if (t) detail += (detail ? ' — ' : '') + t;
    }
    const line = (c.dateStr ? (c.dateStr + ' — ') : '') + (detail || 'Clip');

    if (url) {
      const prevMeta = clipMetaByUrl.get(url) || {};
      clipMetaByUrl.set(url, {
        ...prevMeta,
        player: c.player,
        theme: c.theme,
        subTag: c.subTag,
        type: c.type,
        dateStr: c.dateStr,
        notes: c.notes || prevMeta.notes || '',
        times: c.times || prevMeta.times || '',
      });
    }

    const div = document.createElement('div');
    div.className = 'clip';

    div.innerHTML = `
      <div class="clipLine">
        ${escapeHtml(line)}
        ${url ? `
          <a href="#" data-url="${url}" onclick="openClipModal(this.dataset.url); return false;">[open]</a>
          <a href="#" onclick="discussClip('${enc}'); return false;">[discuss]</a>
        ` : ''}
      </div>
    `;

    frag.appendChild(div);
  });

  box.replaceChildren(frag);
}

/* -------------------- CLIPS TAB -------------------- */
function applyClipFilters(filters) {
  const f = filters || {};
  const subs = f.subTags || f.subtags || [];
  fillSel('fPlayer', ['All players'].concat(f.players || []));
  fillSel('fTheme',  ['All themes'].concat(f.themes || []));
  fillSel('fSub',    ['All sub-tags'].concat(subs || []));
  loadClips();
}

function loadClipFilters(force = false) {
  if (!force && dataCache.clipFilters) {
    applyClipFilters(dataCache.clipFilters);
    return;
  }

  google.script.run
    .withSuccessHandler(f => {
      const filters = f || {};
      dataCache.clipFilters = filters;
      applyClipFilters(filters);
    })
    .withFailureHandler(err => {
      console.error('Clip filters error:', err);
      applyClipFilters({ players: [], themes: [], subTags: [] });
    })
    .getClipFilters();
}

function loadClips() {
  const player = valOrEmpty('fPlayer','All players');
  const theme  = valOrEmpty('fTheme','All themes');
  const sub    = valOrEmpty('fSub','All sub-tags');
  const q      = document.getElementById('fSearch').value.trim();

  const args = {
    player: player || undefined,
    theme:  theme  || undefined,
    subTag: sub    || undefined,
    q: q || undefined,
    newestFirst: true,
    limit: 200
  };

  google.script.run
    .withSuccessHandler(function(rows){
      renderClips(rows || []);
    })
    .withFailureHandler(function(err){
      console.error('Clips tab failure:', err);
      document.getElementById('clipsList').innerHTML = `<div class="empty">Clip load error.</div>`;
    })
    .getClips(args);
}

function renderClips(rows) {
  const list = Array.isArray(rows) ? rows : [];
  lastClipsData = list;

  currentClipList = list
    .map(c => (c.link || c.url || '').trim())
    .filter(Boolean);
  currentClipIndex = -1;

  const box = document.getElementById('clipsList');
  if (!box) return;

  if (!list.length) {
    box.innerHTML = `<div class="empty">No clips match your filters.</div>`;
    return;
  }

  const frag = document.createDocumentFragment();

  list.forEach(c => {
    const url = ((c.link || c.url) || '').trim();
    const encodedUrl = encodeURIComponent(url);
    const detailParts = [c.player, c.theme, c.subTag, c.type].filter(Boolean);
    let detail = detailParts.join(' — ');
    if (c.notes) {
      let note = String(c.notes).trim().replace(/\s+/g, ' ');
      if (note.length > 120) note = note.slice(0, 117) + '…';
      if (note) detail += (detail ? ' — ' : '') + note;
    }
    const line = (c.dateStr ? (c.dateStr + ' — ') : '') + (detail || 'Clip');

    if (url) {
      const prevMeta = clipMetaByUrl.get(url) || {};
      clipMetaByUrl.set(url, {
        ...prevMeta,
        player: c.player,
        theme: c.theme,
        subTag: c.subTag,
        type: c.type,
        dateStr: c.dateStr,
        notes: c.notes || prevMeta.notes || '',
        times: c.times || prevMeta.times || '',
      });
    }

    const wrapper = document.createElement('div');
    wrapper.className = 'clip';

    const label = document.createElement('label');
    label.style.display = 'flex';
    label.style.gap = '8px';
    label.style.alignItems = 'center';

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.disabled = !url;
    checkbox.checked = !!url && selectedClipUrls.has(url);
    if (url) {
      checkbox.addEventListener('change', () => onClipSelectChange(checkbox, encodedUrl));
    }

    const content = document.createElement('div');
    content.className = 'clipLine';
    content.textContent = line;

    if (url) {
      const openLink = document.createElement('a');
      openLink.href = '#';
      openLink.textContent = '[open]';
      openLink.addEventListener('click', (evt) => {
        evt.preventDefault();
        openClipModal(url);
      });

      const discussLink = document.createElement('a');
      discussLink.href = '#';
      discussLink.textContent = '[discuss]';
      discussLink.addEventListener('click', (evt) => {
        evt.preventDefault();
        discussClip(encodedUrl);
      });

      content.append(' ', openLink, ' ', discussLink);
    }

    label.append(checkbox, content);
    wrapper.appendChild(label);
    frag.appendChild(wrapper);
  });

  box.replaceChildren(frag);
  maybePushClipSuggestions(rows || []);
}

function onClipSelectChange(cb, encUrl) {
  const url = decodeURIComponent(encUrl);
  if (!url) return;
  if (cb.checked) selectedClipUrls.add(url);
  else selectedClipUrls.delete(url);
}














// ---- NOTES INDEX (client) ----
let _notesIndex = null;
let _notesIndexLoaded = false;

function ensureNotesIndex(cb){
  if (_notesIndexLoaded) { cb && cb(true); return; }
  google.script.run
    .withSuccessHandler(res => {
      _notesIndex = (res && res.ok) ? (res.map || {}) : {};
      _notesIndexLoaded = true;
      const size = Object.keys(_notesIndex).length;
      console.log('Notes index OK?', !!res?.ok, 'keys:', size);
      if (size) {
        // show 10 sample keys for format sanity
        console.log('Sample keys:', Object.keys(_notesIndex).slice(0, 10));
      } else {
        console.warn('Notes index is EMPTY. Check Notes_View data/format.');
      }
      cb && cb(!!res?.ok);
    })
    .withFailureHandler(err => {
      console.error('getNotesIndexForRatings failed:', err);
      _notesIndex = {};
      _notesIndexLoaded = true;
      cb && cb(false);
    })
    .getNotesIndexForRatings();
}

/* -------------------- Feedback flow -------------------- */
function openFeedbackModal() {
  const src = document.getElementById('fPlayer');
  const dst = document.getElementById('fbPlayer');
  if (src && dst) {
    dst.innerHTML = '';
    Array.from(src.options).forEach((opt, i) => {
      if (i === 0) return;
      const o = document.createElement('option');
      o.value = opt.value || opt.textContent;
      o.textContent = opt.textContent;
      dst.appendChild(o);
    });
    if (src.value) dst.value = src.value;
  }
  const n = selectedClipUrls.size;
  document.getElementById('fbSelectedCount').textContent =
    n ? `${n} clip(s) selected.` : 'No clips selected.';

  if (!playerEmailMap) {
    google.script.run
      .withSuccessHandler(map => { playerEmailMap = map || {}; })
      .getPlayerEmailMap();
  }

  document.getElementById('feedbackModal').style.display = 'flex';
  setTimeout(() => document.getElementById('fbText')?.focus(), 0);
}
function closeFeedbackModal() {
  document.getElementById('feedbackModal').style.display = 'none';
  document.getElementById('fbMsg').textContent = '';
}
function sendFeedback() {
  const btn = document.getElementById('fbSendBtn');
  const msg = document.getElementById('fbMsg');
  const player = (document.getElementById('fbPlayer')?.value || '').trim();
  const text = (document.getElementById('fbText')?.value || '').trim();
  const clips = Array.from(selectedClipUrls);

  msg.textContent = '';
  if (!player) { msg.textContent = 'Pick a player.'; return; }
  if (!clips.length) { msg.textContent = 'Select at least one clip.'; return; }

  const email = playerEmailMap ? (playerEmailMap[player] || '') : '';
  if (!email) { msg.textContent = `No email found for ${player}.`; return; }

  btn.disabled = true;
  google.script.run
    .withSuccessHandler(res => {
      btn.disabled = false;
      if (res && res.ok) {
        msg.textContent = 'Sent ✅';
      } else {
        msg.textContent = (res && res.error) ? res.error : 'Send failed.';
      }
    })
    .withFailureHandler(err => {
      btn.disabled = false;
      msg.textContent = 'Send failed.';
      console.error('sendFeedbackEmail error:', err);
    })
    .sendFeedbackEmail({ player, email, text, clips });
}

/* -------------------- Utils -------------------- */
function bullets(x) {
  if (!x) return '';
  const arr = Array.isArray(x) ? x : String(x).split(/\r?\n/);
  return arr.filter(Boolean).map(s => '• ' + s).join('<br>');
}
function arrayify(x) {
  if (!x) return [];
  if (Array.isArray(x)) return x;
  return String(x).split(/\r?\n/).map(s => s.replace(/^\s*•\s*/,'').trim()).filter(Boolean);
}
function setList(id, arr) {
  const ul = document.getElementById(id);
  ul.innerHTML = '';
  if (!arr || !arr.length) { ul.innerHTML = `<li class="muted">—</li>`; return; }
  arr.forEach(s => { const li = document.createElement('li'); li.textContent = s; ul.appendChild(li); });
}
function fillSel(id, opts) {
  const s = document.getElementById(id);
  s.innerHTML = '';
  (opts || []).forEach((v,i) => {
    const clean = String(v ?? '').trim();          // 👈 normalize
    const o = document.createElement('option');
    o.value = (i===0 ? '' : clean);
    o.textContent = (i===0 ? v : clean) || v;      // keep “All …” label as-is
    s.appendChild(o);
  });
}
function valOrEmpty(id) {
  const v = document.getElementById(id).value;
  return v === '' ? '' : v;
}
function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

/* -------------------- Branding -------------------- */
function loadBrand() {
  google.script.run
    .withSuccessHandler(renderBrand)
    .withFailureHandler(() => renderBrand(null))
    .getBrand();
}
function renderBrand(b) {
  const logo = document.getElementById('brandLogo');
  const title = document.getElementById('brandTitle');
  if (logo) {
    if (b && b.logoUrl) logo.src = b.logoUrl; else logo.style.display = 'none';
  }
  if (title) title.textContent = (b && b.name) ? b.name : 'Team Hub';
}

/* -------------------- Team Rating SVG -------------------- */
let teamRatingsLoaded = false;
function loadTeamRatings(force = false) {
  if (teamRatingsLoaded && !force) return;
  google.script.run
    .withSuccessHandler(renderTeamLine)
    .withFailureHandler(err => {
      const note = document.getElementById('teamLineNote');
      if (note) note.textContent = 'Failed to load team rating.';
      console.error('Team rating error:', err);
    })
    .getTeamRatingSeries();
}



function initTooltips() {
  if (window._tipsBound) return;
  window._tipsBound = true;

  let tipEl = null;

  const ensure = () => {
    if (tipEl) return;
    tipEl = document.createElement('div');
    tipEl.className = 'tooltip-bubble';
    tipEl.style.position = 'fixed';
    tipEl.style.display = 'none';
    tipEl.style.maxWidth = '280px';
    tipEl.style.padding = '6px 8px';
    tipEl.style.fontSize = '12px';
    tipEl.style.lineHeight = '1.35';
    tipEl.style.borderRadius = '6px';
    tipEl.style.background = 'rgba(30,30,30,0.95)';
    tipEl.style.color = '#fff';
    tipEl.style.boxShadow = '0 6px 18px rgba(0,0,0,0.25)';
    tipEl.style.zIndex = '9999';
    tipEl.style.pointerEvents = 'none';
    document.body.appendChild(tipEl);
  };

  const show = (text, x, y) => {
    ensure();
    tipEl.textContent = text;
    tipEl.style.display = 'block';
    position(x, y);
  };

  const hide = () => {
    if (tipEl) tipEl.style.display = 'none';
  };

  const position = (x, y) => {
    if (!tipEl || tipEl.style.display === 'none') return;
    const pad = 12;
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    const rect = tipEl.getBoundingClientRect();
    let left = x + pad;
    let top  = y + pad;
    if (left + rect.width + pad > vw) left = vw - rect.width - pad;
    if (top + rect.height + pad > vh) top = vh - rect.height - pad;
    tipEl.style.left = left + 'px';
    tipEl.style.top  = top  + 'px';
  };

  document.addEventListener('mousemove', (e) => {
    const el = e.target.closest && e.target.closest('[data-tip]');
    if (!el) { hide(); return; }
    const text = el.getAttribute('data-tip');
    if (!text) { hide(); return; }
    show(text, e.clientX, e.clientY);
  });

  document.addEventListener('scroll', () => hide(), { passive: true });
}


/* ===== Practice Load (Strength Coach summaries) ===== */

let _plChart = null;

function loadPracticeLoad(){
  const msg = document.getElementById('plListMsg');
  const tbody = document.querySelector('#plListTable tbody');
  if (!msg || !tbody) return;
  msg.textContent = '';
  tbody.innerHTML = '<tr><td colspan="4" class="muted">Loading…</td></tr>';

  google.script.run
    .withSuccessHandler(data => {
      tbody.innerHTML = '';
      if (!data || !data.ok || !Array.isArray(data.rows) || !data.rows.length) {
        msg.textContent = 'No practice-load summaries yet.';
        return;
      }

      data.rows.forEach(r => {
        // expected: { id, date, title, audienceType, audienceName, severity? }
        const tr = document.createElement('tr');
        const dateStr = formatDateLabel(r.date);
        const aud = (r.audienceType || '') + (r.audienceName ? ' — ' + r.audienceName : '');
        tr.innerHTML = `
          <td class="num">${escapeHtml(dateStr)}</td>
          <td>${escapeHtml(r.title || '')}</td>
          <td>${escapeHtml(aud)}</td>
          <td class="num">
            <button class="btn" onclick="openPL('${encodeURIComponent(r.id)}')">Open</button>
          </td>`;
        tbody.appendChild(tr);
      });

      // Optional: push any red flags to Coach Notify (if server sends "severity")
      try {
        const flagged = (data.rows || []).filter(x => (x.severity||'').toLowerCase() === 'high');
        if (flagged.length) {
          const m = _normalizeMsg({
            title: 'Practice Load',
            body: `${flagged.length} high-severity load alert${flagged.length>1?'s':''}.`,
            kind: 'warn',
            actions: [{ type:'gotoTab', label:'Open Practice Load', args:{ tab:'strength' } }]
          }, 'server');
          _coachGeneral.unshift(m);
          coachNotifyRebuild(false);
        }
      } catch(_) {}
    })
    .withFailureHandler(err => {
      tbody.innerHTML = '';
      msg.textContent = 'Failed to load practice-load summaries.';
      console.error('loadPracticeLoad error:', err);
    })
    .getPracticeLoadSummaries(); // <-- server method (see stubs below)
}


function _plForceInsightColumns() {
  const box = document.getElementById('plInsights');
  if (!box) return;
  const insights = box.querySelectorAll('.insight');
  if (insights.length === 0) return;

  // Make sure insights layout nicely in a row
  box.style.display = 'flex';
  box.style.flexWrap = 'wrap';
  box.style.gap = '10px';
  box.style.justifyContent = 'flex-start';

  insights.forEach(div => {
    div.style.flex = '1 1 calc(48% - 10px)'; // two columns
    div.style.boxSizing = 'border-box';
    div.style.minWidth = '250px';
  });
}





function renderPLInsights(cards){
  const box = document.getElementById('plInsights');
  if (!box) return;

  // Force the grid inline so nothing can override it
  box.style.display = 'grid';
  box.style.gridTemplateColumns = 'repeat(auto-fit, minmax(240px, 1fr))';
  box.style.gap = '12px';
  box.style.alignItems = 'stretch';

  // Clear and repopulate
  box.innerHTML = '';
  const arr = Array.isArray(cards) ? cards : [];
  if (!arr.length) {
    box.innerHTML = '<div class="muted">No insights.</div>';
    return;
  }

  // Build cards
  const frag = document.createDocumentFragment();
  arr.forEach(c => {
    const div = document.createElement('div');
    div.className = `insight ${c.kind || 'info'}`;
    div.innerHTML = `
      <div class="insight-title">${escapeHtml(c.title || '')}</div>
      <div class="insight-body">${escapeHtml(c.body || '')}</div>`;
    frag.appendChild(div);
  });
  box.appendChild(frag);

  // Debug: see how wide the grid can be (helps diagnose stacking)
  console.log('[plInsights] width:', box.getBoundingClientRect().width, 'px');
}



function renderPLFacts(d) {
  const box = document.getElementById('plFacts');
  if (!box) return;

  const yesno = d.travel ? 'Yes' : 'No';
  const facts = [
    `<b>Week:</b> ${d.week ?? '—'}`,
    `<b>Day:</b> ${d.day || '—'}`,
    `<b>Practice:</b> ${(d.practiceMinutes ?? '—')} min`,
    `<b>Intensity:</b> ${d.physicalIntensity || '—'}`,
    `<b>Video:</b> ${(d.videoSessions ?? 0)} sess / ${(d.videoMinutes ?? 0)} min`,
    `<b>Days→Game:</b> ${d.daysTillGame ?? '—'}`,
    `<b>Travel:</b> ${yesno}`,
  ];

  // Join everything inline with separators
  box.innerHTML = facts.join(' &nbsp;•&nbsp; ');
}








function openPL(encId){
  const id = decodeURIComponent(encId||'');
  const title = document.getElementById('plTitle');
  const meta  = document.getElementById('plMeta');
  const desc  = document.getElementById('plDesc');
  const pos   = document.getElementById('plPos');
  const sug   = document.getElementById('plSug');
  const note  = document.getElementById('plChartNote');

  // reset
  title.textContent = 'Practice Load';
  meta.textContent  = '';
  desc.textContent  = '';
  pos.innerHTML = '<li class="muted">—</li>';
  sug.innerHTML = '<li class="muted">—</li>';
  setPLMetric('plM_load','—');
  setPLMetric('plM_acwr','—');
  setPLMetric('plM_mono','—');
  setPLMetric('plM_strain','—');
  killPLChart(); if (note) note.textContent = '';

  document.getElementById('plViewModal').style.display = 'flex';

  // Call the server
  google.script.run
    .withSuccessHandler(function(d) {
      if (!d || !d.ok) {
        desc.textContent = (d && d.error) ? d.error : 'Failed to load.';
        return;
      }

    


// header/meta
title.textContent = d.title || 'Practice Load';
const dateStr = formatDateLabel(d.date);
meta.textContent = `${dateStr} — ${d.audienceType || ''}${d.audienceName ? ' — ' + d.audienceName : ''}`;
desc.textContent = d.description || '';

// NEW: show week + video etc.
renderPLFacts(d);


      // metrics
      setPLMetric('plM_load',  safeNum(d.sessionLoad, 0));
      setPLMetric('plM_acwr',  safeNum(d.acwr, 2));
      setPLMetric('plM_mono',  safeNum(d.monotony, 2));
      setPLMetric('plM_strain',safeNum(d.strain, 0));

      // lists
      fillListUL(pos, d.positives);
      fillListUL(sug, d.suggestions);

      // chart
      const labels = (d.trend && d.trend.labels) || [];
      const values = (d.trend && d.trend.values) || [];
      if (labels.length && values.length && labels.length === values.length) {
        drawPLChart(labels, values);
        if (note) note.textContent = 'Trend = Session load (last 14 days).';
      }

      // ✅ NEW — render coach insights
      if (typeof renderPLInsights === 'function') {
        renderPLInsights(d.insights || []);
      }
    })
    .withFailureHandler(function(err) {
      desc.textContent = 'Failed to load.';
      console.error('openPL error:', err);
    })
    .getPracticeLoadDetail(id);
}

function closePLModal(){
  document.getElementById('plViewModal').style.display = 'none';
  killPLChart();
}

function setPLMetric(id, val){
  const el = document.getElementById(id);
  if (!el) return;
  if (typeof val === 'number') {
    // choose sensible precision based on id
    const dps = /acwr|mono/i.test(id) ? 2 : 0;
    el.textContent = val.toFixed(dps);
  } else {
    el.textContent = val;
  }
}

function fillListUL(ul, items){
  ul.innerHTML = '';
  const arr = Array.isArray(items) ? items : String(items||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  if (!arr.length) { ul.innerHTML = '<li class="muted">—</li>'; return; }
  arr.forEach(s => {
    const li = document.createElement('li');
    li.textContent = s;
    ul.appendChild(li);
  });
}

function safeNum(x, dp){
  const n = Number(x);
  if (!isFinite(n)) return '—';
  return Number.isInteger(dp) ? Number(n.toFixed(dp)) : n;
}

/* Chart.js (already included by you) */
function drawPLChart(labels, values){
  const ctx = document.getElementById('plChart');
  if (!ctx) return;
  killPLChart();
  _plChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{ data: values, fill:false, tension:0.25 }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { maxRotation: 0, autoSkip: true } },
        y: { beginAtZero: true }
      }
    }
  });
}
function killPLChart(){
  if (_plChart) { try{ _plChart.destroy(); } catch(_){}; _plChart = null; }
}








function renderTeamLine(series) {
  const svg  = document.getElementById('teamLine');
  const note = document.getElementById('teamLineNote');
  if (!svg) return;

  // Tooltip (reuse #notesTooltip)
  const tipEl = document.getElementById('notesTooltip');
  function hideTip(){ if (tipEl) tipEl.style.display = 'none'; }
  function showTip(html, x, y){
    if (!tipEl) return;
    if (html) tipEl.innerHTML = html;
    tipEl.style.display = 'block';
    const pad = 12, vw = window.innerWidth, vh = window.innerHeight;
    const r = tipEl.getBoundingClientRect();
    let L = x + pad, T = y + pad;
    if (L + r.width  > vw - 8) L = x - r.width  - pad;
    if (T + r.height > vh - 8) T = y - r.height - pad;
    tipEl.style.left = Math.max(8, L) + 'px';
    tipEl.style.top  = Math.max(8, T) + 'px';
  }

  svg.innerHTML = '';
  if (!series || !series.ok || !Array.isArray(series.labels) || series.labels.length === 0) {
    if (note) note.textContent = 'No team rating data.';
    return;
  }
  if (note) note.textContent = '';

  const labels   = series.labels;
  const values   = (series.values || []).map(Number);
  const sessions = (Array.isArray(series.sessions) && series.sessions.length === labels.length)
    ? series.sessions
    : labels.map(() => '');

  if (labels.length !== values.length) {
    if (note) note.textContent = 'No team rating data.';
    return;
  }

  // --- color mapping ---
  const COLOR_DEFAULT = '#4aa8ff'; // blue (existing)
  const COLOR_MAP = { friendly: '#ffb020', gbl: '#ff5a5f', ec: '#ffd400' };
  function sessionTag(s){
    const t = String(s || '').toLowerCase();
    if (t.includes('friendly')) return 'friendly';
    if (t.includes('gbl'))      return 'gbl';
    if (t.includes('ec'))       return 'ec';
    return '';
  }
  function colorForSession(s){ return COLOR_MAP[sessionTag(s)] || COLOR_DEFAULT; }

  // --- SVG setup ---
  const W = 900, H = 340;
  const padL = 50, padR = 12, padT = 12, padB = 70;
  const innerW = W - padL - padR;
  const innerH = H - padT - padB;
  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);

  const yMin = 2.5, yMax = 5.0;
  const x = i => padL + (labels.length === 1 ? innerW/2 : (i * innerW / (labels.length - 1)));
  const y = v => padT + innerH * (1 - (v - yMin) / (yMax - yMin || 1));
  const mk = n => document.createElementNS('http://www.w3.org/2000/svg', n);

  // Axes
  const axis = mk('path');
  axis.setAttribute('d', `M${padL},${padT} L${padL},${padT+innerH} L${padL+innerW},${padT+innerH}`);
  axis.setAttribute('stroke', '#2a3448');
  axis.setAttribute('fill', 'none');
  svg.appendChild(axis);

  // Grid + y ticks
  for (let t = 0; t <= 5; t++) {
    const val = yMin + t * (yMax - yMin) / 5;
    const yy = y(val);
    const g = mk('line');
    g.setAttribute('x1', padL); g.setAttribute('x2', padL + innerW);
    g.setAttribute('y1', yy);   g.setAttribute('y2', yy);
    g.setAttribute('stroke', '#1b2130');
    svg.appendChild(g);

    const txt = mk('text');
    txt.setAttribute('x', padL - 8);
    txt.setAttribute('y', yy + 4);
    txt.setAttribute('text-anchor', 'end');
    txt.setAttribute('font-size', '10');
    txt.setAttribute('fill', '#9aa6bf');
    txt.textContent = val.toFixed(2);
    svg.appendChild(txt);
  }

  // X labels (skip if crowded)
  const minGapPx = 60;
  const gap = innerW / Math.max(1, labels.length - 1);
  const step = gap < minGapPx ? Math.ceil(minGapPx / gap) : 1;
  labels.forEach((lab, i) => {
    if (i !== 0 && i !== labels.length - 1 && (i % step !== 0)) return;
    const xx = x(i), yy = padT + innerH + 16;
    const tx = mk('text');
    tx.setAttribute('x', xx);
    tx.setAttribute('y', yy);
    tx.setAttribute('font-size', '10');
    tx.setAttribute('fill', '#9aa6bf');
    tx.setAttribute('text-anchor', 'end');
    tx.setAttribute('transform', `rotate(-40 ${xx} ${yy})`);
    tx.textContent = lab;
    svg.appendChild(tx);
  });

  // Blue rating line
  const d = values.map((v, i) => `${i ? 'L' : 'M'}${x(i)},${y(v)}`).join(' ');
  const path = mk('path');
  path.setAttribute('d', d);
  path.setAttribute('fill', 'none');
  path.setAttribute('stroke', '#4aa8ff');
  path.setAttribute('stroke-width', '2');
  svg.appendChild(path);

  // Points + hover
  const legendSeen = new Set();
  values.forEach((v, i) => {
    const dotColor = colorForSession(sessions[i]);
    const tag = sessionTag(sessions[i]);
    if (tag) legendSeen.add(tag);

    const cx = x(i), cy = y(v);

    const c = mk('circle');
    c.setAttribute('cx', cx);
    c.setAttribute('cy', cy);
    c.setAttribute('r', 3);
    c.setAttribute('fill', dotColor);
    c.setAttribute('stroke', '#0b0d10');
    c.setAttribute('stroke-width', '1');
    svg.appendChild(c);

    const hit = mk('circle');
    hit.setAttribute('cx', cx);
    hit.setAttribute('cy', cy);
    hit.setAttribute('r', 10);
    hit.setAttribute('fill', 'transparent');
    hit.addEventListener('mouseenter', e => {
      const sessTxt = sessions[i] ? ` (${sessions[i]})` : '';
      const html = `
        <div style="font-weight:700; margin-bottom:2px;">${labels[i]}${sessTxt}</div>
        <div>Avg team score: <span style="font-variant-numeric:tabular-nums;">${v.toFixed(2)}</span></div>
      `;
      showTip(html, e.clientX, e.clientY);
    });
    hit.addEventListener('mousemove', e => showTip(null, e.clientX, e.clientY));
    hit.addEventListener('mouseleave', hideTip);
    svg.appendChild(hit);
  });

  // Legend (ratings)
  if (note) {
    const items = [];
    if (legendSeen.has('friendly')) items.push(`<span style="display:inline-flex;align-items:center;gap:6px;margin-right:12px;"><span style="width:10px;height:10px;border-radius:50%;background:#ffb020;display:inline-block;"></span>Friendly</span>`);
    if (legendSeen.has('gbl'))      items.push(`<span style="display:inline-flex;align-items:center;gap:6px;margin-right:12px;"><span style="width:10px;height:10px;border-radius:50%;background:#ff5a5f;display:inline-block;"></span>GBL</span>`);
    if (legendSeen.has('ec'))       items.push(`<span style="display:inline-flex;align-items:center;gap:6px;margin-right:12px;"><span style="width:10px;height:10px;border-radius:50%;background:#ffd400;display:inline-block;"></span>EC</span>`);
    items.push(`<span style="display:inline-flex;align-items:center;gap:6px;margin-right:12px;"><span style="width:10px;height:10px;border-radius:50%;background:#4aa8ff;display:inline-block;"></span>Other</span>`);
    note.innerHTML = items.join('');
  }

  // === NEW: overlay Practice Load line + green dots with tooltip ===
 (function overlayLoadLine() {
  const LOAD_LINE_COLOR = '#ffb020'; // dashed orange (kept visually)
  const LOAD_DOT_COLOR  = '#10b981'; // green dots

  const norm = s => String(s||'')
    .trim()
    .replace(/\u2013|\u2014/g, '-')
    .replace(/\s+/g, ' ')
    .toUpperCase();

  const ratingLabelsNorm = labels.map(norm);

  google.script.run
    .withSuccessHandler(loadSeries => {
      if (!loadSeries || !loadSeries.ok) return;

      const loadMap = {};
      (loadSeries.labels || []).forEach((lab, i) => {
        loadMap[norm(lab)] = Number(loadSeries.loads[i] || 0);
      });

      const alignedLoads = ratingLabelsNorm.map(lab => (lab in loadMap) ? loadMap[lab] : null);
      const numeric = alignedLoads.filter(v => v != null && isFinite(v));
      if (!numeric.length) return;

      const minL = Math.min(...numeric);
      const maxL = Math.max(...numeric);
      const hasLine = (numeric.length >= 2 && maxL > minL);

      const pad  = 0.15;
      const loY  = yMin + pad;
      const hiY  = yMax - pad;

      const scaleYVal = (val) => {
        const t = (maxL === minL) ? 0.5 : (val - minL) / (maxL - minL);
        const yVal = loY + t * (hiY - loY);
        return y(yVal);
      };

      // Dashed orange line (for reference)
      if (hasLine) {
        let d2 = '';
        for (let i = 0; i < alignedLoads.length; i++) {
          const v = alignedLoads[i];
          if (v == null || !isFinite(v)) { d2 += ' '; continue; }
          const cmd = (i > 0 && alignedLoads[i-1] != null) ? 'L' : 'M';
          d2 += `${cmd}${x(i)},${scaleYVal(v)} `;
        }
        const pathLoad = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        pathLoad.setAttribute('d', d2.trim());
        pathLoad.setAttribute('fill', 'none');
        pathLoad.setAttribute('stroke', LOAD_LINE_COLOR);
        pathLoad.setAttribute('stroke-width', '1.5');
        pathLoad.setAttribute('stroke-dasharray', '5,3');
        svg.appendChild(pathLoad);
      }

      // Green dots + tooltip
      alignedLoads.forEach((val, i) => {
        if (val == null || !isFinite(val)) return;

        const cx = x(i);
        const cy = scaleYVal(val);

        const dot = document.createElementNS('http://www.w3.org/2000/svg','circle');
        dot.setAttribute('cx', cx);
        dot.setAttribute('cy', cy);
        dot.setAttribute('r', 3.5);
        dot.setAttribute('fill', LOAD_DOT_COLOR);
        dot.setAttribute('stroke', '#0b0d10');
        dot.setAttribute('stroke-width', '1');
        svg.appendChild(dot);

        const hit = document.createElementNS('http://www.w3.org/2000/svg','circle');
        hit.setAttribute('cx', cx);
        hit.setAttribute('cy', cy);
        hit.setAttribute('r', 12);
        hit.setAttribute('fill', 'transparent');
        hit.addEventListener('mouseenter', e => {
          const html = `
            <div style="font-weight:700; margin-bottom:2px;">${labels[i]}</div>
            <div>Load: <span style="font-variant-numeric:tabular-nums;">${Math.round(val)}</span> (mins×RPE)</div>
          `;
          showTip(html, e.clientX, e.clientY);
        });
        hit.addEventListener('mousemove', e => showTip(null, e.clientX, e.clientY));
        hit.addEventListener('mouseleave', hideTip);
        svg.appendChild(hit);
      });

      // ✅ Legend — only green dot now
      if (note) {
        const add = `<span style="display:inline-flex;align-items:center;gap:6px;margin-right:12px;">
          <span style="width:10px;height:10px;border-radius:50%;display:inline-block;background:${LOAD_DOT_COLOR};"></span>
          Load (mins×RPE)
        </span>`;
        note.innerHTML = (note.innerHTML || '') + add;
      }
    })
    .withFailureHandler(err => console.error('load overlay error:', err))
    .getPracticeLoadSeriesSimple();
})();

  // keep if you track this elsewhere
  if (typeof teamRatingsLoaded !== 'undefined') {
    teamRatingsLoaded = true;
  }
}




/* -------------------- Flags (Home) -------------------- */
function loadFlags() {
  google.script.run
    .withSuccessHandler(renderFlagsTable)
    .withFailureHandler(() => renderFlagsTable(null))
    .getThreeDayFlags();
}
function renderFlagsTable(data){
  const msg = document.getElementById('flagsMsg');
  const thead = document.querySelector('#flagsTable thead');
  const tbody = document.querySelector('#flagsTable tbody');

  thead.innerHTML = '';
  tbody.innerHTML = '';

  if (!data || !data.ok || !data.headers || !data.rows || !data.rows.length){
    if (msg) msg.textContent = 'No flags available.';
    return;
  }
  if (msg) msg.textContent = '';

  const headFrag = document.createDocumentFragment();
  const trh = document.createElement('tr');
  data.headers.forEach(h => {
    const th = document.createElement('th');
    th.textContent = h;
    trh.appendChild(th);
  });
  headFrag.appendChild(trh);
  thead.appendChild(headFrag);

  const bodyFrag = document.createDocumentFragment();
  data.rows.forEach(r => {
    const tr = document.createElement('tr');
    r.forEach((val, i) => {
      const td = document.createElement('td');
      td.textContent = val || '';
      if (i > 0) td.classList.add('num');
      tr.appendChild(td);
    });
    bodyFrag.appendChild(tr);
  });
  tbody.appendChild(bodyFrag);
}

/* -------------------- Summaries (list + view) -------------------- */
function loadSummaries() {
  const msg = document.getElementById('sumListMsg');
  const tbody = document.querySelector('#sumListTable tbody');
  msg.textContent = '';
  tbody.innerHTML = '<tr><td colspan="4" class="muted">Loading…</td></tr>';

  google.script.run
    .withSuccessHandler(data => {
      tbody.innerHTML = '';
      if (!data || !data.ok || !data.rows || !data.rows.length) {
        msg.textContent = 'No summaries yet.';
        return;
      }
      const frag = document.createDocumentFragment();
      data.rows.forEach(r => {
        const tr = document.createElement('tr');
        const dateStr = formatDateLabel(r.date);
        tr.innerHTML = `
          <td class="num">${escapeHtml(dateStr)}</td>
          <td>${escapeHtml(r.title)}</td>
          <td>${escapeHtml(r.audienceType || '')}${r.audienceName ? ' — ' + escapeHtml(r.audienceName) : ''}</td>
          <td class="num">
            <button class="btn" onclick="openSummary('${encodeURIComponent(r.id)}')">Open</button>
            <button class="btn-danger" onclick="deleteSummaryConfirm('${encodeURIComponent(r.id)}')">Delete</button>
          </td>`;
        frag.appendChild(tr);
      });
      tbody.appendChild(frag);
    })
    .withFailureHandler(err => {
      tbody.innerHTML = '';
      msg.textContent = 'Failed to load summaries.';
      console.error('loadSummaries error:', err);
    })
    .getSummaries();
}
function formatDateLabel(d) {
  const opts = { day:'2-digit', month:'short', year:'numeric' };

  // number (epoch ms)
  if (typeof d === 'number') return new Date(d).toLocaleDateString('en-GB', opts);

  const s = String(d || '').trim();

  // ISO yyyy-MM-dd (safe)
  let m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (m) return new Date(Date.UTC(+m[1], +m[2]-1, +m[3])).toLocaleDateString('en-GB', opts);

  // dd/MM/yyyy (your sheet)
  m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (m) return new Date(+m[3], +m[2]-1, +m[1]).toLocaleDateString('en-GB', opts);

  // fallback
  const dt = new Date(s);
  return isNaN(dt) ? s : dt.toLocaleDateString('en-GB', opts);
}
function deleteSummaryConfirm(encId) {
  const id = decodeURIComponent(encId || '');
  if (!id) return;
  if (!confirm('Delete this summary? This cannot be undone.')) return;

  google.script.run
    .withSuccessHandler(res => {
      if (res && res.ok) {
        if (window.currentSummaryId === id) closeSummaryModal();
        loadSummaries();
      } else {
        alert(res && res.error ? res.error : 'Delete failed.');
      }
    })
    .withFailureHandler(err => {
      console.error('deleteSummary error:', err);
      alert('Delete failed.');
    })
    .deleteSummary(id);
}
function openSummary(encId) {
  const id = decodeURIComponent(encId || '');
  window.currentSummaryId = id;
  const msg   = document.getElementById('svMsg');
  const title = document.getElementById('svTitle');
  const meta  = document.getElementById('svMeta');
  const desc  = document.getElementById('svDesc');
  const tbody = document.querySelector('#svClipsTable tbody');

  title.textContent = 'Summary';
  meta.textContent  = '';
  desc.textContent  = '';
  tbody.innerHTML   = '';
  msg.textContent   = 'Loading…';

  google.script.run
    .withSuccessHandler(data => {
      if (!data || !data.ok) {
        msg.textContent = (data && data.error) ? data.error : 'Failed to load.';
        return;
      }

      msg.textContent = '';
      title.textContent = data.title || 'Summary';
      const dateStr = formatDateLabel(data.date);
      meta.textContent = `${dateStr} — ${data.audienceType || ''}${data.audienceName ? ' — ' + data.audienceName : ''}`;
      desc.textContent = data.description || '';

      tbody.innerHTML = '';
      (data.clips || []).forEach((u, i) => {
        const cap  = (data.captions && data.captions[i]) ? data.captions[i] : '';
        const base = normalizeEmbedUrl(u);
        const isYouTube = /youtube\.com\/embed|youtu\.be|youtube\.com/i.test(base);
        const candidate  = isYouTube ? base + (base.includes('?') ? '&' : '?') + 'autoplay=1&mute=1' : base;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="num">${i + 1}</td>
          <td>
            <div class="embedWrap">
              <iframe
                data-src="${candidate}"
                ${i === 0 ? 'loading="eager"' : 'loading="lazy"'}
                allow="autoplay; encrypted-media"
                allowfullscreen
                referrerpolicy="no-referrer-when-downgrade"
              ></iframe>
            </div>
            <div class="muted" style="margin-top:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
                 title="${escapeHtml(u)}">${escapeHtml(u)}</div>
          </td>
          <td>${escapeHtml(cap)}</td>
        `;
        tbody.appendChild(tr);
      });

      const modal = document.getElementById('summaryViewModal');
      modal.style.display = 'flex';

      requestAnimationFrame(() => {
        document.querySelectorAll('#svClipsTable iframe[data-src]').forEach((ifr, idx) => {
          const src = ifr.getAttribute('data-src');
          ifr.removeAttribute('data-src');
          const isDrive = /drive\.google\.com\/file\/d\/.+\/preview/i.test(src);
          if (idx === 0 && isDrive) {
            const clean = src.replace(/[?&](autoplay|mute)=[^&]+/gi, '').replace(/\?&/, '?');
            ifr.src = clean;
          } else {
            ifr.src = src;
          }
        });
      });
    })
    .withFailureHandler(err => {
      msg.textContent = 'Failed to load.';
      console.error('openSummary error:', err);
    })
    .getSummaryDetail(id);
}
function closeSummaryModal() {
  document.getElementById('summaryViewModal').style.display = 'none';
}

/* ----- Create Summary flow ----- */
function openCreateSummaryModal() {
  const n = selectedClipUrls.size;
  if (!n) { alert('Select at least one clip first.'); return; }

  populateAudienceNameOptions('player');

  const tbody = document.querySelector('#sumClipsTable tbody');
  tbody.innerHTML = '';

  const unique = Array.from(new Set(Array.from(selectedClipUrls).map(s => String(s).trim())));

  unique.forEach((url, idx) => {
    const meta = clipMetaByUrl.get(url) || {};
    const userNote = (clipNotesByUrl.get(url) || '').trim();
    const fallback = [meta.player, meta.theme, meta.subTag, meta.type].filter(Boolean).join(' — ');
    const label = userNote || (meta.notes || '').trim() || fallback || '(no notes)';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="num">${idx+1}</td>
      <td style="max-width:480px;">
        <a href="#" data-url="${url}" onclick="openClipModal(this.dataset.url); return false;">Open</a>
        &nbsp;—&nbsp;<span title="${escapeHtml(label)}" style="display:inline-block; max-width:420px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
          ${escapeHtml(label)}
        </span>
      </td>
      <td>
        <input type="text" class="select" placeholder="Optional caption…"
               data-cap-index="${idx}" value="${escapeHtml(userNote)}">
      </td>`;
    tbody.appendChild(tr);
  });

  document.getElementById('sumTitle').value = '';
  document.getElementById('sumDescription').value = '';
  document.getElementById('sumMsg').textContent = '';
  document.getElementById('createSummaryModal').style.display = 'flex';
}
function closeCreateSummaryModal() {
  document.getElementById('createSummaryModal').style.display = 'none';
  document.getElementById('sumMsg').textContent = '';
}
function onSumAudienceTypeChange() {
  const type = (document.getElementById('sumAudienceType')?.value || 'player');
  populateAudienceNameOptions(type);
}
function populateAudienceNameOptions(type) {
  const wrap = document.getElementById('sumAudienceNameWrap');

  if (type === 'team') {
    wrap.innerHTML = `Audience name
      <input id="sumAudienceName" class="select" value="All" readonly />`;
    return;
  }
  if (type === 'group') {
    wrap.innerHTML = `Audience name
      <input id="sumAudienceName" type="text" class="select" placeholder="e.g., Bigs / Guards / Unit A">`;
    return;
  }
  wrap.innerHTML = `Audience name
    <select id="sumAudienceName" class="select"></select>`;
  const src = document.getElementById('fPlayer');
  const dst = document.getElementById('sumAudienceName');
  dst.innerHTML = '';
  if (src) {
    Array.from(src.options).forEach((opt, i) => {
      if (i === 0) return;
      const o = document.createElement('option');
      o.value = opt.value || opt.textContent;
      o.textContent = opt.textContent;
      dst.appendChild(o);
    });
    if (src.value) dst.value = src.value;
  }
}
function saveSummary() {
  const btn = document.getElementById('sumSaveBtn');
  const msg = document.getElementById('sumMsg');

  const title = (document.getElementById('sumTitle')?.value || '').trim();
  const audienceType = (document.getElementById('sumAudienceType')?.value || 'player').trim();
  const audienceName = (document.getElementById('sumAudienceName')?.value || '').trim();
  const description  = (document.getElementById('sumDescription')?.value || '').trim();
  const clips = Array.from(selectedClipUrls);

  msg.textContent = '';
  if (!title) { msg.textContent = 'Title is required.'; return; }
  if (!clips.length) { msg.textContent = 'No clips selected.'; return; }
  if (audienceType === 'player' && !audienceName) { msg.textContent = 'Pick a player.'; return; }
  if (audienceType === 'group' && !audienceName) { msg.textContent = 'Enter a group name.'; return; }

  const capInputs = document.querySelectorAll('#sumClipsTable input[data-cap-index]');
  const captions = [];
  capInputs.forEach(inp => captions[Number(inp.dataset.capIndex)] = (inp.value || '').trim());

  btn.disabled = true;
  google.script.run
    .withSuccessHandler(res => {
      btn.disabled = false;
      if (res && res.ok) {
        msg.textContent = 'Saved ✅';
        document.querySelector('.tab[data-tab="summaries"]')?.click();
        setTimeout(() => openSummary(encodeURIComponent(res.id)), 300);
        closeCreateSummaryModal();
      } else {
        msg.textContent = (res && res.error) ? res.error : 'Save failed.';
      }
    })
    .withFailureHandler(err => {
      btn.disabled = false;
      msg.textContent = 'Save failed.';
      console.error('createSummary error:', err);
    })
    .createSummary({ title, audienceType, audienceName, description, clips, captions });
}

/* -------------------- Misc -------------------- */
function deselectAllClips() {
  selectedClipUrls.clear();
  renderClips(lastClipsData || []);
}








/* ----- Presence floating widget ----- */
let _presenceWidgetCollapsed = false;

function togglePresenceWidget(){
  _presenceWidgetCollapsed = !_presenceWidgetCollapsed;
  const list = document.getElementById('presenceWidgetList');
  const btns = document.querySelectorAll('.presence-widget header .presence-btn');
  if (!list) return;
  list.style.display = _presenceWidgetCollapsed ? 'none' : 'block';
  // flip the caret symbol
  const caret = btns[1];
  if (caret) caret.textContent = _presenceWidgetCollapsed ? '▸' : '▾';
}

function refreshPresenceWidget(){
  const box = document.getElementById('presenceWidgetList');
  if (!box) return;
  google.script.run
    .withSuccessHandler(res => {
      box.innerHTML = '';
      if (!res || !res.ok || !Array.isArray(res.users) || !res.users.length) {
        box.innerHTML = '<div class="presence-empty">No one online</div>';
        return;
      }
      const frag = document.createDocumentFragment();
      res.users.forEach(u => {
        const div = document.createElement('div');
        // Only the name, in a red pill
        div.innerHTML = `<span class="presence-badge">${u.name}</span>`;
        frag.appendChild(div);
      });
      box.appendChild(frag);
    })
    .withFailureHandler(() => {
      box.innerHTML = '<div class="presence-empty">Unable to load</div>';
    })
    .getOnlineUsers();
}

// kick off + refresh every 30s
if (!IS_PLAYER) {
  window.addEventListener('load', refreshPresenceWidget);
  setInterval(refreshPresenceWidget, 30000);
}









/* ---------- Coach Notify: rotate + close + mute ---------- */
/* ---------- Coach Notify: rotate + close + mute ---------- */
// ---- Coach Notify: simple interval rotator ----
const COACH_NOTIFY_ROTATE_MS = 15000;
const COACH_NOTIFY_MUTE_KEY = 'coachNotifyMutedUntil';


function coachNotifyMuted() {
  const until = Number(localStorage.getItem(COACH_NOTIFY_MUTE_KEY) || 0);
  return Date.now() < until;
}
function coachNotifyHide() {
  const box = document.getElementById('coachNotify');
  if (_coachInterval) clearInterval(_coachInterval);
  _coachInterval = null;
  if (box) box.style.display = 'none';
}





var _coachGreeting = null;     // the one-and-only greeting object
var _clipSuggestions = [];     // we’ll keep clip suggestions here






function _normalizeMsg(m, origin) {
  if (typeof m === 'string') {
    return { title: '', body: m, kind: 'info', actions: [], _origin: origin || 'server' };
  }
  return {
    title: m.title || '',
    body: m.body || '',
    kind: m.kind || 'info',
    actions: Array.isArray(m.actions) ? m.actions : [],
    _origin: origin || m._origin || 'server'
  };
}
function _kindBorder(kind){
  if (kind === 'success') return '#2ecc71';
  if (kind === 'warn')    return '#ffb020';
  if (kind === 'error')   return '#ff5a5f';
  return '#4aa8ff';
}
function _runAction(a){
  const t    = (a && a.type) || 'gotoTab';
  const args = (a && a.args) || {};

  if (t === 'gotoTab' && args.tab){
    document.querySelector(`.tab[data-tab="${args.tab}"]`)?.click();
    if (args.tab === 'chat') setTimeout(refreshChat, 150);
    if (args.tab === 'dailyratings') setTimeout(() => loadRatings(true), 150);
    return;
  }

  if (t === 'gotoClipsFilter') {
    // Go to Clips tab
    document.querySelector('.tab[data-tab="clips"]')?.click();

    // Apply filters (normalize + select)
    const set = (sel, val) => {
      if (val == null) return;
      const el = document.querySelector(sel);
      if (!el) return;
      const target = String(val).trim().toLowerCase();
      const opt = Array.from(el.options).find(o =>
        String((o.value ?? o.textContent) || '').trim().toLowerCase() === target
      );
      el.value = opt ? opt.value : '';
    };

    set('#fPlayer', args.player);
    set('#fTheme',  args.theme);
    set('#fSub',    (args.sub ?? args.subTag)); // support either key

    if (args.q != null) {
      const qEl = document.querySelector('#fSearch');
      if (qEl) qEl.value = String(args.q);
    }

    if (typeof loadClips === 'function') loadClips();
    return;
  }

  if (t === 'openChat'){
    document.querySelector('.tab[data-tab="chat"]')?.click();
    setTimeout(refreshChat, 150);
    return;
  }

  if (t === 'gotoPlayer' && args.name){
    document.querySelector('.tab[data-tab="players"]')?.click();
    setTimeout(() => {
      const sel = document.getElementById('playerSelect');
      if (!sel) return;
      const nameLC = String(args.name).toLowerCase();
      const opt = Array.from(sel.options).find(o =>
        String(o.value || o.textContent || '').toLowerCase() === nameLC
      );
      if (opt){ sel.value = opt.value; onPlayerChange(opt.value); }
    }, 200);
    return;
  }

  if (t === 'openClip' && args.url){
    openClipModal(args.url);
    return;
  }
}






function coachNotifyStartRotation() {
  if (_coachInterval) clearInterval(_coachInterval);
  if (_coachMsgs.length <= 1 || coachNotifyMuted()) { coachNotifyRenderOnce(); return; }
  coachNotifyRenderOnce();
  _coachInterval = setInterval(() => {
    _coachIdx = (_coachIdx + 1) % _coachMsgs.length;
    coachNotifyRenderOnce();
  }, COACH_NOTIFY_ROTATE_MS);
}

function initCoachNotify(messages) {
  // Server is responsible for sending a greeting if needed
  _coachGeneral = (Array.isArray(messages) ? messages : [])
    .filter(Boolean)
    .map(m => _normalizeMsg(m, 'server'));

  coachNotifyRebuild(true);
}



(function addSwipeNav(){
  const modal = document.getElementById('clipModal');
  const frame = document.getElementById('clipFrame');
  if (!modal || !frame) return;

  let startX = 0, startY = 0, t0 = 0;
  const THRESH = 50; // px horizontal swipe
  const MAX_ANGLE = 30; // degrees from horizontal

  function onStart(e){
    const t = e.touches && e.touches[0];
    if (!t) return;
    startX = t.clientX; startY = t.clientY; t0 = Date.now();
  }
  function onEnd(e){
    const t = (e.changedTouches && e.changedTouches[0]) || null;
    if (!t) return;
    const dx = t.clientX - startX;
    const dy = t.clientY - startY;
    const angle = Math.abs(Math.atan2(dy, dx) * 180 / Math.PI);
    const dt = Date.now() - t0;

    // horizontal & decisive swipe
    if (Math.abs(dx) > THRESH && angle < MAX_ANGLE && dt < 800) {
      if (dx < 0) nextClip(); else prevClip();
    }
  }

  modal.addEventListener('touchstart', onStart, {passive:true});
  modal.addEventListener('touchend', onEnd, {passive:true});
})();









function handleCoachAction(a){
  if (!a || !a.type) return;
  const t = a.type;
  if (t === 'gotoTab' && a.args?.tab) {
    const tabBtn = document.querySelector(`.tab[data-tab="${a.args.tab}"]`);
    if (tabBtn) tabBtn.click();
    return;
  }
  if (t === 'gotoClipsFilter') {
    const tabBtn = document.querySelector(`.tab[data-tab="clips"]`);
    if (tabBtn) tabBtn.click();
    // Set filters if provided and run search
    if (a.args) {
      const { player, theme, sub, q } = a.args;
      if (player != null) setSelectValue('#fPlayer', player);
      if (theme  != null) setSelectValue('#fTheme',  theme);
      if (sub    != null) setSelectValue('#fSub',    sub);
      if (q      != null) { const el = document.querySelector('#fSearch'); if (el) el.value = q; }
      if (typeof loadClips === 'function') loadClips();
    }
    return;
  }
  if (t === 'openClip' && a.args?.url) {
    openClipModal(a.args.url);
    return;
  }
  if (t === 'gotoPlayer' && a.args?.name) {
    const tabBtn = document.querySelector(`.tab[data-tab="players"]`);
    if (tabBtn) tabBtn.click();
    // select player if present
    const sel = document.getElementById('playerSelect');
    if (sel) {
      const valLC = a.args.name.toLowerCase();
      const match = Array.from(sel.options).find(o => (o.value||o.textContent||'').toLowerCase() === valLC);
      if (match) { sel.value = match.value; onPlayerChange(match.value); }
    }
    return;
  }
}

function setSelectValue(sel, value){
  const el = document.querySelector(sel);
  if (!el) return;
  const target = String(value || '').trim().toLowerCase();   // 👈 normalize
  const opt = Array.from(el.options).find(o =>
    String((o.value ?? o.textContent) || '')
      .trim()
      .toLowerCase() === target
  );
  el.value = opt ? opt.value : '';
}

function applyKindBorder(kind){
  const box = document.getElementById('coachNotify');
  const map = { success:'#2ecc71', info:'#4aa8ff', warn:'#ffb020', error:'#ff5a5f' };
  box.style.borderLeftColor = map[kind] || '#4aa8ff';
}
























/* ===== Coach Chat (client) ===== */
let _chatPollTimer = null;
let _chatLastSeenEpoch = 0; // for unread detection
const CHAT_POLL_MS = 20000; // 20s
const CHAT_TIP_TEXT = 'Tip: Press ⌘/Ctrl + Enter to send';
let _chatTipTimer = null;
const DEFAULT_CHAT_COACHES = ['Dimitris','Vasillis','Stefanos','Konstantinos','Xristoforos'];

function _setChatStatus(message, revertDelayMs) {
  const el = document.getElementById('chatMsg');
  if (!el) return;
  if (_chatTipTimer) {
    clearTimeout(_chatTipTimer);
    _chatTipTimer = null;
  }
  el.textContent = message || '';
  if (revertDelayMs != null) {
    _chatTipTimer = setTimeout(() => {
      const statusEl = document.getElementById('chatMsg');
      if (statusEl) statusEl.textContent = CHAT_TIP_TEXT;
      _chatTipTimer = null;
    }, Math.max(0, revertDelayMs));
  }
}

function initChatUI(){
  // fill recipients
  google.script.run
    .withSuccessHandler(res => {
      const sel = document.getElementById('chatTo');
      if (!sel) return;

      const coaches = (res && res.ok && Array.isArray(res.coaches) && res.coaches.length)
        ? res.coaches
        : DEFAULT_CHAT_COACHES;
      try {
        console.log('[chat] recipients', coaches);
      } catch (_) {}

      sel.innerHTML = '';
      const optAll = document.createElement('option');
      optAll.value = 'All';
      optAll.textContent = 'All coaches';
      sel.appendChild(optAll);
      sel.value = 'All';

      const me = window.CURRENT_USER_NAME || '';
      coaches.forEach(n => {
        const name = n || '';
        if (!name || name.toLowerCase() === 'visitor') return;
        const o = document.createElement('option');
        o.value = name;
        o.textContent = name + (name === me ? ' (you)' : '');
        sel.appendChild(o);
      });

      if (!res || !res.ok || !Array.isArray(res.coaches) || !res.coaches.length) {
        _setChatStatus('Using default coach list. Check Apps Script getCoachesList().', 5000);
      }
    })
    .withFailureHandler(() => {
      const sel = document.getElementById('chatTo');
      if (sel) {
        sel.innerHTML = '<option value="All">All coaches</option>';
        DEFAULT_CHAT_COACHES.forEach(name => {
          if (!name) return;
          const o = document.createElement('option');
          o.value = name;
          o.textContent = name;
          sel.appendChild(o);
        });
        sel.value = 'All';
      }
      try { console.warn('[chat] coach list failed, using defaults', DEFAULT_CHAT_COACHES); } catch (_) {}
      _setChatStatus('Coach list could not be loaded; using defaults.', 5000);
    })
    .getCoachesList();

  // start polling while chat panel is visible
  startChatPolling();

  const textEl = document.getElementById('chatText');
  if (textEl && !textEl.dataset.chatBind) {
    textEl.dataset.chatBind = '1';
    textEl.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
        e.preventDefault();
        sendChat();
      }
    });
  }

  _setChatStatus(CHAT_TIP_TEXT);
}

function startChatPolling(){
  stopChatPolling();
  _chatPollTimer = setInterval(() => {
    const chatPanel = document.getElementById('panel-chat');
    if (chatPanel && chatPanel.classList.contains('active')) {
      refreshChat(true);
    }
  }, CHAT_POLL_MS);
}
function stopChatPolling(){
  if (_chatPollTimer) clearInterval(_chatPollTimer);
  _chatPollTimer = null;
}

function refreshChat(isAuto = false) {
  const name = window.CURRENT_USER_NAME || '';
  if (!name) return;

  google.script.run
    .withSuccessHandler(res => {
      const list = document.getElementById('chatList');
      if (!list) return;
      const wasAtBottom = (list.scrollHeight - list.scrollTop - list.clientHeight) < 120;
      list.innerHTML = '';

      const rows = (res && res.ok && Array.isArray(res.rows)) ? res.rows : [];
      if (!rows.length) {
        list.innerHTML = '<div class="chat-empty">No messages yet.</div>';
        return;
      }

      const frag = document.createDocumentFragment();
      let newestTs = _chatLastSeenEpoch;
      let lastDayLabel = '';

      const chronological = rows.slice().sort((a,b) => (a.ts||0) - (b.ts||0));

      chronological.forEach(r => {
        const tsNum = Number(r.ts || 0);
        if (isFinite(tsNum)) newestTs = Math.max(newestTs, tsNum);

        const dt = isFinite(tsNum) ? new Date(tsNum) : null;
        const dayLabel = dt
          ? dt.toLocaleDateString('en-GB', { weekday:'short', day:'numeric', month:'short' })
          : (String(r.dateStr || '').split(' ')[0] || '');
        if (dayLabel && dayLabel !== lastDayLabel) {
          lastDayLabel = dayLabel;
          const divider = document.createElement('div');
          divider.className = 'chat-divider';
          divider.textContent = dayLabel;
          frag.appendChild(divider);
        }

        const mine = (String(r.from || '').toLowerCase() === name.toLowerCase());
        const row = document.createElement('div');
        row.className = `chat-row${mine ? ' mine' : ''}`;

        const meta = document.createElement('div');
        meta.className = 'chat-meta';
        const timeLabel = dt
          ? dt.toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit' })
          : (String(r.dateStr || '').split(' ')[1] || '');
        const toLabel = r.to ? (String(r.to).toLowerCase() === 'all' ? 'All coaches' : r.to) : 'All coaches';
        const fromLabel = mine ? 'You' : (r.from || 'Unknown');
        meta.textContent = `${fromLabel} → ${toLabel}${timeLabel ? ' • ' + timeLabel : ''}`;
        row.appendChild(meta);

        const bubble = document.createElement('div');
        bubble.className = 'chat-bubble';

        const msgStr = String(r.message || '').trim();
        if (msgStr) {
          const body = document.createElement('div');
          body.className = 'chat-message';
          body.textContent = msgStr;
          bubble.appendChild(body);
        }

        if (Array.isArray(r.attachments) && r.attachments.length) {
          const attachWrap = document.createElement('div');
          attachWrap.className = 'chat-attachments';

          const firstUrl = r.attachments[0];
          if (firstUrl) {
            const embedCard = document.createElement('div');
            embedCard.className = 'chat-attach-card';
            const embedWrap = document.createElement('div');
            embedWrap.className = 'embedWrap';
            const ifr = document.createElement('iframe');
            ifr.allow = 'autoplay; encrypted-media';
            ifr.referrerPolicy = 'no-referrer-when-downgrade';
            ifr.src = normalizeEmbedUrl(firstUrl, false);
            embedWrap.appendChild(ifr);
            embedCard.appendChild(embedWrap);
            attachWrap.appendChild(embedCard);
          }

          if (r.attachments.length > 1) {
            const links = document.createElement('div');
            links.className = 'chat-attach-links';
            r.attachments.slice(1).forEach((u, idx, arr) => {
              if (!u) return;
              const a = document.createElement('a');
              a.href = u;
              a.target = '_blank';
              a.rel = 'noopener';
              a.textContent = u;
              links.appendChild(a);
              if (idx < arr.length - 1) {
                links.appendChild(document.createElement('br'));
              }
            });
            attachWrap.appendChild(links);
          }

          bubble.appendChild(attachWrap);
        }

        row.appendChild(bubble);
        frag.appendChild(row);
      });

      list.appendChild(frag);
      if (!isAuto || wasAtBottom) {
        list.scrollTop = list.scrollHeight;
      }

      if (newestTs > _chatLastSeenEpoch) {
        _chatLastSeenEpoch = newestTs;
        try { localStorage.setItem('chatSeen:' + name, String(_chatLastSeenEpoch)); } catch (_) {}
      }

      if (isAuto && !document.getElementById('panel-chat').classList.contains('active')) {
        maybeAddChatNotification(rows);
      }
    })
    .withFailureHandler(_ => {
      const list = document.getElementById('chatList');
      if (list) list.innerHTML = '<div class="chat-empty">Failed to load chat.</div>';
      _setChatStatus('Failed to load chat.', 3000);
    })
    .getCoachMessages({ forName: name, sinceEpoch: 0, limit: 100 });
}





function sendChat(){
  const to = (document.getElementById('chatTo')?.value || 'All').trim();
  const text = (document.getElementById('chatText')?.value || '').trim();
  const from = window.CURRENT_USER_NAME || '';

  _setChatStatus('');
  if (!from) { _setChatStatus('You are not logged in.'); return; }
  if (!text) { _setChatStatus('Type a message.', 2400); return; }

  google.script.run
    .withSuccessHandler(res => {
      if (res && res.ok) {
        document.getElementById('chatText').value = '';
        refreshChat();
        document.getElementById('chatText')?.focus();
        _setChatStatus('Sent ✅', 2400);
      } else {
        _setChatStatus((res && res.error) ? res.error : 'Send failed.');
      }
    })
    .withFailureHandler(_ => {
      _setChatStatus('Send failed.');
    })
    .postCoachMessage({ from, to, message: text });
}



// restore last seen on load
window.addEventListener('load', () => {
  const me = window.CURRENT_USER_NAME || '';
  try { _chatLastSeenEpoch = Number(localStorage.getItem('chatSeen:'+me) || 0); } catch(_) {}
});




// --- Helper: build a compact auto-message line from clip meta
function _makeDiscussLine(url){
  const m = clipMetaByUrl.get(url) || {};
  const bits = [m.player, m.theme, m.subTag, m.type].filter(Boolean).join(' — ');
  const label = (m.dateStr ? (m.dateStr + ' — ') : '') + (bits || 'Clip');
  return `Discuss: ${label}`;
}

// --- Core: post 1+ clips to chat
function postClipsToChat(urls) {
  const from = window.CURRENT_USER_NAME || '';
  if (!from) { alert('Unlock first.'); return; }

  const toSel = document.getElementById('chatTo');
  const to = toSel && toSel.value ? toSel.value : 'All';

  const attachments = (Array.isArray(urls) ? urls : [urls]).filter(Boolean);
  if (!attachments.length) return;

  const first = attachments[0];
  const message = _makeDiscussLine(first) + (attachments.length > 1 ? ` (+${attachments.length-1} more)` : '');

  google.script.run
    .withSuccessHandler(res => {
      if (res && res.ok) {
        // Navigate to Chat tab and refresh so coaches see it immediately
        const chatTab = document.querySelector('.tab[data-tab="chat"]');
        if (chatTab) chatTab.click();
        setTimeout(() => refreshChat(), 150);
      } else {
        alert(res && res.error ? res.error : 'Failed to post to chat.');
      }
    })
    .withFailureHandler(() => alert('Failed to post to chat.'))
    .postCoachMessage({ from, to, message, attachments });
}

// --- UI hooks called from buttons
function discussClip(encUrl){
  const url = decodeURIComponent(encUrl || '');
  if (!url) return;
  postClipsToChat([url]);
}
function discussSelectedClips(){
  const urls = Array.from(selectedClipUrls);
  if (!urls.length) { alert('Select at least one clip.'); return; }
  postClipsToChat(urls);
}



/* -------------------- OPPONENTS -------------------- */
let _oppRows = [];

/* -------------------- OPPONENTS -------------------- */
/* -------------------- OPPONENTS -------------------- */
/* -------------------- OPPONENTS -------------------- */
function loadOpponents() {
  const sel = document.getElementById('oppSelect');
  if (sel) sel.innerHTML = '<option value="">Loading…</option>';

  runGSR('getOpponents', null, data => {
    if (!sel) return;
    sel.innerHTML = '<option value="">-- Select opponent --</option>';
    if (!data || !data.ok) return;

    (data.rows || []).forEach(r => {
      const team = (r && (r.team ?? (Array.isArray(r) ? r[0] : ''))) || '';
      if (!team) return;
      const opt = document.createElement('option');
      opt.value = team;
      opt.textContent = team;
      sel.appendChild(opt);
    });
  }, _ => {
    if (sel) sel.innerHTML = '<option value="">(failed to load)</option>';
  }, { retries: 3, baseDelayMs: 800 });
}

function openOpponentDetail(team) {
  const t = decodeURIComponent(team || '');  // <-- important
  const body = document.getElementById('oppDetailBody');
  if (body) body.innerHTML = '<div class="muted">Loading…</div>';

  runGSR('getOpponentDetail', t, d => renderOpponentDetail(d, t), _ => {
    if (body) body.innerHTML = '<div class="muted">Failed to load detail.</div>';
  }, { retries: 3, baseDelayMs: 800 });
}

function renderOpponentDetail(d, fallbackTeam) {
  const body = document.getElementById('oppDetailBody');
  if (!body) return;

  if (!d || !d.ok) {
    const title = escapeHtml(fallbackTeam || (d && d.team) || 'Opponent');
    body.innerHTML = `<div class="sectionTitle">${title}</div><div class="muted">No detail found.</div>`;
    return;
  }

  const team = escapeHtml(d.team || fallbackTeam || 'Opponent');

  const linkBtn = (label, url) => {
    if (!url) return '';
    const safe = escapeHtml(String(url));               // HTML-escape attribute
    return `<a href="#" data-url="${safe}" onclick="return openReportLink(this)">${label}</a>`;
  };

  const qReport = linkBtn('Quick report',      d.reportQuick);
  const fReport = linkBtn('Full report',       d.reportFull);
  const linksLine = [qReport, fReport].filter(Boolean).join(' • ');

  const offense = d.offense ? `
    <div class="sectionTitle">Offense</div>
    <div class="embedWrap"><iframe src="${normalizeEmbedUrl(d.offense, false)}" allow="autoplay; encrypted-media" allowfullscreen referrerpolicy="no-referrer-when-downgrade"></iframe></div>
  ` : '';

  const defense = d.defense ? `
    <div class="sectionTitle">Defense</div>
    <div class="embedWrap"><iframe src="${normalizeEmbedUrl(d.defense, false)}" allow="autoplay; encrypted-media" allowfullscreen referrerpolicy="no-referrer-when-downgrade"></iframe></div>
  ` : '';

  body.innerHTML = `
    <div class="sectionTitle" style="margin-top:0;">${team}</div>
    ${linksLine ? `<div class="muted" style="margin-bottom:8px;">${linksLine}</div>` : ''}
    ${offense}
    ${defense}
    ${(!offense && !defense) ? '<div class="muted">No videos available.</div>' : ''}
  `;
}





// Minimal wrapper with backoff for 429/transport hiccups
function runGSR(fnName, args, onSuccess, onError, opts) {
  const maxRetries = (opts && opts.retries) || 3;
  const baseDelay  = (opts && opts.baseDelayMs) || 600; // start at 0.6s

  function attempt(tryNo) {
    const call = google.script.run
      .withSuccessHandler(res => {
        // Treat "ok:false" as failure only if you want to retry
        if (res && res.ok === false && tryNo < maxRetries) {
          return setTimeout(() => attempt(tryNo + 1), baseDelay * Math.pow(2, tryNo));
        }
        onSuccess && onSuccess(res);
      })
      .withFailureHandler(err => {
        // Retry only for 429 or transient errors
        const msg = String(err && (err.message || err)).toLowerCase();
        const is429 = msg.includes('429') || msg.includes('rate') || msg.includes('too many');
        if (is429 && tryNo < maxRetries) {
          return setTimeout(() => attempt(tryNo + 1), baseDelay * Math.pow(2, tryNo));
        }
        onError ? onError(err) : console.error(fnName, 'failed:', err);
      });

    // call server fn
    if (args != null) call[fnName](args); else call[fnName]();
  }

  attempt(0);
}



function normalizeReportUrl(url) {
  const u = String(url || '').trim();
  if (!u) return '';

  // Google Drive file → preview
  let m = u.match(/drive\.google\.com\/file\/d\/([^/]+)/i);
  if (m) return `https://drive.google.com/file/d/${m[1]}/preview`;

  // Alternative Drive patterns (?id=...) or /view
  m = u.match(/[?&]id=([-\w]{20,})/i);
  if (m && /(drive|docs)\.google\.com/i.test(u)) return `https://drive.google.com/file/d/${m[1]}/preview`;
  if (/drive\.google\.com/i.test(u) && u.includes('/view')) return u.replace('/view', '/preview');

  // Direct pdf (any host) → let the browser render (add #toolbar=0 if you like)
  if (/\.pdf(\?|$)/i.test(u)) return `${u}#toolbar=0`;

  // Fallback to Google Docs viewer (works for many doc types + external pdf URLs)
  return `https://docs.google.com/gview?embedded=1&url=${encodeURIComponent(u)}`;
}

function openReportModal(url) {
  const src = normalizeReportUrl(url);
  const modal = document.getElementById('reportModal');
  const frame = document.getElementById('reportFrame');
  if (!modal || !frame) return;
  frame.src = src;
  modal.style.display = 'flex';
}

function closeReportModal() {
  const modal = document.getElementById('reportModal');
  const frame = document.getElementById('reportFrame');
  if (!modal || !frame) return;
  frame.src = '';
  modal.style.display = 'none';
}

// ESC to close
document.addEventListener('keydown', (e) => {
  const modal = document.getElementById('reportModal');
  if (e.key === 'Escape' && modal && modal.style.display !== 'none') {
    closeReportModal();
  }
});









/* -------------------- Stats tab -------------------- */
let _statsLoaded = false;
let _statsLeagueChart = null;
let _statsOpponentState = null;
let _statsOpponentChart = null;
let _statsOpponentShotChart = null;
let _statsOpponentFourChart = null;

function loadStats(force = false) {
  if (_statsLoaded && !force) return;
  const msg = document.getElementById('statsMsg');
  if (msg) msg.textContent = 'Loading…';

  google.script.run
    .withSuccessHandler(res => {
      if (!res || !res.ok) {
        if (msg) msg.textContent = res && res.error ? res.error : 'Failed to load stats.';
        return;
      }

      // 1️⃣ Render main stats
      renderStats(res);
      _statsLoaded = true;
      if (msg) msg.textContent = '';

      // 2️⃣ Fetch and render Team Alignment (Coaches vs Stats)
      google.script.run
        .withSuccessHandler(alignment => {
          if (!alignment || !alignment.ok) {
            const box = document.getElementById('teamAlignBox');
            if (box) box.innerHTML = `<div class="muted">Alignment unavailable</div>`;
            return;
          }
          renderTeamAlignment(alignment);
        })
        .withFailureHandler(err => {
          console.error('Alignment fetch failed:', err);
          const box = document.getElementById('teamAlignBox');
          if (box) box.innerHTML = `<div class="muted">Alignment error</div>`;
        })
        .getTeamIdentityAlignment();
    })
    .withFailureHandler(err => {
      if (msg) msg.textContent = 'Failed to load stats.';
      console.error('getStatsBundle error:', err);
    })
    .getStatsBundle();
}

// helpers
function pct(x, dp = 1) {
  if (x == null || isNaN(x)) return '—';
  return (Number(x) * 100).toFixed(dp) + '%';
}

function num(x, dp = 1) {
  if (x == null || isNaN(x)) return '—';
  return Number(x).toFixed(dp);
}



// map sheet headers → object keys on team row









function renderStats(data){
  renderStatsTeam(data.leagueTeams || [], data.team?.team || '');

  // Players + leaderboards
  renderStatsPlayers(data.players || []);
  renderStatsLeaders(data.leaders || {});
  renderStatsOpponentModule(data);
}

function renderStatsTeam(leagueTeams, ourTeamName){
  const card = document.getElementById('statsTeamBox');
  const canvas = document.getElementById('statsLeagueChart');
  if (!card || !canvas) return;

  const note = card.querySelector('[data-role="league-note"]');

  if (_statsLeagueChart) {
    try { _statsLeagueChart.destroy(); } catch (_) {}
    _statsLeagueChart = null;
  }

  const teams = (Array.isArray(leagueTeams) ? leagueTeams : []).map(t => {
    const adv = t.advanced || {};
    const ortg = Number(adv.ortg);
    const drtg = Number(adv.drtg);
    const ediff = Number(adv.ediff);
    if (!isFinite(ortg) || !isFinite(drtg)) return null;
    return {
      label: String(t.team || '').trim(),
      labelLc: String(t.team || '').trim().toLowerCase(),
      ortg,
      drtg,
      ediff: isFinite(ediff) ? ediff : 0
    };
  }).filter(Boolean);

  if (!teams.length) {
    canvas.style.display = 'none';
    if (note) note.textContent = 'League ratings unavailable for scatter plot.';
    return;
  }

  canvas.style.display = 'block';
  if (note) note.textContent = 'Bubble size reflects net rating (eDiff). Lower DRtg is better, so top-left is elite.';

  const ourName = (ourTeamName && String(ourTeamName).trim()) || 'Peristeri BC';
  const ourNameLc = ourName.toLowerCase();

  const makePoint = team => ({
    x: team.ortg,
    y: team.drtg,
    r: Math.max(5, Math.min(13, Math.abs(team.ediff || 0) * 1.1 + 5)),
    team: team.label,
    ediff: team.ediff
  });

  const ours = teams.filter(t => t.labelLc === ourNameLc).map(makePoint);
  const others = teams.filter(t => t.labelLc !== ourNameLc).map(makePoint);

  if (!ours.length && note) {
    note.textContent += ' (Peristeri BC bubble not present in this dataset.)';
  }

  const ctx = canvas.getContext('2d');
  _statsLeagueChart = new Chart(ctx, {
    type: 'bubble',
    data: {
      datasets: [
        {
          label: 'League',
          data: others,
          backgroundColor: 'rgba(120,130,160,0.55)',
          borderColor: '#6f7a98',
          borderWidth: 1,
          hoverBackgroundColor: 'rgba(120,130,160,0.75)'
        },
        {
          label: ourName,
          data: ours,
          backgroundColor: 'rgba(74,168,255,0.85)',
          borderColor: '#4aa8ff',
          borderWidth: 1.5,
          hoverBackgroundColor: 'rgba(74,168,255,1)'
        }
      ].filter(ds => ds.data.length)
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          title: { display: true, text: 'ORtg (Offensive Rating)' },
          grid: { color: 'rgba(255,255,255,0.08)' }
        },
        y: {
          title: { display: true, text: 'DRtg (Defensive Rating – lower is better)' },
          reverse: true,
          grid: { color: 'rgba(255,255,255,0.08)' }
        }
      },
      plugins: {
        legend: { position: 'bottom' },
        tooltip: {
          callbacks: {
            label: context => {
              const raw = context.raw || {};
              const lines = [raw.team || context.dataset.label];
              if (isFinite(raw.x)) lines.push(`ORtg: ${raw.x.toFixed(1)}`);
              if (isFinite(raw.y)) lines.push(`DRtg: ${raw.y.toFixed(1)}`);
              if (isFinite(raw.ediff)) lines.push(`Net: ${raw.ediff.toFixed(1)}`);
              return lines;
            }
          }
        }
      }
    }
  });
}

// helpers already in your file:
// --- Heat map helpers ---
function _computeRanges(players, keys) {
  const ranges = {};
  for (const k of keys) {
    const arr = players
      .map(p => _getStatValue(p, k))
      .filter(v => v != null && isFinite(v));
    if (arr.length) {
      ranges[k] = { min: Math.min(...arr), max: Math.max(...arr) };
    }
  }
  return ranges;
}

// normalize getting values (supports both "tovPct" and "TOV%" naming)
function _getStatValue(p, key) {
  if (key === 'tovPct') return p.tovPct ?? p['TOV%'] ?? null;
  return p[key] ?? null;
}

// color from red (bad) to green (good); invert flips the scale
function _heatColor(val, min, max, invert=false) {
  if (val == null || !isFinite(val) || min == null || max == null || min === max) return '';
  let t = (val - min) / (max - min);
  if (invert) t = 1 - t;                 // lower-is-better metrics
  const hue = Math.round(120 * t);       // 0=red -> 120=green
  return `hsla(${hue}, 90%, 45%, 0.22)`; // soft background
}

// apply to a <td>
function _paintCell(td, val, range, invert=false) {
  if (!td || !range) return;
  const bg = _heatColor(val, range.min, range.max, invert);
  if (bg) {
    td.style.background = bg;
    td.style.transition = 'background-color 0.25s ease';
  }
}














function renderStatsPlayers(players) {
  const tbody = document.querySelector('#statsPlayersTable tbody');
  if (!tbody) return;
  tbody.innerHTML = '';

  const HEAT_KEYS = [
    'threePar','fTr','pps','ts','usg','tovPct','ortg','drtg','ediff','per',
    'per36_pts','per36_reb','per36_ast','per36_stocks'
  ];
  const ranges = _computeRanges(players, HEAT_KEYS);

  const sorted = players.slice().sort((a,b)=>{
    const d1 = (b.per||0) - (a.per||0);
    if (d1 !== 0) return d1;
    return (b.ortg||0) - (a.ortg||0);
  });

  const frag = document.createDocumentFragment();
  sorted.forEach(p => {
    const tr = document.createElement('tr');
    const tovPctVal = (p.tovPct != null ? p.tovPct : p['TOV%']); 

   tr.innerHTML = `
  <td>${escapeHtml(_lastName(p.player))}</td>
  <td class="num">${num(p.mpg,1)}</td>
  <td class="num">${num(p.ppg,1)}</td>
  <td class="num">${num(p.fga,1)}</td>
  <td class="num">${num(p.pm3,1)}</td>
  <td class="num">${num(p.pa3,1)}</td>
  <td class="num">${p.threePar==null?'—':(p.threePar*100).toFixed(0)+'%'}</td>
  <td class="num">${p.fTr==null?'—':(p.fTr*100).toFixed(0)+'%'}</td>
  <td class="num">${num(p.pps,2)}</td>
  <td class="num">${p.ts==null?'—':(p.ts*100).toFixed(0)+'%'}</td>
  <td class="num">${p.usg==null?'—':num(p.usg,1)}</td>
  <td class="num">${tovPctVal==null?'—':num(tovPctVal,1)+'%'}</td>
  <td class="num">${num(p.ortg,1)}</td>
  <td class="num">${num(p.drtg,1)}</td>
  <td class="num">${num(p.per,1)}</td>
  <td class="num">${num(p.per36_pts,1)}</td>
  <td class="num">${num(p.per36_reb,1)}</td>
  <td class="num">${num(p.per36_ast,1)}</td>
  <td class="num">${num(p.per36_stocks,1)}</td>
`;

    const td = tr.querySelectorAll('td');

    _paintCell(td[6],  p.threePar, ranges.threePar, false);
    _paintCell(td[7],  p.fTr, ranges.fTr, false);
    _paintCell(td[8],  p.pps, ranges.pps, false);
    _paintCell(td[9],  p.ts, ranges.ts, false);
    _paintCell(td[10], p.usg, ranges.usg, false);
    _paintCell(td[11], tovPctVal, ranges.tovPct, true);
    _paintCell(td[12], p.ortg, ranges.ortg, false);
    _paintCell(td[13], p.drtg, ranges.drtg, true);
    _paintCell(td[14], p.ediff, ranges.ediff, false);
    _paintCell(td[15], p.per, ranges.per, false);
    _paintCell(td[16], p.per36_pts, ranges.per36_pts, false);
    _paintCell(td[17], p.per36_reb, ranges.per36_reb, false);
    _paintCell(td[18], p.per36_ast, ranges.per36_ast, false);
    _paintCell(td[19], p.per36_stocks, ranges.per36_stocks, false);

    // visual cue examples
    if (p.usg != null && p.ts != null && p.usg > 25 && p.ts < 0.55) {
      tr.style.boxShadow = 'inset 0 0 0 1px rgba(255,90,95,0.35)';
    }
    if (p.threePar != null && p.pa3 != null && p.pa3 >= 3 && p.threePar > 0.40) {
      tr.style.outline = '1px solid rgba(74,168,255,0.35)';
    }

    frag.appendChild(tr);
  });
  tbody.appendChild(frag);
}

function renderStatsLeaders(lb){
  const wrap = document.getElementById('statsLeaders');
  if (!wrap) return;

  const num = (v, dp=1) => (v==null || isNaN(v)) ? '—' : Number(v).toFixed(dp);
  const card = (title, arr, fmt=v=>num(v,1)) => `
    <div class="card" style="border:1px solid var(--border); border-radius:12px; padding:10px;">
      <div style="font-weight:600; margin-bottom:6px;">${title}</div>
      ${arr && arr.length ? arr.map(x=>`<div style="display:flex; justify-content:space-between; margin:2px 0;">
        <span>${escapeHtml(x.player)}</span><span class="num">${fmt(x.value)}</span>
      </div>`).join('') : '<div class="muted">—</div>'}
    </div>
  `;

// in renderStatsLeaders(...)
wrap.innerHTML = [
  // was: lb.coachAvg
  card('Coach Ratings (top 5)', lb.coachAvg, v=>num(v,1)),
  card('ORtg (top 5)', lb.ortg, v=>num(v,1)),
  card('DRtg (best 5, lower better)', lb.drtg_best, v=>num(v,1)),
  card('Per40 Points (top 5)', lb.per40_pts, v=>num(v,1)),
  card('Per40 Stocks (top 5)', lb.stocks40, v=>num(v,1))
].join('');
}

function renderStatsOpponentModule(data){
  const select = document.getElementById('statsOpponentSelect');
  const profile = document.getElementById('statsOpponentProfile');
  if (!select || !profile) return;

  _statsOpponentState = {
    teams: Array.isArray(data.leagueTeams) ? data.leagueTeams : [],
    leagueAdv: data.league || {},
    leaguePer: data.leaguePerGameAvg || {},
    ourAdv: data.team || {},
    ourPer: data.teamPerGame || {},
    ourName: (data.team && data.team.team) ? data.team.team : 'Peristeri BC'
  };

  const ourNameLC = (_statsOpponentState.ourName || '').toLowerCase();
  if (!_statsOpponentState.ourPer || !Object.keys(_statsOpponentState.ourPer).length) {
    const ownRow = _statsOpponentState.teams.find(t => String(t.team || '').toLowerCase() === ourNameLC);
    if (ownRow && ownRow.perGame) {
      _statsOpponentState.ourPer = ownRow.perGame;
    }
  }
  if (!_statsOpponentState.ourAdv || !Object.keys(_statsOpponentState.ourAdv).length) {
    const ownRow = _statsOpponentState.teams.find(t => String(t.team || '').toLowerCase() === ourNameLC);
    if (ownRow && ownRow.advanced) {
      _statsOpponentState.ourAdv = ownRow.advanced;
    }
  }
  const options = _statsOpponentState.teams
    .map(t => t.team)
    .filter(Boolean)
    .filter(name => name.toLowerCase() !== ourNameLC)
    .sort((a,b)=>a.localeCompare(b, undefined, { sensitivity:'base' }));

  const previous = select.dataset.selected || select.value || '';
  select.innerHTML = '<option value="">Select opponent…</option>' +
    options.map(name => `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`).join('');

  if (!select._bound) {
    select.addEventListener('change', (e) => updateStatsOpponentProfile(e.target.value));
    select._bound = true;
  }

  if (previous && options.includes(previous)) {
    select.value = previous;
  } else {
    select.value = '';
  }

  if (select.value) {
    updateStatsOpponentProfile(select.value);
  } else if (options.length) {
    select.value = options[0];
    select.dataset.selected = select.value;
    updateStatsOpponentProfile(select.value);
  } else {
    profile.classList.add('muted');
    profile.innerHTML = 'Pick a team to compare key metrics against league averages and Peristeri BC.';
  }
}

function updateStatsOpponentProfile(teamName){
  const profile = document.getElementById('statsOpponentProfile');
  const select = document.getElementById('statsOpponentSelect');
  if (select) select.dataset.selected = teamName || '';
  if (!profile) return;

  _resetOpponentChart();
  _resetShotChart();
  _resetFourChart();
  window._currentOpponentReport = null;
  window._currentOpponentReportText = null;

  if (!_statsOpponentState || !teamName) {
    profile.classList.add('muted');
    profile.innerHTML = 'Pick a team to compare key metrics against league averages and Peristeri BC.';
    return;
  }

  const entry = _statsOpponentState.teams.find(t => String(t.team || '').toLowerCase() === teamName.toLowerCase());
  if (!entry) {
    profile.classList.add('muted');
    profile.innerHTML = 'Team not found in stats table.';
    return;
  }

  teamName = entry.team || teamName;

  profile.classList.remove('muted');

  const ourName = _statsOpponentState.ourName || 'Peristeri BC';
  const leagueAdv = _statsOpponentState.leagueAdv || {};
  const leaguePer = _statsOpponentState.leaguePer || {};
  const ourAdv = _statsOpponentState.ourAdv || {};
  const ourPer = _statsOpponentState.ourPer || {};
  const perLeague = leaguePer || {};
  const perUs = ourPer || {};
  const advOpp = entry.advanced || {};
  const perOpp = entry.perGame || {};

  const pct = (v, dp=1) => (v == null || !isFinite(v) ? '—' : (v*100).toFixed(dp) + '%');
  const num = (v, dp=1) => (v == null || !isFinite(v) ? '—' : Number(v).toFixed(dp));
  const normalizePct = (val) => {
    if (val == null) return null;
    const n = Number(val);
    if (!isFinite(n)) return null;
    return Math.abs(n) > 1.5 ? n / 100 : n;
  };
  const computeEfg = (per) => {
    if (!per) return null;
    const fgm = Number(per.fgm);
    const fga = Number(per.fga);
    const three = Number(per.threePm);
    if (!isFinite(fgm) || !isFinite(fga) || !isFinite(three) || fga === 0) return null;
    return (fgm + 0.5 * three) / fga;
  };
  const computeTovPct = (per) => {
    if (!per) return null;
    const fga = Number(per.fga);
    const fta = Number(per.fta);
    const tov = Number(per.tov);
    const orb = Number(per.orb);
    if (!isFinite(fga) || !isFinite(fta) || !isFinite(tov) || !isFinite(orb)) return null;
    const denom = fga + 0.44 * fta + tov - orb;
    if (!isFinite(denom) || denom <= 0) return null;
    return tov / denom;
  };
  const computeOrbPct = (per) => {
    if (!per) return null;
    const orb = Number(per.orb);
    const rpg = Number(per.rpg);
    if (!isFinite(orb) || !isFinite(rpg) || rpg <= 0) return null;
    return orb / rpg;
  };
  const pickValue = (primary, fallback) => {
    const normPrimary = normalizePct(primary);
    if (normPrimary != null) return normPrimary;
    const normFallback = normalizePct(fallback);
    return normFallback != null ? normFallback : null;
  };

  const shotOpp = _calcShotSplit(perOpp);
  const shotLeague = _calcShotSplit(perLeague);
  const shotUs = _calcShotSplit(perUs);
  const ftRateOpp = _calcFtRate(perOpp);
  const ftRateLeague = _calcFtRate(perLeague);
  const ftRateUs = _calcFtRate(perUs);

const profileTags = [];
const pushTag = (cond, label, weight=1) => {
  if (!cond) return;
  if (!profileTags.some(tag => tag.label === label)) {
    profileTags.push({ label, score: weight });
  }
};

  const paceDiff = (advOpp.pace != null && leagueAdv.pace != null) ? advOpp.pace - leagueAdv.pace : null;
  const ortgDiffLeague = (advOpp.ortg != null && leagueAdv.ortg != null) ? advOpp.ortg - leagueAdv.ortg : null;
  const drtgDiffLeague = (advOpp.drtg != null && leagueAdv.drtg != null) ? advOpp.drtg - leagueAdv.drtg : null;
  const ediffOpp = Number(advOpp.ediff);

  const summaryCandidates = [];
  const seenSummary = new Set();
  const recordSummary = (score, text) => {
    if (score == null || !isFinite(score) || !text) return;
    if (seenSummary.has(text)) return;
    seenSummary.add(text);
    summaryCandidates.push({ abs: Math.abs(score), text });
  };
  const offenseNotes = [];
  const defenseNotes = [];
  const keysNotes = [];
  const risksNotes = [];
const addNote = (list, text) => {
  if (!text) return;
  if (!list.includes(text)) list.push(text);
};

  const fourFactors = [
    {
      key:'efg',
      label:'eFG%',
      opp: pickValue(advOpp.efg, computeEfg(perOpp)),
      league: pickValue(leagueAdv.efg, computeEfg(perLeague)),
      us: pickValue(ourAdv.efg, computeEfg(perUs)),
      isPct:true,
      dp:1
    },
    {
      key:'tovPct',
      label:'TOV%',
      opp: pickValue(advOpp.tovPct, computeTovPct(perOpp)),
      league: pickValue(leagueAdv.tovPct, computeTovPct(perLeague)),
      us: pickValue(ourAdv.tovPct, computeTovPct(perUs)),
      isPct:true,
      betterLower:true,
      dp:1
    },
    {
      key:'orbPct',
      label:'ORB%',
      opp: pickValue(advOpp.orbPct, computeOrbPct(perOpp)),
      league: pickValue(leagueAdv.orbPct, computeOrbPct(perLeague)),
      us: pickValue(ourAdv.orbPct, computeOrbPct(perUs)),
      isPct:true,
      dp:1
    },
    {
      key:'ftRate',
      label:'FT Rate',
      opp: _calcFtRate(perOpp),
      league: _calcFtRate(perLeague),
      us: _calcFtRate(perUs),
      isPct:true,
      dp:1
    }
  ];

  const efgDiffLeague = (fourFactors[0].opp != null && fourFactors[0].league != null) ? fourFactors[0].opp - fourFactors[0].league : null;
  const tovDiffLeague = (fourFactors[1].opp != null && fourFactors[1].league != null) ? fourFactors[1].opp - fourFactors[1].league : null;
  const orbPctDiffLeague = (fourFactors[2].opp != null && fourFactors[2].league != null) ? fourFactors[2].opp - fourFactors[2].league : null;
  const ftRateDiffLeague = (ftRateOpp != null && ftRateLeague != null) ? ftRateOpp - ftRateLeague : null;

  pushTag(paceDiff != null && paceDiff >= 3, 'Runs in transition', Math.abs(paceDiff));
  pushTag(paceDiff != null && paceDiff <= -3, 'Half-court grinder', Math.abs(paceDiff));
  pushTag(ftRateDiffLeague != null && ftRateDiffLeague >= 0.02, 'Foul-magnet offense', Math.abs(ftRateDiffLeague)*100);
  pushTag(ftRateDiffLeague != null && ftRateDiffLeague <= -0.02, 'Perimeter-leaning offense', Math.abs(ftRateDiffLeague)*100);
  pushTag(ftRateOpp != null && ftRateOpp >= 0.32, 'Attack-the-rim approach', ftRateOpp*100);
  pushTag(ftRateOpp != null && ftRateOpp <= 0.12, 'Low-contact scoring', (1-ftRateOpp)*100);
  if (shotOpp && shotLeague) {
    const threeGap = shotOpp.three != null && shotLeague.three != null ? shotOpp.three - shotLeague.three : null;
    const twoGap = shotOpp.two != null && shotLeague.two != null ? shotOpp.two - shotLeague.two : null;
    const ftShare = shotOpp.ft;
    pushTag(threeGap != null && threeGap >= 0.05, 'Arc-heavy attack', Math.abs(threeGap)*100);
    pushTag(twoGap != null && twoGap >= 0.06, 'Paint-first attack', Math.abs(twoGap)*100);
    pushTag(ftShare != null && ftShare >= 0.24, 'Lives at the stripe', ftShare*100);
    pushTag(threeGap != null && threeGap <= -0.05, 'Limited perimeter threat', Math.abs(threeGap)*100);
    pushTag(threeGap != null && threeGap >= 0.10 && ftShare != null && ftShare <= 0.18, 'Five-out spacing', Math.abs(threeGap)*100);
  }
  pushTag(efgDiffLeague != null && efgDiffLeague >= 0.025, 'High shot-quality offense', Math.abs(efgDiffLeague)*100);
  pushTag(efgDiffLeague != null && efgDiffLeague <= -0.025, 'Challenged shot-making', Math.abs(efgDiffLeague)*100);
  pushTag(tovDiffLeague != null && tovDiffLeague >= 0.01, 'Loose with the ball', Math.abs(tovDiffLeague)*100);
  pushTag(tovDiffLeague != null && tovDiffLeague <= -0.01, 'Secure ball handlers', Math.abs(tovDiffLeague)*100);
  pushTag(orbPctDiffLeague != null && orbPctDiffLeague >= 0.03, 'Crash offensive glass', Math.abs(orbPctDiffLeague)*100);
  pushTag(orbPctDiffLeague != null && orbPctDiffLeague <= -0.03, 'One-and-done defense', Math.abs(orbPctDiffLeague)*100);
  pushTag(ortgDiffLeague != null && ortgDiffLeague >= 2.5, 'Top-tier offense', Math.abs(ortgDiffLeague));
  pushTag(ortgDiffLeague != null && ortgDiffLeague <= -2.5, 'Scoring-challenged', Math.abs(ortgDiffLeague));
  pushTag(drtgDiffLeague != null && drtgDiffLeague <= -2.0, 'Stingy defense', Math.abs(drtgDiffLeague));
  pushTag(drtgDiffLeague != null && drtgDiffLeague >= 2.0, 'Defensive leaks', Math.abs(drtgDiffLeague));
  pushTag(ediffOpp != null && ediffOpp >= 3, 'Positive net-rating squad', Math.abs(ediffOpp));
  pushTag(ediffOpp != null && ediffOpp <= -3, 'Negative net-rating squad', Math.abs(ediffOpp));

  fourFactors.forEach(f => {
    const diffLeague = (f.opp != null && f.league != null) ? f.opp - f.league : null;
    const threshold = f.isPct ? 0.02 : 0.6;
    if (diffLeague != null && Math.abs(diffLeague) >= threshold) {
      const dir = diffLeague > 0 ? 'higher' : 'lower';
      const val = f.isPct ? (diffLeague*100).toFixed(1) + 'pp' : diffLeague.toFixed(1);
      recordSummary(diffLeague * (f.isPct ? 100 : 1), `${teamName} ${dir} than league in ${f.label} by ${val}.`);
      if (f.key === 'efg') addNote(offenseNotes, `eFG% ${dir === 'higher' ? '+' : ''}${val} vs league.`);
      if (f.key === 'ftRate') addNote(offenseNotes, `FT rate ${dir === 'higher' ? '+' : ''}${val} vs league.`);
      if (f.key === 'tovPct') addNote(defenseNotes, `Turnover rate ${dir === 'higher' ? '+' : ''}${val} vs league (lower is better).`);
      if (f.key === 'orbPct') addNote(keysNotes, `Offensive rebounding ${dir === 'higher' ? '+' : ''}${val} vs league.`);
    }
  });
  const efgDiffUs = (fourFactors[0].opp != null && fourFactors[0].us != null) ? fourFactors[0].opp - fourFactors[0].us : null;
  if (efgDiffUs != null && Math.abs(efgDiffUs) >= 0.015) {
    const val = (efgDiffUs*100).toFixed(1) + 'pp';
    const tone = efgDiffUs > 0 ? 'ahead of' : 'below';
    addNote(keysNotes, `Their eFG% sits ${val} ${tone} ${ourName}.`);
  }
  const tovDiffUs = (fourFactors[1].opp != null && fourFactors[1].us != null) ? fourFactors[1].opp - fourFactors[1].us : null;
  if (tovDiffUs != null && Math.abs(tovDiffUs) >= 0.01) {
    const val = Math.abs(tovDiffUs*100).toFixed(1) + 'pp';
    const tone = tovDiffUs > 0 ? 'higher' : 'lower';
    addNote(defenseNotes, `Turnover rate is ${val} ${tone} than ${ourName}'s.`);
  }

  const shotMetrics = [
    { key:'two', label:'Inside the arc', color:'linear-gradient(90deg,#4aa8ff,#2d6ff5)', metric:{ isPct:true, dp:1 } },
    { key:'three', label:'3-point line', color:'linear-gradient(90deg,#ffb020,#ff7a45)', metric:{ isPct:true, dp:1 } },
    { key:'ft', label:'Free throws', color:'linear-gradient(90deg,#10b981,#0f7f5f)', metric:{ isPct:true, dp:1 } }
  ].map(row => Object.assign(row, {
    opp: shotOpp ? shotOpp[row.key] : null,
    league: shotLeague ? shotLeague[row.key] : null,
    us: shotUs ? shotUs[row.key] : null
  }));

  let shotMessage = '';
  if (shotOpp && shotLeague) {
    const diffs = shotMetrics
      .filter(r => r.opp != null && r.league != null)
      .map(r => ({ key:r.key, label:r.label, diff:r.opp - r.league }));
    if (diffs.length) {
      diffs.sort((a,b)=> Math.abs(b.diff) - Math.abs(a.diff));
      const top = diffs[0];
      if (Math.abs(top.diff) >= 0.05) {
        const dir = top.diff > 0 ? 'more' : 'less';
        const amount = Math.abs(top.diff*100).toFixed(1);
        shotMessage = `Expect ${teamName} to generate ${amount}pp ${dir} scoring from ${top.label.toLowerCase()} than the league norm.`;
        recordSummary(top.diff*100, shotMessage);
      }
    }
  }
  if (shotMessage) addNote(offenseNotes, shotMessage);
  if (shotOpp) {
    const dominant = shotMetrics.reduce((best, row) => {
      if (row.opp == null) return best;
      if (!best || row.opp > best.opp) return row;
      return best;
    }, null);
    if (dominant) {
      addNote(offenseNotes, `${pct(dominant.opp,1)} of their points come from ${dominant.label.toLowerCase()}.`);
    }
  }
  const shotAvailable = shotMetrics.some(r => r.opp != null || r.league != null || r.us != null);
  const fourAvailable = fourFactors.some(f => f.opp != null || f.league != null || f.us != null);

  let ftNote = null;
  if (ftRateOpp != null && ftRateLeague != null) {
    const ftDiff = ftRateOpp - ftRateLeague;
    if (Math.abs(ftDiff) >= 0.02) {
      const amount = Math.abs(ftDiff*100).toFixed(1);
      if (ftDiff > 0) {
        ftNote = `${teamName} earn ${amount}pp more free throws than league average (FT rate ${pct(ftRateOpp)}).`;
      } else {
        ftNote = `${teamName} reach the line ${amount}pp less often than the league (FT rate ${pct(ftRateOpp)}).`;
      }
      recordSummary(ftDiff*100, ftNote);
    }
  }
  if (ftNote) addNote(offenseNotes, ftNote);

  const spgDiff = (perOpp.spg != null && perLeague.spg != null) ? perOpp.spg - perLeague.spg : null;
  const ownTovDiff = (perOpp.tov != null && perLeague.tov != null) ? perLeague.tov - perOpp.tov : null;
  let pressureScore = 0;
  if (spgDiff != null) pressureScore += spgDiff;
  if (ownTovDiff != null) pressureScore += ownTovDiff * 0.5;
  let pressureNote = null;
  if (pressureScore >= 1.5) {
    pressureNote = 'Expect heavy ball-pressure: steals are up and they protect the ball.';
  } else if (pressureScore <= -1) {
    pressureNote = 'They produce few turnovers—pressure looks manageable.';
  }
  if (pressureScore !== 0) recordSummary(pressureScore, pressureNote);
  pushTag(pressureScore >= 1.5, 'Forces turnovers');
  pushTag(pressureScore <= -1, 'Low-pressure defense');
  if (pressureNote) addNote(defenseNotes, pressureNote);

  const orbDiff = (perOpp.orb != null && perUs.orb != null) ? perOpp.orb - perUs.orb : null;
  const drbDiff = (perOpp.drb != null && perUs.drb != null) ? perOpp.drb - perUs.drb : null;
  let reboundNote = null;
  if (orbDiff != null && Math.abs(orbDiff) >= 1) {
    reboundNote = orbDiff > 0 ? 'Their offensive glass is a problem—limit second chances.' : 'They concede the offensive glass—attack the boards.';
    recordSummary(orbDiff, reboundNote);
  }
  if (drbDiff != null && Math.abs(drbDiff) >= 1 && Math.abs(orbDiff || 0) < Math.abs(drbDiff)) {
    const msg = drbDiff > 0 ? 'They clean the defensive glass well.' : 'We can win the defensive glass battle.';
    reboundNote = msg;
    recordSummary(drbDiff, msg);
  }
  if (reboundNote) addNote(keysNotes, reboundNote);
  pushTag(orbDiff != null && orbDiff >= 1, 'Second-chance seekers', Math.abs(orbDiff));
  pushTag(orbDiff != null && orbDiff <= -1, 'Transition-ready (limited ORB)', Math.abs(orbDiff));

  const paceDiffVsUs = (advOpp.pace != null && ourAdv.pace != null) ? advOpp.pace - ourAdv.pace : null;
  let paceNote = null;
  if (paceDiffVsUs != null && Math.abs(paceDiffVsUs) >= 3) {
    paceNote = paceDiffVsUs > 0 ? `They play ${paceDiffVsUs.toFixed(1)} possessions faster—control transition.` : `They slow the game by ${Math.abs(paceDiffVsUs).toFixed(1)} possessions—be ready to create pace.`;
    recordSummary(paceDiffVsUs, paceNote);
  }
  if (paceNote) addNote(keysNotes, paceNote);

  const disciplineOpp = (perOpp.pf || 0) + (perOpp.tov || 0);
  const disciplineLeague = (perLeague.pf || 0) + (perLeague.tov || 0);
  let disciplineNote = null;
  if (disciplineOpp && disciplineLeague) {
    const disciplineDiff = disciplineOpp - disciplineLeague;
    if (Math.abs(disciplineDiff) >= 2) {
      disciplineNote = disciplineDiff > 0 ? 'Late-game discipline risk: fouls + turnovers trend high.' : 'They stay composed late (low fouls + turnovers).';
      recordSummary(disciplineDiff, disciplineNote);
    }
  }
  if (disciplineNote) addNote(risksNotes, disciplineNote);
  pushTag(disciplineNote && disciplineNote.includes('risk'), 'Discipline risk');
  pushTag(disciplineNote && disciplineNote.includes('composed'), 'Composed finishers');

  summaryCandidates.sort((a,b) => b.abs - a.abs);
  summaryCandidates.slice(0, 2).forEach(item => {
    if (offenseNotes.includes(item.text) || defenseNotes.includes(item.text) || risksNotes.includes(item.text)) return;
    addNote(keysNotes, item.text);
  });

  if (!profileTags.length) profileTags.push({ label:'Well-rounded', score:1 });
  profileTags.sort((a,b) => (b.score - a.score));
  const tagLimit = Math.min(5, profileTags.length);
  const tagObjects = profileTags.slice(0, tagLimit);
  const tagsHtml = `<div class="profile-tag-row">${tagObjects.map((tagObj, idx) => `<span class="profile-tag${idx===0?' featured':''}">${escapeHtml(tagObj.label)}</span>`).join('')}</div>`;

  const renderNoteList = (notes, emptyLabel) => {
    if (notes.length) {
      return `<ul>${notes.slice(0,4).map(n => `<li>${escapeHtml(n)}</li>`).join('')}</ul>`;
    }
    return `<div class="muted">${escapeHtml(emptyLabel)}</div>`;
  };

  window._currentOpponentReport = {
    teamName,
    ourName,
    tags: tagObjects.map((tag, idx) => ({ label: tag.label, featured: idx === 0 })),
    shot: shotOpp ? { two: shotOpp.two, three: shotOpp.three, ft: shotOpp.ft } : null,
    fourFactors: fourFactors.map(f => ({
      label: f.label,
      opp: f.opp,
      league: f.league,
      us: f.us,
      isPct: f.isPct,
      dp: f.dp
    })),
    offenseNotes: [...offenseNotes],
    defenseNotes: [...defenseNotes],
    keysNotes: [...keysNotes],
    risksNotes: [...risksNotes]
  };
  window._currentOpponentReportText = null;

  profile.innerHTML = `
    <div style="font-weight:600; font-size:15px;">${escapeHtml(teamName)}</div>
    <div class="muted" style="font-size:12px;">Profile comparisons with league + ${escapeHtml(ourName)}</div>
    <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:12px;">
      ${tagsHtml}
      <button class="btn" type="button" onclick="openOpponentReport()">Create statistical report</button>
    </div>
    <div class="opp-chart-row">
      <div class="opp-chart-wrap">
        <canvas id="statsOppRadar" height="220"></canvas>
      </div>
      <div class="shot-chart-wrap">
        <div class="sectionTitle" style="margin:0 0 6px;">Shot Distribution</div>
        ${shotAvailable ? '<canvas id="statsOppShot" height="220"></canvas>' : '<div class="muted">Insufficient shot data.</div>'}
        ${shotMessage ? `<div class="muted" style="font-size:12px; margin-top:6px;">${escapeHtml(shotMessage)}</div>` : ''}
      </div>
      <div class="four-chart-wrap">
        <div class="sectionTitle" style="margin:0 0 6px;">Four Factors</div>
        ${fourAvailable ? '<canvas id="statsOppFour" height="220"></canvas>' : '<div class="muted">Insufficient four-factor data.</div>'}
      </div>
    </div>
  `;

  const radarMetrics = [
    { label:'ORtg', opp: advOpp.ortg, us: ourAdv.ortg, league: leagueAdv.ortg, invert:false, dp:1 },
    { label:'DRtg (inv)', opp: advOpp.drtg, us: ourAdv.drtg, league: leagueAdv.drtg, invert:true, dp:1 },
    { label:'Net Rating', opp: advOpp.ediff, us: ourAdv.ediff, league: leagueAdv.ediff, invert:false, dp:1 },
    { label:'Pace', opp: advOpp.pace, us: ourAdv.pace, league: leagueAdv.pace, invert:false, dp:1 },
    { label:'TS%', opp: advOpp.ts, us: ourAdv.ts, league: leagueAdv.ts, invert:false, isPct:true, dp:1 }
  ];

  const ctx = document.getElementById('statsOppRadar');
  if (ctx && typeof Chart !== 'undefined') {
    const labels = radarMetrics.map(m => m.label);
    const oppData = radarMetrics.map(m => _radarScore(m.opp, m.league, m.invert) || 1);
    const usData = radarMetrics.map(m => _radarScore(m.us, m.league, m.invert) || 1);

    _statsOpponentChart = new Chart(ctx, {
      type: 'radar',
      data: {
        labels,
        datasets: [
          {
            label: teamName,
            data: oppData,
            meta: radarMetrics.map(m => m.opp),
            backgroundColor: 'rgba(255,176,32,0.18)',
            borderColor: '#ffb020',
            pointBackgroundColor: '#ffb020'
          },
          {
            label: ourName,
            data: usData,
            meta: radarMetrics.map(m => m.us),
            backgroundColor: 'rgba(74,168,255,0.18)',
            borderColor: '#4aa8ff',
            pointBackgroundColor: '#4aa8ff'
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          r: {
            min: 0.6,
            max: 1.4,
            ticks: { display: false },
            grid: { color: 'rgba(255,255,255,0.35)' },
            angleLines: { color: 'rgba(255,255,255,0.45)' },
            pointLabels: { color: '#f5f7ff' }
          }
        },
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            callbacks: {
              label: context => {
                const dataset = context.dataset;
                const raw = dataset.meta && dataset.meta[context.dataIndex];
                const metric = radarMetrics[context.dataIndex];
                const formatted = metric.isPct ? pct(raw) : num(raw, metric.dp || 1);
                return `${dataset.label}: ${formatted}`;
              }
            }
          }
        }
      }
    });
  }

  if (shotAvailable) {
    const shotCtx = document.getElementById('statsOppShot');
    if (shotCtx && typeof Chart !== 'undefined') {
      const labels = shotMetrics.map(m => m.label);
      const toPercentData = (source) => shotMetrics.map(m => m[source] != null ? (m[source] * 100) : null);
      _statsOpponentShotChart = new Chart(shotCtx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: teamName,
              data: toPercentData('opp'),
              backgroundColor: 'rgba(255,176,32,0.6)',
              borderColor: '#ffb020',
              borderWidth:1
            },
            {
              label: 'League Avg',
              data: toPercentData('league'),
              backgroundColor: 'rgba(80,105,255,0.55)',
              borderColor: '#5069ff',
              borderWidth:1
            },
            {
              label: ourName,
              data: toPercentData('us'),
              backgroundColor: 'rgba(74,168,255,0.45)',
              borderColor: '#4aa8ff',
              borderWidth:1
            }
          ]
        },
        options: {
          responsive: true,
          indexAxis: 'y',
          scales: {
            x: {
              min: 0,
              max: 100,
              ticks: {
                callback: value => value + '%'
              },
              grid: { color:'rgba(255,255,255,0.08)' }
            },
            y: {
              grid: { color:'rgba(255,255,255,0.08)' }
            }
          },
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: context => {
                  const val = context.raw;
                  if (val == null || !isFinite(val)) return `${context.dataset.label}: —`;
                  return `${context.dataset.label}: ${Number(val).toFixed(1)}%`;
                }
              }
            }
          }
        }
      });
    }
  }

  const fourCtx = document.getElementById('statsOppFour');
  if (fourAvailable && fourCtx && typeof Chart !== 'undefined') {
    const labels = fourFactors.map(f => f.label);
    const toPercent = (val, metric) => {
      if (val == null) return null;
      const scaled = metric.isPct ? val * 100 : val;
      return scaled;
    };
    _statsOpponentFourChart = new Chart(fourCtx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          {
            label: teamName,
            data: fourFactors.map(f => toPercent(f.opp, f)),
            backgroundColor: 'rgba(255,176,32,0.6)',
            borderColor: '#ffb020',
            borderWidth:1
          },
          {
            label: 'League Avg',
            data: fourFactors.map(f => toPercent(f.league, f)),
            backgroundColor: 'rgba(80,105,255,0.55)',
            borderColor: '#5069ff',
            borderWidth:1
          },
          {
            label: ourName,
            data: fourFactors.map(f => toPercent(f.us, f)),
            backgroundColor: 'rgba(74,168,255,0.45)',
            borderColor: '#4aa8ff',
            borderWidth:1
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: (value, index, values) => {
                const metric = fourFactors[index % fourFactors.length];
                if (metric && metric.isPct) return value + '%';
                return value;
              }
            },
            grid: { color:'rgba(255,255,255,0.08)' }
          },
          x: {
            grid: { color:'rgba(255,255,255,0.08)' }
          }
        },
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: context => {
                const metric = fourFactors[context.dataIndex];
                const raw = context.raw;
                if (raw == null || !isFinite(raw)) return `${context.dataset.label}: —`;
                const value = metric && metric.isPct ? Number(raw).toFixed(1) + '%' : Number(raw).toFixed(2);
                return `${context.dataset.label}: ${value}`;
              }
            }
          }
        }
      }
    });
  }
}

function _formatStatValue(val, metric){
  if (val == null || isNaN(val)) return '—';
  const dp = (metric && typeof metric.dp === 'number') ? metric.dp : 1;
  if (metric && metric.isPct) {
    return (val * 100).toFixed(dp) + '%';
  }
  return Number(val).toFixed(dp);
}

function _diffChip(val, ref, metric){
  if (val == null || ref == null || isNaN(val) || isNaN(ref)) return '';
  let diff = val - ref;
  let scaled = diff;
  if (metric && metric.isPct) scaled = diff * 100;
  const threshold = metric && metric.isPct ? 0.2 : 0.1;
  if (Math.abs(scaled) < threshold) return `<span class="diff-chip neutral">≈0</span>`;
  const displayDp = metric && typeof metric.dp === 'number' ? metric.dp : 1;
  const text = `${diff > 0 ? '+' : ''}${scaled.toFixed(displayDp)}${metric && metric.isPct ? 'pp' : ''}`;
  const positive = metric && metric.betterLower ? diff < 0 : diff > 0;
  const cls = positive ? 'pos' : 'neg';
  return `<span class="diff-chip ${cls}">${text}</span>`;
}

function _resetOpponentChart(){
  if (_statsOpponentChart) {
    try { _statsOpponentChart.destroy(); } catch (_) {}
    _statsOpponentChart = null;
  }
}

function _resetShotChart(){
  if (_statsOpponentShotChart) {
    try { _statsOpponentShotChart.destroy(); } catch (_) {}
    _statsOpponentShotChart = null;
  }
}

function _resetFourChart(){
  if (_statsOpponentFourChart) {
    try { _statsOpponentFourChart.destroy(); } catch (_) {}
    _statsOpponentFourChart = null;
  }
}

function buildOpponentReportText(data){
  if (!data) return '';
  const formatVal = (val, metric) => {
    if (val == null || !isFinite(val)) return '—';
    const dp = (metric && typeof metric.dp === 'number') ? metric.dp : 1;
    if (metric && metric.isPct) return (val * 100).toFixed(dp) + '%';
    return Number(val).toFixed(dp);
  };
  const formatDiff = (metric, valA, valB) => {
    if (valA == null || valB == null || !isFinite(valA) || !isFinite(valB)) return '—';
    const diff = valA - valB;
    const dp = (metric && typeof metric.dp === 'number') ? metric.dp : 1;
    const scaled = metric && metric.isPct ? diff * 100 : diff;
    const suffix = metric && metric.isPct ? 'pp' : '';
    return `${scaled >= 0 ? '+' : ''}${Number(scaled).toFixed(dp)}${suffix}`;
  };
  const blockText = (title, items) => {
    const arr = (items || []).filter(Boolean);
    if (!arr.length) return `${title}\n - None.`;
    return `${title}\n${arr.map(n => ` - ${n}`).join('\n')}`;
  };

  const lines = [];
  lines.push(`Opponent: ${data.teamName}`);
  if (data.tags && data.tags.length) {
    const featured = data.tags.find(t => t.featured);
    lines.push(`Profile tags: ${data.tags.map(t => t.label).join(', ')}${featured ? ` (focus: ${featured.label})` : ''}`);
  }

  if (data.shot) {
    lines.push(`Shot distribution: Paint ${pct(data.shot.two,1)}, 3PT ${pct(data.shot.three,1)}, FT ${pct(data.shot.ft,1)}`);
  } else {
    lines.push('Shot distribution: data unavailable.');
  }

  if (data.fourFactors && data.fourFactors.length) {
    const mapLines = data.fourFactors.map(f => {
      const oppVal = formatVal(f.opp, f);
      const leagueVal = formatVal(f.league, f);
      const usVal = formatVal(f.us, f);
      const diffLg = formatDiff(f, f.opp, f.league);
      const diffUs = formatDiff(f, f.opp, f.us);
      return ` - ${f.label}: ${oppVal} (League ${leagueVal}, ${diffLg} vs league, ${diffUs} vs ${data.ourName})`;
    }).join('\n');
    lines.push(`Four Factors vs league:\n${mapLines}`);
  }

  lines.push(blockText('Offense summary', data.offenseNotes));
  lines.push(blockText('Pressure & defense', data.defenseNotes));
  lines.push(blockText(`Plan vs ${data.ourName}`, data.keysNotes));
  lines.push(blockText('Areas to monitor', data.risksNotes));

  return lines.join('\n\n');
}

function openOpponentReport(){
  const modal = document.getElementById('opponentReportModal');
  const textarea = document.getElementById('opponentReportText');
  if (!modal || !textarea) return;
  if (!window._currentOpponentReport) {
    alert('Load an opponent to generate a report first.');
    return;
  }
  const text = window._currentOpponentReportText || buildOpponentReportText(window._currentOpponentReport);
  window._currentOpponentReportText = text;
  textarea.value = text;
  modal.style.display = 'flex';
}

function closeOpponentReport(){
  const modal = document.getElementById('opponentReportModal');
  if (modal) modal.style.display = 'none';
}

function copyOpponentReport(btn){
  if (!window._currentOpponentReport) {
    alert('No report available to copy.');
    return;
  }
  const text = window._currentOpponentReportText || buildOpponentReportText(window._currentOpponentReport);
  if (navigator && navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text)
      .then(() => {
        if (btn) {
          const original = btn.textContent;
          btn.textContent = 'Copied!';
          setTimeout(() => btn.textContent = original, 1600);
        }
      })
      .catch(() => alert('Copy failed.')); 
  } else {
    const textarea = document.getElementById('opponentReportText');
    if (textarea) {
      textarea.value = text;
      textarea.focus();
      textarea.select();
      document.execCommand('copy');
    }
    if (btn) {
      const original = btn.textContent;
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = original, 1600);
    }
  }
}

function _radarScore(val, baseline, invert){
  if (val == null || baseline == null || !isFinite(val) || !isFinite(baseline) || baseline === 0) return 1;
  const ratio = invert ? baseline / val : val / baseline;
  return Math.max(0.5, Math.min(1.5, ratio));
}

function _calcFtRate(per){
  if (!per) return null;
  const fta = per.fta != null ? Number(per.fta) : null;
  const fga = per.fga != null ? Number(per.fga) : null;
  if (fta == null || fga == null || !isFinite(fta) || !isFinite(fga) || fga === 0) return null;
  return fta / fga;
}

function _calcShotSplit(per){
  if (!per) return null;
  const toRatio = (val) => {
    if (val == null) return null;
    const n = Number(val);
    if (!isFinite(n)) return null;
    return Math.abs(n) > 1.5 ? n / 100 : n;
  };
  const fgm = per.fgm != null ? Number(per.fgm) : null;
  let three = per.threePm != null ? Number(per.threePm) : null;
  let ftm = per.ftm != null ? Number(per.ftm) : null;
  if ((three == null || !isFinite(three)) && per.threePa != null && per.threePct != null) {
    const pa = Number(per.threePa);
    const pct = toRatio(per.threePct);
    if (isFinite(pa) && pct != null) three = pa * pct;
  }
  if ((ftm == null || !isFinite(ftm)) && per.fta != null && per.ftPct != null) {
    const fta = Number(per.fta);
    const pct = toRatio(per.ftPct);
    if (isFinite(fta) && pct != null) ftm = fta * pct;
  }
  if (fgm == null || !isFinite(fgm) || three == null || !isFinite(three) || ftm == null || !isFinite(ftm)) return null;
  const two = fgm - three;
  const pointsTwo = Math.max(0, two * 2);
  const pointsThree = Math.max(0, three * 3);
  const pointsFt = Math.max(0, ftm);
  const total = pointsTwo + pointsThree + pointsFt;
  if (!isFinite(total) || total <= 0) return null;
  const sum = pointsTwo + pointsThree + pointsFt || 1;
  return {
    two: pointsTwo / sum,
    three: pointsThree / sum,
    ft: pointsFt / sum,
    totalPoints: total
  };
}

// hook into your tab system
(function hookStatsTab(){
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.tab[data-tab="stats"]');
    if (!btn) return;
    setTimeout(() => loadStats(), 0);
  });
})();

// utilities already in your file; add escapeHtml if missing
function escapeHtml(s){
  return String(s||'')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}





function _lastName(name) {
  if (!name) return '';
  const parts = String(name).trim().split(/\s+/);
  return parts.length ? parts[parts.length - 1] : name;
}






function renderTeamAlignment(teamAlign, leagueRows, teamRow) {
  const box = document.getElementById('teamAlignBox');
  if (!box) return;

  const rows = (teamAlign && teamAlign.rows) ? teamAlign.rows : [];
  const num = (v)=> (v==null || v==='') ? null : Number(String(v).replace(',','.'));

  const pctFmt = (x)=> (x==null || isNaN(x)) ? '—' : (Number(x)*100).toFixed(1)+'%';
  const numFmt = (x,dp=1)=> (x==null || isNaN(x)) ? '—' : Number(x).toFixed(dp);
  const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));

  const TRAIT_MAP = {
    execution:     { label:'Execution',     metric:'ORtg',  invert:false, fmt: (x)=> numFmt(x,1) },
    energy:        { label:'Energy',        metric:'Pace',  invert:false, fmt: (x)=> numFmt(x,1) },
    communication: { label:'Communication', metric:'eFG%',  invert:false, fmt: pctFmt },
    adaptability:  { label:'Adaptability',  metric:'TS%',   invert:false, fmt: pctFmt },
    resilience:    { label:'Resilience',    metric:'DRtg',  invert:true,  fmt: (x)=> numFmt(x,1) },
    impact:        { label:'Impact',        metric:'eDiff', invert:false, fmt: (x)=> numFmt(x,1) },
    overall:       { label:'Overall',       metric:'eDiff', invert:false, fmt: (x)=> numFmt(x,1) }
  };

  const TIP = {
    execution:     "Execution = Offensive Rating (ORtg). Higher is better.",
    energy:        "Energy = Pace (possessions per game). Higher is more tempo/activity.",
    communication: "Communication = eFG% (shot quality often driven by ball movement). Higher is better.",
    adaptability:  "Adaptability = TS% (overall scoring efficiency across roles). Higher is better.",
    resilience:    "Resilience = DRtg (points allowed per 100). Lower is better.",
    impact:        "Impact = eDiff (ORtg − DRtg). Higher is better.",
    overall:       "Overall = eDiff proxy. Higher is better."
  };

  function canonTrait(k){
    switch((k||'').toLowerCase()){
      case 'exec':
      case 'execution': return 'execution';
      case 'energy': return 'energy';
      case 'comm':
      case 'communication': return 'communication';
      case 'adapt':
      case 'adaptability': return 'adaptability';
      case 'res':
      case 'resilience': return 'resilience';
      case 'impact': return 'impact';
      case 'overall': return 'overall';
      default: return 'overall';
    }
  }

  // Build table rows
  const tr = rows.map(r=>{
    const key = canonTrait(r.trait);
    const tip = TIP[key] || '';
    const coach = (r.coach==null) ? '—' : r.coach.toFixed(2);
    const stat  = (r.stat==null)  ? '—' : r.stat.toFixed(2);
    const d     = r.diff;
    const diff  = (d==null) ? '—' : ((d>=0?'+':'') + d.toFixed(2));
    const color = (d==null) ? '' : (d>=0 ? 'var(--warn)' : 'var(--ok)');
    return `
      <tr>
        <td class="trait has-tip" data-tip="${escapeHtml(tip)}">${escapeHtml(r.trait)}</td>
        <td class="num">${coach}</td>
        <td class="num">${stat}</td>
        <td class="num" style="font-weight:600; color:${color};">${diff}</td>
      </tr>`;
  }).join('');

  // Generate short “next steps”
  const nextLines = rows
    .filter(r => r.diff < 0)
    .map(r => {
      const key = canonTrait(r.trait);
      const map = TRAIT_MAP[key] || TRAIT_MAP.overall;
      return `<li>${map.label}: improve ${map.metric} by ~${Math.abs(r.diff*3).toFixed(1)}% to match coach rating.</li>`;
    })
    .join('');

  // --- Compact Card Layout ---
  box.innerHTML = `
    <div class="card" style="
        margin-top:8px;
        padding:10px 14px;
        border:1px solid var(--border);
        border-radius:12px;
        max-width:520px;
        margin-left:auto;
        margin-right:auto;
      ">
      <div style="font-weight:600; margin-bottom:6px; text-align:center;">
        Team Alignment — Coaches vs Stats
      </div>
      <table id="alignTable" style="width:100%; border-collapse:collapse; font-size:13px;">
        <thead>
          <tr>
            <th style="text-align:left;">Trait</th>
            <th style="text-align:right;">Coach</th>
            <th style="text-align:right;">Stats</th>
            <th style="text-align:right;">Δ</th>
          </tr>
        </thead>
        <tbody>${tr}</tbody>
      </table>
      ${
        nextLines
          ? `<ul style="margin:6px 0 0 14px; padding-left:0; font-size:12px; color:var(--muted);">${nextLines}</ul>`
          : `<div class="muted" style="margin-top:6px; font-size:12px;">No major gaps detected.</div>`
      }
      <div class="muted" style="margin-top:6px; font-size:11px; text-align:center;">
        Hover a trait to see its metric.
      </div>
    </div>
  `;

  initTooltips();
}






/* --- Schedule safety shim (place just before </body>) --- */
(function () {
  // Export once, don’t redeclare
  if (typeof window.renderSchedule !== 'function') {
    window.renderSchedule = function renderSchedule(games){
      const list = document.getElementById('scheduleList');
      if (!list) return;
      if (!Array.isArray(games) || !games.length) {
        list.innerHTML = '<div class="muted">No games found.</div>';
        return;
      }
      list.innerHTML = games.map(g => {
        const date = g.dateStr || '';
        const time = g.timeStr ? ` • ${g.timeStr}` : '';
        const ha   = g.homeAway === 'A' ? '@' : 'vs';
        const res  = g.status === 'final' ? (g.result || '') : 'Preview';
        const comp = g.competition ? `<div class="muted" style="font-size:12px;">${g.competition}</div>` : '';
        const arena= g.arena ? `<div class="muted" style="font-size:12px;">${g.arena}</div>` : '';
        const ppp  = (g.pppUs!=null || g.pppThem!=null)
          ? `<span class="tag" title="Points per Possession">${g.pppUs!=null?g.pppUs:'—'} - ${g.pppThem!=null?g.pppThem:'—'}</span>`
          : '';
        return `
          <div style="display:flex; gap:10px; align-items:flex-start; padding:8px 0; border-bottom:1px dashed var(--border);">
            <div style="min-width:180px;">
              <div style="font-weight:600;">${date}${time}</div>
              ${comp}${arena}
            </div>
            <div style="flex:1;">
              <div><b>${ha}</b> ${String(g.opponent||'')}</div>
              <div class="muted" style="font-size:12px;">${String(g.record||'')}</div>
            </div>
            <div style="min-width:140px; text-align:right;">
              <div>${res}</div>
              <div>${ppp}</div>
            </div>
          </div>
        `;
      }).join('');
      console.log('[schedule] renderSchedule drew', games.length, 'rows');
    };
  }

  if (typeof window.loadSchedule !== 'function') {
    window.loadSchedule = function loadSchedule(force=false){
      const box = document.getElementById('scheduleList');
      window._scheduleLoaded = window._scheduleLoaded || false;
      if (window._scheduleLoaded && !force) return;
      if (box) box.textContent = 'Loading…';

      google.script.run
        .withSuccessHandler(res => {
          if (!res || !res.ok) {
            if (box) box.textContent = (res && res.error) ? res.error : 'Failed to load schedule.';
            return;
          }
          window.renderSchedule(res.games || []);
          window._scheduleLoaded = true;
        })
        .withFailureHandler(err => {
          if (box) box.textContent = 'Failed to load schedule.';
          console.error('getSchedule error:', err);
        })
        .getSchedule();
    };
  }

  // Auto-load if Team tab already active
  if (document.querySelector('.tab.active[data-tab="team"]')) {
    window.loadSchedule();
  }
})();


let _oppScheduleLoaded = false;
function loadOpponentsSchedule(force = false){
  const box = document.getElementById('oppScheduleList');
  if (_oppScheduleLoaded && !force) return;
  if (box) box.textContent = 'Loading…';

  runGSR('getScheduleWithOppLinks', null, res => {
    if (!res || !res.ok) {
      if (box) box.textContent = (res && res.error) ? res.error : 'Failed to load.';
      return;
    }
    renderOpponentsSchedule(res.games || []);
    _oppScheduleLoaded = true;
  }, err => {
    if (box) box.textContent = 'Failed to load.';
    console.error('getScheduleWithOppLinks error:', err);
  }, { retries: 3, baseDelayMs: 700 });
}

function renderOpponentsSchedule(games){
  const list = document.getElementById('oppScheduleList');
  if (!list) return;
  if (!Array.isArray(games) || !games.length) {
    list.innerHTML = '<div class="muted">No games found.</div>';
    return;
  }

  const pill = (label, url) => {
    if (!url) return '';
    const safe = escapeHtml(String(url));
    return `<a href="#" class="tag" data-url="${safe}" onclick="return openReportLink(this)">${label}</a>`;
  };

  list.innerHTML = games.map(g => {
    const date = g.dateStr || '';
    const time = g.timeStr ? ` • ${g.timeStr}` : '';
    const ha   = g.homeAway === 'A' ? '@' : 'vs';
    let resClass = 'result-upcoming';
let resText  = 'Preview';

if (g.status === 'final') {
  const raw = String(g.result || '').trim();
  resText = raw || '';
  if (/^\s*W/i.test(raw)) resClass = 'result-win';
  else if (/^\s*L/i.test(raw)) resClass = 'result-loss';
  else resClass = 'result-upcoming';
}

const resHtml = `<span class="${resClass}">${escapeHtml(resText)}</span>`;
    const comp = g.competition ? `<div class="muted" style="font-size:12px;">${escapeHtml(g.competition)}</div>` : '';
    const arena= g.arena ? `<div class="muted" style="font-size:12px;">${escapeHtml(g.arena)}</div>` : '';

    const L = g.oppLinks || {};
    const linkLine = [
      pill('Offense video', L.offense),
      pill('Defense video', L.defense),
      pill('Quick report',  L.reportQuick),
      pill('Full report',   L.reportFull),
      pill('Individual',    L.reportIndiv),
      pill('After-game',    L.reportAfter)
    ].filter(Boolean).join(' ');

    const ppp  = (g.pppUs!=null || g.pppThem!=null)
      ? `<span class="tag" title="Points per Possession">${g.pppUs!=null?g.pppUs:'—'} - ${g.pppThem!=null?g.pppThem:'—'}</span>`
      : '';

    return `
      <div style="display:flex; gap:10px; align-items:flex-start; padding:12px 0; border-bottom:1px dashed var(--border);">
        <div style="min-width:200px;">
          <div style="font-weight:600;">${escapeHtml(date)}${time}</div>
          ${comp}${arena}
        </div>
        <div style="flex:1;">
          <div><b>${ha}</b> ${escapeHtml(String(g.opponent||''))}</div>
          <div class="muted" style="font-size:12px;">${escapeHtml(String(g.record||''))}</div>
          <div style="margin-top:6px; display:flex; flex-wrap:wrap; gap:6px;">
            ${linkLine || '<span class="muted">No assets linked yet.</span>'}
          </div>
        </div>
        <div style="min-width:140px; text-align:right;">
        <div>${resHtml}</div>
          <div>${ppp}</div>
        </div>
      </div>
    `;
  }).join('');
}

(function hookOpponentsTab(){
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.tab[data-tab="opponents"]');
    if (!btn) return;
    setTimeout(() => loadOpponentsSchedule(), 0);
  });
})();






// ------- helpers -------
function getSel(id){
  const el = document.getElementById(id);
  return el && el.value ? el.value : '';
}
function getVal(id){
  const el = document.getElementById(id);
  return el ? (el.value || '') : '';
}
function hydrateSelect(id, options){
  const el = document.getElementById(id);
  if (!el) return;

  // Remember current selection (text, case-insensitive)
  const current = (el.value || '').trim().toLowerCase();

  el.innerHTML =
    '<option value="">All</option>' +
    options.map(o => `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join('');

  // Try to keep previous selection, even if option casing differs
  if (current) {
    const match = Array.from(el.options).find(op =>
      String(op.value || '').trim().toLowerCase() === current
    );
    if (match) el.value = match.value;
  }
}






function ensureScoreOptions(){
  const s = document.getElementById('nScore');
  if (!s) return;
  // If it already has the right options, do nothing
  const want = ['','bad','ok','good'];
  const hasAll = Array.from(s.options).map(o=>o.value);
  const same = want.length === hasAll.length && want.every((v,i)=>v===hasAll[i]);
  if (same) return;

  const cur = s.value || '';
  s.innerHTML = ''
    + '<option value="">All scores</option>'
    + '<option value="bad">Bad (&lt; 3.0)</option>'
    + '<option value="ok">OK (3.0–3.99)</option>'
    + '<option value="good">Good (≥ 4.0)</option>';
  if (want.includes(cur)) s.value = cur;
}


// ---------- Notes (with Daily Overall join) ----------
const NOTES_PAGE = 200;   // how many per server page
const NOTES_BATCH = 60;   // DOM chunk size

let _notesOffset = 0;
let _notesTotal  = 0;
let _notesLoading = false;

function getSel(id){ const el = document.getElementById(id); return el && el.value ? el.value : ''; }
function getVal(id){ const el = document.getElementById(id); return el ? (el.value||'') : ''; }

function hydrateSelect(id, options){
  const el = document.getElementById(id);
  if (!el) return;
  const cur = el.value || '';
  el.innerHTML = '<option value="">All</option>' +
    options.map(o=>`<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join('');
  if (cur && Array.from(el.options).some(op => op.value === cur)) el.value = cur;
}

function scoreRangeFromUI(){
  // nScore select values: '', 'bad', 'ok', 'good'
  const v = getSel('nScore');
  // 1–5 scale:
  // bad  => <3.0
  // ok   => 3.0–3.99
  // good => >=4.0
  if (v === 'bad')  return { minScore: null, maxScore: 2.99 };
  if (v === 'ok')   return { minScore: 3.0,  maxScore: 3.99 };
  if (v === 'good') return { minScore: 4.0,  maxScore: null };
  return { minScore: null, maxScore: null };
}

function loadNotes(reset=false){
  if (_notesLoading) return;
  const list = document.getElementById('notesList');
  const msg  = document.getElementById('nMsg');

  if (reset) {
    _notesOffset = 0;
    _notesTotal  = 0;
    if (list) list.innerHTML = '';
  }

  const rng = scoreRangeFromUI();
  const f = {
    player:  getSel('nPlayer'),
    coach:   getSel('nCoach'),
    session: getSel('nSession'),
    q:       getVal('nQ'),
    minScore: rng.minScore,
    maxScore: rng.maxScore,
    limit:   NOTES_PAGE,
    offset:  _notesOffset
  };

  if (msg)  msg.textContent  = 'Loading…';
  _notesLoading = true;

  runGSR('getNotesLibrary', f, res => {
    _notesLoading = false;
    if (!res || !res.ok) {
      if (msg) msg.textContent = (res && res.error) ? res.error : 'Failed to load.';
      return;
    }

    if (_notesOffset === 0) {
      hydrateSelect('nPlayer',  res.facets?.players  || []);
      hydrateSelect('nCoach',   res.facets?.coaches  || []);
      hydrateSelect('nSession', res.facets?.sessions || []);
    }

    const rows = res.rows || [];
    _notesTotal = Number(res.total || rows.length);

    if (_notesOffset === 0 && list && !rows.length) {
      list.innerHTML = '<div class="muted">No notes match the filters.</div>';
    } else {
      appendNotesChunked(rows);
    }
    updateNotesFooter();

  }, _ => {
    _notesLoading = false;
    if (msg) msg.textContent = 'Failed to load.';
  }, { retries: 2, baseDelayMs: 350 });
}

function appendNotesChunked(rows){
  const list = document.getElementById('notesList');
  if (!list || !rows.length) return;

  let i = 0;
  function step(){
    const frag = document.createDocumentFragment();
    for (let k = 0; k < NOTES_BATCH && i < rows.length; k++, i++){
      const n = rows[i];

      const wrap = document.createElement('div');
      wrap.style.cssText = 'padding:8px 0; border-bottom:1px dashed var(--border); display:grid; grid-template-columns: 150px 150px 200px 1fr; gap:8px;';

      const c1 = document.createElement('div');
      c1.className = 'muted';
      c1.textContent = n.dateStr || '';

      const c2 = document.createElement('div');
      c2.textContent = n.session || '';

      const c3 = document.createElement('div');
      const coachSpan = document.createElement('span');
      coachSpan.textContent = n.coach || '';
      c3.appendChild(coachSpan);

      // avgScore is 1–5
      if (n.avgScore != null && isFinite(n.avgScore)) {
        const s = Number(n.avgScore);
        const chip = document.createElement('span');
        chip.textContent = ` ★ ${s.toFixed(2)}`;
        chip.style.marginLeft = '6px';
        chip.style.padding = '2px 6px';
        chip.style.borderRadius = '10px';
        chip.style.fontSize = '12px';
        // color by 1–5 scale
        chip.style.background = (s >= 4.0) ? 'rgba(46,204,113,.18)'   // good
                              : (s < 3.0)  ? 'rgba(255,90,95,.18)'    // bad
                                            : 'rgba(255,176,32,.18)'; // ok
        c3.appendChild(chip);
      }

      const c4 = document.createElement('div');
      c4.innerHTML = `<b>${escapeHtml(n.player||'')}</b> — ${escapeHtml(n.note||'')}`;

      wrap.appendChild(c1); wrap.appendChild(c2); wrap.appendChild(c3); wrap.appendChild(c4);
      frag.appendChild(wrap);
    }
    list.appendChild(frag);
    if (i < rows.length) {
      requestAnimationFrame(step);
    } else {
      _notesOffset += rows.length;
    }
  }
  requestAnimationFrame(step);
}

function updateNotesFooter(){
  const msg = document.getElementById('nMsg');
  if (!msg) return;
  const shown = _notesOffset;
  const total = _notesTotal;
  msg.innerHTML = `${shown}/${total} notes`;
  const left = total - shown;
  if (left > 0) {
    const btn = document.createElement('button');
    btn.textContent = `Load more (${left})`;
    btn.className = 'apply';
    btn.style.marginLeft = '8px';
    btn.onclick = () => loadNotes(false);
    msg.appendChild(document.createTextNode(' '));
    msg.appendChild(btn);
  }
}

// Tab + controls
(function hookNotesTab(){
  document.addEventListener('click', (e) => {
    const tab = e.target.closest('.tab[data-tab="notes"]');
    if (!tab) return;
    setTimeout(() => loadNotes(true), 0);
  });

  let _apTimer = null;
  document.addEventListener('click', (e)=>{
    if (e.target && e.target.id === 'nApply') {
      clearTimeout(_apTimer);
      _apTimer = setTimeout(()=>loadNotes(true), 120);
    }
    if (e.target && e.target.id === 'nClear') {
      ['nPlayer','nCoach','nSession','nQ','nScore'].forEach(id=>{
        const el = document.getElementById(id); if (el) el.value = '';
      });
      loadNotes(true);
    }
  });
})();














/* ===== Ratings UI (Home → modal) ===== */
const TRAIT_DESCRIPTIONS = {
  exec: 'Execution: Did the player consistently execute with precision and maintain focus throughout the session?',
  energy: 'Energy & Effort: Did the player sustain high physical intensity and effort from start to finish?',
  comm: 'Communication: Did the player communicate effectively with teammates and coaches, both verbally and non-verbally?',
  adapt: 'Adaptability & Decision Making: Did the player adjust well to changing situations and make good decisions under pressure?',
  resilience: 'Resilience & Mindset: Did the player respond positively to mistakes, challenges, and feedback?',
  impact: 'Team Impact: Did the player\'s presence on the floor positively influence the team\'s overall performance?'
};

let _traitTooltipEl = null;

function _getTraitTooltipEl(){
  if (_traitTooltipEl) return _traitTooltipEl;
  const el = document.createElement('div');
  el.className = 'trait-tooltip';
  document.body.appendChild(el);
  _traitTooltipEl = el;
  return el;
}

function showTraitTooltip(text, anchor){
  const el = _getTraitTooltipEl();
  if (!text || !anchor) return;
  el.textContent = text;
  const rect = anchor.getBoundingClientRect();
  el.style.left = `${rect.left + rect.width / 2}px`;
  el.style.top = `${rect.top}px`;
  el.classList.add('is-visible');
}

function hideTraitTooltip(){
  if (_traitTooltipEl) _traitTooltipEl.classList.remove('is-visible');
}

function bindTraitTooltip(el, desc){
  if (!el || !desc || el.dataset.tipBound) return;
  const show = () => showTraitTooltip(desc, el);
  el.addEventListener('mouseenter', show);
  el.addEventListener('mouseleave', hideTraitTooltip);
  el.addEventListener('focus', show);
  el.addEventListener('blur', hideTraitTooltip);
  el.dataset.tipBound = '1';
}

window.addEventListener('scroll', hideTraitTooltip, true);
window.addEventListener('resize', hideTraitTooltip);

function applyTraitTooltips(){
  Object.entries(TRAIT_DESCRIPTIONS).forEach(([key, desc]) => {
    const header = document.querySelector(`#rtTable thead th[data-trait="${key}"]`);
    if (header && desc) {
      header.removeAttribute('title');
      header.setAttribute('data-tip', desc);
      bindTraitTooltip(header, desc);
    }
  });
}

(function ratingsUI(){
  // Open button
  document.addEventListener('click', (e)=>{
    if (e.target && e.target.id === 'openRatingsBtn') openRatingsModal();
  });
})();

function openRatingsModal(){
  const modal = document.getElementById('ratingsModal');
  const msg   = document.getElementById('rtMsg');
  const coach = document.getElementById('rtCoach');
  const sess  = document.getElementById('rtSession');
  const date  = document.getElementById('rtDate');
  const tbody = document.querySelector('#rtTable tbody');
  applyTraitTooltips();

  if (msg) msg.textContent = '';
  if (tbody) tbody.innerHTML = '<tr class="rt-empty"><td colspan="8" class="muted">Loading…</td></tr>';

  // Pull lists (coaches, sessions, players) + todayISO
  google.script.run
    .withSuccessHandler(res => {
      if (!res || !res.ok) {
        if (tbody) tbody.innerHTML = '<tr class="rt-empty"><td colspan="8" class="muted">Failed to load lists.</td></tr>';
        return;
      }
      // fill coach + session + date
      hydrateSelectEl(coach, res.coaches || []);
      hydrateSelectEl(sess,  res.sessions || []);
      if (date) date.value = res.todayISO || '';

      // build players rows
      const players = res.players || [];
      if (!players.length) {
        if (tbody) tbody.innerHTML = '<tr class="rt-empty"><td colspan="8" class="muted">No players found in Lists.</td></tr>';
        return;
      }
      if (tbody) {
        tbody.textContent = '';
        const frag = document.createDocumentFragment();
        players.forEach(p => frag.appendChild(rowHTML(p)));
        tbody.appendChild(frag);
      }

      modal.style.display = 'flex';
    })
    .withFailureHandler(_ => {
      if (tbody) tbody.innerHTML = '<tr class="rt-empty"><td colspan="8" class="muted">Failed to load lists.</td></tr>';
    })
    .getRatingsMeta();
}

function closeRatingsModal(){
  const modal = document.getElementById('ratingsModal');
  if (modal) modal.style.display = 'none';
  hideTraitTooltip();
}

function hydrateSelectEl(sel, arr){
  if (!sel) return;
  sel.innerHTML = '<option value="">—</option>' + (arr||[]).map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
}

function rowHTML(player){
  const tr = document.createElement('tr');
  tr.dataset.player = player;

  const th = document.createElement('th');
  th.scope = 'row';
  th.className = 'rt-player';
  const span = document.createElement('span');
  span.className = 'rt-player-name';
  span.textContent = player;
  th.appendChild(span);
  tr.appendChild(th);

  const buildSelectCell = (cls, traitKey) => {
    const td = document.createElement('td');
    td.className = 'rt-score';
    const select = document.createElement('select');
    select.className = `rt ${cls}`;
    if (traitKey) select.dataset.trait = traitKey;
    ['', '5', '4', '3', '2', '1'].forEach(val => {
      const opt = document.createElement('option');
      opt.value = val;
      opt.textContent = val;
      select.appendChild(opt);
    });
    td.appendChild(select);
    tr.appendChild(td);
  };

  buildSelectCell('rt-exec', 'exec');
  buildSelectCell('rt-energy', 'energy');
  buildSelectCell('rt-comm', 'comm');
  buildSelectCell('rt-adapt', 'adapt');
  buildSelectCell('rt-res', 'resilience');
  buildSelectCell('rt-impact', 'impact');

  const noteTd = document.createElement('td');
  noteTd.className = 'rt-note-cell';
  const textarea = document.createElement('textarea');
  textarea.className = 'rt-note';
  textarea.placeholder = 'Add quick context…';
  noteTd.appendChild(textarea);
  tr.appendChild(noteTd);

  return tr;
}

// Quick-fill: set all selects to same value
function applyAll(){
  const v = (document.getElementById('rtAllVal')?.value || '').trim();
  if (!v) return;
  document.querySelectorAll('#rtTable select.rt').forEach(sel => sel.value = v);
}

// Collect and save
function saveRatings(){
  const coach = (document.getElementById('rtCoach')?.value || '').trim();
  const sess  = (document.getElementById('rtSession')?.value || '').trim();
  const date  = (document.getElementById('rtDate')?.value || '').trim();
  const msg   = document.getElementById('rtMsg');
  const btn   = document.getElementById('rtSaveBtn');

  if (msg) msg.textContent = '';
  if (!coach) { if (msg) msg.textContent = 'Pick a coach.'; return; }
  if (!sess)  { if (msg) msg.textContent = 'Pick a session.'; return; }
  if (!date)  { if (msg) msg.textContent = 'Pick a date.'; return; }

  const rows = [];
  document.querySelectorAll('#rtTable tbody tr').forEach(tr => {
    const player = tr.getAttribute('data-player') || '';
    if (!player) return;
    const val = sel => {
      const v = tr.querySelector(sel)?.value || '';
      const n = Number(v);
      return isFinite(n) ? n : '';
    };
    const note = (tr.querySelector('.rt-note')?.value || '').trim();
    const row = {
      player,
      exec:      val('.rt-exec'),
      energy:    val('.rt-energy'),
      comm:      val('.rt-comm'),
      adapt:     val('.rt-adapt'),
      resilience:val('.rt-res'),
      impact:    val('.rt-impact'),
      notes: note
    };
    const hasTraitScore = row.exec !== '' || row.energy !== '' || row.comm !== '' ||
      row.adapt !== '' || row.resilience !== '' || row.impact !== '';
    if (hasTraitScore || note.length) rows.push(row);
  });

  if (!rows.length) { if (msg) msg.textContent = 'Nothing to save yet.'; return; }

  const payload = { dateISO: date, session: sess, coach, rows };
  if (btn) btn.disabled = true;

  google.script.run
    .withSuccessHandler(res => {
      if (btn) btn.disabled = false;
      if (!res || !res.ok) {
        if (msg) msg.textContent = (res && res.error) ? res.error : 'Save failed.';
        return;
      }
      if (msg) msg.textContent = `Saved ${res.saved} row(s) ✅`;
      // Optional: close modal after brief pause
      setTimeout(closeRatingsModal, 700);
    })
    .withFailureHandler(err => {
      if (btn) btn.disabled = false;
      if (msg) msg.textContent = 'Save failed.';
      console.error('saveRatings error:', err);
    })
    .saveRatings(payload);
}


let _gsFiltersLoaded = false;
let _gsLastQuery = null;

function gameStatsPopulateFilters(force) {
  if (_gsFiltersLoaded && !force) return;
  const msg = document.getElementById('gsMessage');
  if (msg) msg.textContent = 'Loading games…';
  const gameSel = document.getElementById('gsGame');
  if (gameSel) gameSel.innerHTML = '<option value="">Select game</option>';

  google.script.run
    .withSuccessHandler(function(res){
      if (!res || !res.ok) {
        if (msg) msg.textContent = (res && res.error) || 'Failed to load games.';
        return;
      }
      const games = Array.isArray(res.games) ? res.games : [];
      if (gameSel) {
        games.forEach(function(game){
          const opt = document.createElement('option');
          opt.value = game.gameId;
          opt.textContent = game.label || game.gameId;
          gameSel.appendChild(opt);
        });
        if (!gameSel.value && gameSel.options.length > 1) {
          gameSel.selectedIndex = 1;
          setTimeout(loadGameStatsData, 60);
        }
      }
      _gsFiltersLoaded = true;
      if (msg) {
        msg.textContent = games.length
          ? 'Adjust filters and click Load.'
          : 'Add game IDs in the sheet to get started.';
      }
    })
    .withFailureHandler(function(err){
      console.error('Game stats filters error:', err);
      if (msg) msg.textContent = 'Failed to load games.';
    })
    .getGameStatsFilters();
}

function loadGameStatsData() {
  const btn = document.getElementById('gsLoadBtn');
  const msg = document.getElementById('gsMessage');
  const gameId = document.getElementById('gsGame')?.value || '';
  if (!gameId) {
    if (msg) msg.textContent = 'Select a game first.';
    return;
  }
  const query = {
    gameId: gameId,
    teamId: document.getElementById('gsTeam')?.value || '',
    playerId: document.getElementById('gsPlayer')?.value || '',
    period: document.getElementById('gsPeriod')?.value || '',
  };
  if (btn) btn.disabled = true;
  if (msg) msg.textContent = 'Loading stats…';

  google.script.run
    .withSuccessHandler(function(res){
      if (btn) btn.disabled = false;
      renderGameStats(res, query);
    })
    .withFailureHandler(function(err){
      console.error('Game stats load error:', err);
      if (btn) btn.disabled = false;
      if (msg) msg.textContent = 'Failed to load stats.';
    })
    .getGameStats(query);
}

function renderGameStats(res, query) {
  const msg = document.getElementById('gsMessage');
  if (!res || !res.ok) {
    if (msg) msg.textContent = (res && res.error) || 'Unable to load stats.';
    return;
  }
  _gsLastQuery = query;
  updateGameStatsFilters(res.filters || {}, query);
  updateGameStatsMeta(res.game || {}, res.teams || []);
  updateGameStatsSnapshot(res.teams || []);
  updateGameStatsInsights(res.insights || []);
  renderGameStatsCharts(res);
  if (msg) msg.textContent = 'Charts updated.';
}

function updateGameStatsFilters(filters, query) {
  const teamSel = document.getElementById('gsTeam');
  const playerSel = document.getElementById('gsPlayer');
  const periodSel = document.getElementById('gsPeriod');

  if (teamSel) {
    const current = query.teamId || '';
    teamSel.innerHTML = '<option value="">All teams</option>';
    (filters.teams || []).forEach(function(team){
      const opt = document.createElement('option');
      opt.value = team.id;
      opt.textContent = team.label || team.name || team.id;
      teamSel.appendChild(opt);
    });
    teamSel.value = current;
  }

  if (playerSel) {
    const current = query.playerId || '';
    playerSel.innerHTML = '<option value="">All players</option>';
    (filters.players || []).forEach(function(player){
      const opt = document.createElement('option');
      opt.value = player.id;
      opt.textContent = player.label || player.name || player.id;
      playerSel.appendChild(opt);
    });
    playerSel.value = current;
  }

  if (periodSel) {
    const current = query.period || '';
    periodSel.innerHTML = '<option value="">All periods</option>';
    (filters.periods || []).forEach(function(period){
      const value = typeof period === 'object' && period !== null && period.id != null
        ? period.id
        : period;
      const label = typeof period === 'object' && period !== null && period.label
        ? period.label
        : 'Period ' + value;
      const opt = document.createElement('option');
      opt.value = String(value);
      opt.textContent = label;
      periodSel.appendChild(opt);
    });
    periodSel.value = current;
  }
}

function updateGameStatsMeta(game, teams) {
  const meta = document.getElementById('gsGameMeta');
  if (!meta) return;
  if (!game || !game.id) {
    meta.innerHTML = '<strong>No game loaded</strong><span>Select a game to view details.</span>';
    return;
  }
  const details = [];
  if (game.date) details.push(game.date);
  if (game.venue) details.push(game.venue);
  if (game.status) details.push(String(game.status).toUpperCase());
  if (game.competition) details.push(game.competition);
  const header = '<strong>' + escapeHtml(game.title || game.id) + '</strong>';
  const detailLine = details.length ? '<span>' + escapeHtml(details.join(' • ')) + '</span>' : '';
  const scoreLine = teams && teams.length >= 2
    ? '<span>' + escapeHtml((teams[0].name || teams[0].abbreviation || '') + ' ' + formatGameStatNumber(teams[0].totals?.pts, 0) +
      ' • ' + (teams[1].name || teams[1].abbreviation || '') + ' ' + formatGameStatNumber(teams[1].totals?.pts, 0)) + '</span>'
    : '';
  meta.innerHTML = header + detailLine + scoreLine;
}

function updateGameStatsSnapshot(teams) {
  const list = document.getElementById('gsAdvancedMetrics');
  if (!list) return;
  if (!teams.length) {
    list.innerHTML = '<li class="muted">No team metrics yet.</li>';
    return;
  }
  list.innerHTML = teams.map(function(team){
    const metrics = team.metrics || {};
    const name = team.name || team.abbreviation || team.id || '';
    const pace = formatGameStatNumber(metrics.pace, 1);
    const ortg = formatGameStatNumber(metrics.offensiveRating, 1);
    const drtg = formatGameStatNumber(metrics.defensiveRating, 1);
    const net = formatGameStatNumber(metrics.netRating, 1);
    return '<li><span>' + escapeHtml(name) + '</span>' +
      'ORtg ' + ortg + ' • DRtg ' + drtg + ' • Pace ' + pace + ' • Net ' + net + '</li>';
  }).join('');
}

function updateGameStatsInsights(insights) {
  const list = document.getElementById('gsInsights');
  if (!list) return;
  if (!insights || !insights.length) {
    list.innerHTML = '<li class="muted">No automated notes yet.</li>';
    return;
  }
  list.innerHTML = insights.map(function(text){
    return '<li>' + escapeHtml(text) + '</li>';
  }).join('');
}

let _gsFourChart = null;
let _gsShotChart = null;
let _gsFlowChart = null;
let _gsUsageChart = null;

function renderGameStatsCharts(res) {
  if (typeof Chart === 'undefined') return;
  const teams = res.teams || [];
  const allPlayers = res.allPlayers || res.players || [];
  const colors = ['#4aa8ff', '#ff9f43', '#10ac84', '#845ef7'];

  const fourCtx = document.getElementById('gsFourChart');
  if (fourCtx) {
    if (_gsFourChart) _gsFourChart.destroy();
    if (teams.length) {
      const labels = ['eFG%', 'Ball Security', 'ORB%', 'FTR'];
      const datasets = teams.map(function(team, idx){
        const ff = team.metrics && team.metrics.fourFactors || {};
        const ballSecurity = ff.tov != null ? 1 - ff.tov : null;
        return {
          label: team.name || team.abbreviation || team.id,
          data: [
            ff.efg != null ? ff.efg * 100 : null,
            ballSecurity != null ? ballSecurity * 100 : null,
            ff.orb != null ? ff.orb * 100 : null,
            ff.ftr != null ? ff.ftr * 100 : null,
          ],
          borderColor: colors[idx % colors.length],
          backgroundColor: hexToRgba_(colors[idx % colors.length], 0.18),
          borderWidth: 2,
        };
      });
      _gsFourChart = new Chart(fourCtx.getContext('2d'), {
        type: 'radar',
        data: { labels: labels, datasets: datasets },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 1,
          scales: {
            r: {
              beginAtZero: true,
              suggestedMin: 0,
              suggestedMax: 70,
              ticks: { display: true, stepSize: 10, backdropColor: 'transparent', color: 'rgba(245,247,255,0.85)' },
              grid: { color: 'rgba(255,255,255,0.3)' },
              angleLines: { color: 'rgba(255,255,255,0.45)' },
              pointLabels: { color: '#f5f7ff' }
            }
          },
          layout: { padding: 8 },
          plugins: { legend: { position: 'bottom' } },
        },
      });
      _gsFourChart.canvas.style.height = 'auto';
    }
  }

  const shotCtx = document.getElementById('gsShotChart');
  if (shotCtx) {
    if (_gsShotChart) _gsShotChart.destroy();
    if (teams.length) {
      const labels = ['Paint', 'Mid', 'Three', 'Free Throws'];
      const baseColors = ['#4aa8ff', '#ff9f43', '#845ef7', '#10ac84'];
      const datasets = teams.map(function(team, idx){
        const profile = team.metrics && team.metrics.shotProfile || {};
        const alpha = idx === 0 ? 0.75 : 0.45;
        const bg = baseColors.map(function(col){ return hexToRgba_(col, alpha); });
        const border = baseColors.map(function(col){ return hexToRgba_(col, 0.9); });
        return {
          label: team.name || team.abbreviation || team.id,
          data: [
            profile.paint != null ? profile.paint * 100 : 0,
            profile.mid != null ? profile.mid * 100 : 0,
            profile.three != null ? profile.three * 100 : 0,
            profile.ft != null ? profile.ft * 100 : 0,
          ],
          backgroundColor: bg,
          borderColor: border,
          borderWidth: 1,
        };
      });
      _gsShotChart = new Chart(shotCtx.getContext('2d'), {
        type: 'doughnut',
        data: { labels: labels, datasets: datasets },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 1,
          cutout: '58%',
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function(context){
                  const value = context.parsed || 0;
                  const label = context.label || '';
                  return context.dataset.label + ' – ' + label + ': ' + value.toFixed(1) + '%';
                },
              },
            },
          },
        },
      });
      _gsShotChart.canvas.style.height = 'auto';
    }
  }

  const flowCtx = document.getElementById('gsFlowChart');
  if (flowCtx) {
    if (_gsFlowChart) _gsFlowChart.destroy();
    if (res.timeline && Array.isArray(res.timeline.labels) && res.timeline.labels.length) {
      const datasets = (res.timeline.series || []).map(function(series, idx){
        return {
          label: series.name || ('Team ' + (idx + 1)),
          data: series.scores || [],
          borderColor: colors[idx % colors.length],
          backgroundColor: hexToRgba_(colors[idx % colors.length], 0.25),
          borderWidth: 2,
          tension: 0.25,
          fill: false,
        };
      });
      _gsFlowChart = new Chart(flowCtx.getContext('2d'), {
        type: 'line',
        data: { labels: res.timeline.labels, datasets: datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { top: 16, right: 24, bottom: 16, left: 16 } },
          plugins: { legend: { position: 'top' } },
          interaction: { intersect: false, mode: 'index' },
          scales: {
            x: {
              ticks: { autoSkip: true, maxRotation: 0, padding: 12 },
              grid: { drawBorder: false, color: 'rgba(255,255,255,0.08)' }
            },
            y: {
              beginAtZero: true,
              ticks: { precision: 0, padding: 10 },
              grid: { drawBorder: false, color: 'rgba(255,255,255,0.08)' },
              grace: '10%'
            },
          },
        },
      });
    }
  }

  const usageCtx = document.getElementById('gsUsageChart');
  if (usageCtx) {
    if (_gsUsageChart) _gsUsageChart.destroy();
    const byTeam = {};
    allPlayers.forEach(function(player){
      const adv = player.advanced || {};
      if (adv.usage == null || adv.trueShooting == null) return;
      const teamKey = player.teamId || player.teamAbbreviation || 'team';
      byTeam[teamKey] = byTeam[teamKey] || {
        label: player.teamAbbreviation || player.teamName || player.teamId,
        data: [],
        borderColor: colors[Object.keys(byTeam).length % colors.length],
        backgroundColor: hexToRgba_(colors[Object.keys(byTeam).length % colors.length], 0.7),
      };
      byTeam[teamKey].data.push({
        x: adv.usage,
        y: adv.trueShooting * 100,
        r: Math.max(4, Math.min(adv.minutes || 0, 30) / 2),
        player: player.name,
        team: player.teamAbbreviation || player.teamName || '',
        minutes: adv.minutes,
        points: player.statistics ? player.statistics.pts : null,
      });
    });
    const datasets = Object.keys(byTeam).map(function(key){ return byTeam[key]; });
    if (datasets.length) {
      _gsUsageChart = new Chart(usageCtx.getContext('2d'), {
        type: 'scatter',
        data: { datasets: datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { top: 16, right: 24, bottom: 16, left: 16 } },
          plugins: {
            legend: { display: datasets.length > 1 },
            tooltip: {
              callbacks: {
                label: function(context){
                  const raw = context.raw || {};
                  return [
                    (raw.player || 'Player') + ' — ' + (raw.team || ''),
                    'Usage: ' + formatGameStatNumber(raw.x, 1) + '%',
                    'TS: ' + formatGameStatNumber(raw.y, 1) + '%',
                    'Minutes: ' + formatGameStatNumber(raw.minutes, 1),
                    'Points: ' + formatGameStatNumber(raw.points, 1),
                  ];
                },
              },
            },
          },
          scales: {
            x: {
              title: { display: true, text: 'Usage %' },
              ticks: {
                callback: function(value){ return value + '%'; },
                padding: 12
              },
              grid: { drawBorder: false, color: 'rgba(255,255,255,0.08)' },
              grace: '5%'
            },
            y: {
              title: { display: true, text: 'True Shooting %' },
              suggestedMin: 30,
              suggestedMax: 80,
              ticks: {
                callback: function(value){ return value + '%'; },
                padding: 10
              },
              grid: { drawBorder: false, color: 'rgba(255,255,255,0.08)' },
              grace: '8%'
            },
          },
          datasets: {
            scatter: {
              pointRadius: function(ctx){ return (ctx.raw && ctx.raw.r) || 4; },
            },
          },
        },
      });
    }
  }
}

function formatGameStatNumber(value, digits) {
  if (value == null || isNaN(value)) return '—';
  const num = Number(value);
  return digits != null ? num.toFixed(digits) : String(Math.round(num));
}

function hexToRgba_(hex, alpha) {
  const parsed = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  if (!parsed) return hex;
  const r = parseInt(parsed[1], 16);
  const g = parseInt(parsed[2], 16);
  const b = parseInt(parsed[3], 16);
  return 'rgba(' + r + ',' + g + ',' + b + ',' + (alpha != null ? alpha : 1) + ')';
}

document.addEventListener('click', function(e){
  if (e.target && e.target.id === 'gsLoadBtn') {
    loadGameStatsData();
  }
});

document.addEventListener('change', function(e){
  if (!e.target) return;
  if (e.target.id === 'gsGame' || e.target.id === 'gsTeam' || e.target.id === 'gsPlayer' || e.target.id === 'gsPeriod') {
    const msg = document.getElementById('gsMessage');
    if (msg) msg.textContent = 'Adjust filters and click Load.';
  }
});

(function sidebarTabsFinal(){
  // Map each tab -> loader (called when that tab is activated)
var tabLoaders = {
    home: function(){ loadHomeSummary(true); },

    dailyratings: function(){
      if (typeof ensureNotesIndex === 'function') {
        ensureNotesIndex(function(){
          setTimeout(function(){
            if (typeof window.buildDailyRatings === 'function') {
              window.buildDailyRatings();
            } else if (typeof window.loadDailyRatings === 'function') {
              window.loadDailyRatings();
            } else if (typeof window.loadRatings === 'function') {
              window.loadRatings(true);
            } else {
              console.warn('No daily ratings loader found');
            }
          }, 120);
        });
      } else {
        // Fall back immediately if ensureNotesIndex not present
        if (typeof window.buildDailyRatings === 'function') {
          window.buildDailyRatings();
        } else if (typeof window.loadDailyRatings === 'function') {
          window.loadDailyRatings();
        } else if (typeof window.loadRatings === 'function') {
          window.loadRatings(true);
        } else {
          console.warn('No daily ratings loader found');
        }
      }
    },

    traitratings: function(){
      if (typeof window.loadTraitRatings === 'function') window.loadTraitRatings();
    },

    notes: function(){
      if (typeof ensureNotesIndex === 'function') {
        ensureNotesIndex(function(){
          setTimeout(function(){
            if (typeof window.loadNotes === 'function') window.loadNotes(true);
          }, 60);
        });
      } else {
        if (typeof window.loadNotes === 'function') window.loadNotes(true);
      }
    },

    opponents: function(){
      if (typeof window.loadOpponentsSchedule === 'function') window.loadOpponentsSchedule(true);
    },
    team: function(){
      if (typeof window.loadTeam === 'function') window.loadTeam();
    },
    players: function(){
      if (typeof window.initPlayers === 'function') {
        window.initPlayers();
      } else if (typeof window.loadPlayers === 'function') {
        window.loadPlayers();
      }
    },
    stats: function(){
      if (typeof window.loadStats === 'function') window.loadStats();
    },
    clips: function(){
      if (typeof window.loadClips === 'function') window.loadClips();
    },
    summaries: function(){
      if (typeof window.loadSummaries === 'function') window.loadSummaries();
    },
    strength: function(){
      if (typeof window.loadPracticeLoadList === 'function') window.loadPracticeLoadList();
    },
    chat: function(){
      if (typeof window.refreshChat === 'function') window.refreshChat();
    },
    gamestats: function(){
      gameStatsPopulateFilters();
    }
  };

  function toggleMobileNav(force){
    var open = (typeof force === 'boolean') ? force : !document.body.classList.contains('mobile-nav-open');
    if (open) document.body.classList.add('mobile-nav-open');
    else document.body.classList.remove('mobile-nav-open');
  }

  function showPanel(tabName){
    // Hide all, show one
    var panels = document.querySelectorAll('.panel');
    for (var i=0; i<panels.length; i++) panels[i].classList.remove('active');
    var panel = document.getElementById('panel-' + tabName);
    if (panel) panel.classList.add('active');

    // Highlight left nav
    var items = document.querySelectorAll('#sideNav .sideItem');
    for (var j=0; j<items.length; j++) {
      items[j].classList.toggle('active', items[j].getAttribute('data-tab') === tabName);
    }

    var mobileBtns = document.querySelectorAll('#mobileTabbar button');
    for (var k=0; k<mobileBtns.length; k++) {
      var btn = mobileBtns[k];
      btn.classList.toggle('active', btn.getAttribute('data-tab') === tabName);
    }

    // Try to sync legacy top tabs (if they still exist)
    var legacy = document.querySelector('.tab[data-tab="' + tabName + '"]');
    if (legacy && typeof legacy.click === 'function') legacy.click();

    // Run loader
    var fn = tabLoaders[tabName];
    try { if (typeof fn === 'function') fn(); } catch (e) { console.error('Tab loader error:', e); }

    // Remember (still store last tab for internal nav, but first load will force Home)
    try { localStorage.setItem('lastTab', tabName); } catch(e){}

    toggleMobileNav(false);

    if (window.matchMedia && window.matchMedia('(max-width: 960px)').matches) {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }

  // Sidebar item click
  document.addEventListener('click', function(e){
    var item = e.target && e.target.closest ? e.target.closest('#sideNav .sideItem') : null;
    if (!item) return;
    var tab = item.getAttribute('data-tab');
    if (tab) showPanel(tab);
  });

  // Mobile tabbar buttons
  document.addEventListener('click', function(e){
    var navBtn = e.target && e.target.closest ? e.target.closest('#mobileTabbar button[data-mobile-nav]') : null;
    if (navBtn) { toggleMobileNav(); return; }
    if (e.target && e.target.id === 'mobileNavOverlay') { toggleMobileNav(false); return; }
    var btn = e.target && e.target.closest ? e.target.closest('#mobileTabbar button[data-tab]') : null;
    if (!btn) return;
    var tab = btn.getAttribute('data-tab');
    if (tab) showPanel(tab);
  });

  // Collapse toggle
  var collapseBtn = document.getElementById('collapseNav');
  if (collapseBtn) collapseBtn.addEventListener('click', function(){
    var nav = document.getElementById('sideNav');
    if (!nav) return;

    var collapsed = !nav.classList.contains('collapsed');
    if (collapsed) {
      nav.classList.add('collapsed');
      document.body.classList.add('sidebar-collapsed');
      collapseBtn.textContent = '>';
    } else {
      nav.classList.remove('collapsed');
      document.body.classList.remove('sidebar-collapsed');
      collapseBtn.textContent = '<';
    }

    try { localStorage.setItem('navCollapsed', collapsed ? '1' : '0'); } catch(e){}
  });

  // Restore collapsed state and force Home on first load
  window.addEventListener('load', function(){
    // Ensure base class so content offsets are applied
    document.body.classList.add('sidebar-enabled');

    try {
      var collapsed = localStorage.getItem('navCollapsed') === '1';
      var nav = document.getElementById('sideNav');
      if (nav) {
        if (collapsed) {
          nav.classList.add('collapsed');
          document.body.classList.add('sidebar-collapsed');
          if (collapseBtn) collapseBtn.textContent = '>';
        } else {
          nav.classList.remove('collapsed');
          document.body.classList.remove('sidebar-collapsed');
          if (collapseBtn) collapseBtn.textContent = '<';
        }
      }
    } catch(e){}

    // Always start on Home
    showPanel('home');
  });

  window.addEventListener('resize', function(){
    if (!window.matchMedia('(max-width: 960px)').matches) {
      toggleMobileNav(false);
    }
  });

  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape' && document.body.classList.contains('mobile-nav-open')) {
      toggleMobileNav(false);
    }
  });
})();






/* ======= HOME SUMMARY ======= */
function loadHomeSummary(force = false) {
  if (_homeSummaryLoaded && !force) return;

  const setLoading = (id) => {
    const el = document.getElementById(id);
    if (el) {
      el.classList.add('muted');
      el.innerHTML = "<div class='muted'>Loading…</div>";
    }
  };

  setLoading('homeSessionBody');
  setLoading('homeUpcomingList');

  const stamp = document.getElementById('homeSummaryTimestamp');
  if (stamp) stamp.textContent = '';

  const flagsMsg = document.getElementById('flagsMsg');
  if (flagsMsg) flagsMsg.textContent = 'Loading…';
  const flagsHead = document.querySelector('#flagsTable thead');
  const flagsBody = document.querySelector('#flagsTable tbody');
  if (flagsHead) flagsHead.innerHTML = '';
  if (flagsBody) flagsBody.innerHTML = '';
  const teamSvg = document.getElementById('teamLine');
  if (teamSvg) teamSvg.innerHTML = '';
  const teamNote = document.getElementById('teamLineNote');
  if (teamNote) teamNote.textContent = 'Loading…';

  google.script.run
    .withSuccessHandler(res => {
      if (!res || !res.ok) {
        showHomeSummaryError((res && res.error) || 'Failed to load dashboard.');
        loadFlags();
        loadTeamRatings(true);
        return;
      }
      _homeSummaryLoaded = true;
      renderHomeSummary(res.summary || {}, res.generatedAt);
      if (Object.prototype.hasOwnProperty.call(res, 'flags')) {
        renderFlagsTable(res.flags);
      } else {
        loadFlags();
      }
      if (Object.prototype.hasOwnProperty.call(res, 'teamRating')) {
        renderTeamLine(res.teamRating);
      } else {
        loadTeamRatings(true);
      }
    })
    .withFailureHandler(err => {
      console.error('Home summary error:', err);
      showHomeSummaryError('Failed to load dashboard.');
      loadFlags();
      loadTeamRatings(true);
    })
    .getHomeDashboard({ force: !!force });
}

function showHomeSummaryError(message) {
  const text = escapeHtml(message || 'Unavailable.');
  ['homeSessionBody','homeUpcomingList'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.classList.add('muted');
      el.innerHTML = `<div class="muted">${text}</div>`;
    }
  });
  const stamp = document.getElementById('homeSummaryTimestamp');
  if (stamp) stamp.textContent = '';
}

function renderHomeSummary(summary, generatedAt) {
  summary = summary || {};
  renderHomeSession(summary.latestSession || null, generatedAt);
  renderHomeUpcoming(summary.upcoming || []);
}

function renderHomeSession(session, generatedAt) {
  const host = document.getElementById('homeSessionBody');
  if (!host) return;
  if (!session) {
    host.classList.add('muted');
    host.innerHTML = '<div class="muted">No session ratings yet.</div>';
    const stampEl = document.getElementById('homeSummaryTimestamp');
    if (stampEl) stampEl.textContent = '';
    return;
  }

  host.classList.remove('muted');

  const formatDate = (iso) => {
    if (!iso) return '';
    const parts = iso.split('-');
    if (parts.length !== 3) return escapeHtml(iso);
    const date = new Date(`${iso}T00:00:00`);
    if (isNaN(date.getTime())) return escapeHtml(iso);
    return escapeHtml(date.toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' }));
  };

  const safeSession = escapeHtml(session.session || 'Session');
  const dateLabel = session.dateISO
    ? formatDate(session.dateISO)
    : session.displayDate
      ? escapeHtml(session.displayDate)
      : '';
  const coachRaw = session.coach || '';
  let coachLabel = '';
  if (coachRaw) {
    if (coachRaw.toLowerCase() === 'multiple coaches') {
      coachLabel = escapeHtml(coachRaw);
    } else {
      coachLabel = `Coach ${escapeHtml(coachRaw)}`;
    }
  }

  const avgScore = session.avgScore != null ? Number(session.avgScore).toFixed(2) : '—';
  const prevAvg = session.prevAvg != null ? Number(session.prevAvg).toFixed(2) : null;
  const delta = (session.deltaPrev != null && isFinite(session.deltaPrev)) ? Number(session.deltaPrev).toFixed(2) : null;
  const deltaValue = delta != null
    ? `${session.deltaPrev > 0 ? '+' : ''}${delta}`
    : '—';

  const playerCount = session.playerCount != null
    ? Number(session.playerCount)
    : Array.isArray(session.playerSummaries) ? session.playerSummaries.length : Array.isArray(session.players) ? session.players.length : 0;
  const noteCount = session.noteCount != null
    ? Number(session.noteCount)
    : Array.isArray(session.notes) ? session.notes.length : 0;

  const coachRows = Array.isArray(session.coaches) && session.coaches.length
    ? session.coaches.slice(0, 6).map(c => {
        const avg = c.avg != null ? Number(c.avg).toFixed(2) : '—';
        const cnt = c.count != null ? Number(c.count) : 0;
        return `<tr><td>${escapeHtml(c.coach || '—')}</td><td>${avg}</td><td>${cnt}</td></tr>`;
      }).join('')
    : `<tr><td colspan="3" class="home-session-empty">No coach ratings found.</td></tr>`;

  host.innerHTML = `
    <div class="home-session-summary">
      <div class="home-session-meta">
        <div class="home-session-title">${safeSession}</div>
        <div class="home-session-sub">${[dateLabel, coachLabel].filter(Boolean).join(' • ')}</div>
      </div>
      <div class="home-session-stats">
        <div class="home-session-stat">
          <div class="label">AVG RATING</div>
          <div class="value">${avgScore}</div>
          ${prevAvg != null ? `<div class="home-session-sub">Prev ${prevAvg}</div>` : ''}
        </div>
        <div class="home-session-stat">
          <div class="label">CHANGE VS LAST</div>
          <div class="value">${deltaValue}</div>
        </div>
        <div class="home-session-stat">
          <div class="label">PLAYERS RATED</div>
          <div class="value">${playerCount}</div>
        </div>
        <div class="home-session-stat">
          <div class="label">NOTES LOGGED</div>
          <div class="value">${noteCount}</div>
        </div>
      </div>
      <div class="home-session-coach-table">
        <div class="home-session-sub" style="margin-bottom:8px;">Coach averages</div>
        <table>
          <thead>
            <tr><th>Coach</th><th>AVG</th><th>Players</th></tr>
          </thead>
          <tbody>${coachRows}</tbody>
        </table>
      </div>
    </div>
  `;

  const stamp = document.getElementById('homeSummaryTimestamp');
  if (stamp) {
    if (generatedAt) {
      const ts = Date.parse(generatedAt);
      if (!isNaN(ts)) {
        const dt = new Date(ts);
        const dateStr = dt.toLocaleDateString('en-GB', { day:'2-digit', month:'short' });
        const timeStr = dt.toLocaleTimeString('en-GB', { hour:'2-digit', minute:'2-digit' });
        stamp.textContent = `Updated ${dateStr} at ${timeStr}`;
      } else {
        stamp.textContent = '';
      }
    } else {
      stamp.textContent = '';
    }
  }
}

function renderHomeUpcoming(games) {
  const host = document.getElementById('homeUpcomingList');
  if (!host) return;
  if (!games.length) {
    host.classList.add('muted');
    host.innerHTML = '<div class="muted">No upcoming fixtures.</div>';
    return;
  }

  host.classList.remove('muted');

  const items = games.map(g => {
    const parts = [];
    if (g.dateStr || g.timeStr) parts.push(`${escapeHtml(g.dateStr || '')} ${escapeHtml(g.timeStr || '')}`.trim());
    if (g.homeAway === 'A') parts.push('Away'); else if (g.homeAway === 'H') parts.push('Home');
    if (g.competition) parts.push(g.competition);
    const meta = parts.filter(Boolean).join(' • ');
    const record = g.record ? `<div class="muted" style="font-size:12px;">Record: ${escapeHtml(g.record)}</div>` : '';
    return `<div class="upcoming-item"><strong>${escapeHtml(g.opponent || 'Opponent')}</strong><div class="muted" style="font-size:12px; margin-top:4px;">${escapeHtml(meta)}</div>${record}</div>`;
  }).join('');
  host.innerHTML = items;
}









    </script>





 
   











  </body>
</html>
